# task_executor.py ã®å…ˆé ­ã«ä»¥ä¸‹ã‚’è¿½åŠ 

# === æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã®ä¸‹ã«è¿½åŠ  ===
from task_executor_content import ContentTaskExecutor
from task_executor_ma import MATaskExecutor

# === TaskExecutor ã‚¯ãƒ©ã‚¹ã® __init__ ãƒ¡ã‚½ãƒƒãƒ‰å†…ã«è¿½åŠ  ===
# ï¼ˆæ—¢å­˜ã® _initialize_agents() ã®å¾Œã«è¿½åŠ ï¼‰

def __init__(self, sheets_manager: GoogleSheetsManager, browser_controller=None, max_iterations: int = None):
    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è‡ªå‹•åˆæœŸåŒ–
    self._initialize_agents()
    
    # === ã“ã“ã‹ã‚‰è¿½åŠ  ===
    # è¨˜äº‹ç”Ÿæˆå°‚ç”¨ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼
    self.content_executor = ContentTaskExecutor(self.agents)
    
    # M&Aå°‚ç”¨ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼
    self.ma_executor = MATaskExecutor(self.agents)
    
    logger.info("åˆ†é›¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†: ContentTaskExecutor, MATaskExecutor")
    # === ã“ã“ã¾ã§è¿½åŠ  ===


# === _execute_writer_task ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç½®ãæ›ãˆ ===
# æ—¢å­˜ã® _execute_writer_task ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆã‚‹

async def _execute_writer_task(self, task: Dict, role: str) -> Dict:
    """è¨€èªåˆ¥ãƒ©ã‚¤ã‚¿ãƒ¼ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œï¼ˆContentTaskExecutorã«å§”è­²ï¼‰"""
    return await self.content_executor.execute_writer_task(task, role)


# === perform_review_and_add_tasks ãƒ¡ã‚½ãƒƒãƒ‰å†…ã‚’ä¿®æ­£ ===
# display_suggested_tasks ã®å‘¼ã³å‡ºã—ã‚’ä»¥ä¸‹ã«å¤‰æ›´

async def perform_review_and_add_tasks(self, task: Dict, result: Dict):
    """ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨è¿½åŠ ã‚¿ã‚¹ã‚¯ç”Ÿæˆ"""
    try:
        # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
        
        if suggested_tasks:
            print(f"\nææ¡ˆã‚¿ã‚¹ã‚¯: {len(suggested_tasks)}ä»¶")
            
            # æ‹¡å¼µã•ã‚ŒãŸé¸æŠè‚¢ã‚’æä¾›
            while True:
                choice = input("\nææ¡ˆã‚¿ã‚¹ã‚¯ã‚’ã©ã†ã—ã¾ã™ã‹?\n"
                             "(y)è¿½åŠ  / (n)ã‚¹ã‚­ãƒƒãƒ— / (v)ç¢ºèª / (e)ç·¨é›† / (m)æ‰‹å‹•å…¥åŠ› / (c)ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ").lower()
                
                if choice == 'y':
                    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
                    break
                
                elif choice == 'n':
                    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
                    break
                
                elif choice == 'v':
                    # === ã“ã®è¡Œã‚’å¤‰æ›´ ===
                    self.content_executor.display_suggested_tasks(suggested_tasks)
                    continue
                
                elif choice == 'e':
                    # === ã“ã®è¡Œã‚’å¤‰æ›´ ===
                    edited_tasks = await self.content_executor.edit_suggested_tasks(suggested_tasks)
                    if edited_tasks:
                        # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
                    continue
                
                elif choice == 'm':
                    # === ã“ã®è¡Œã‚’å¤‰æ›´ ===
                    manual_tasks = await self.content_executor.create_manual_tasks()
                    if manual_tasks:
                        # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
                    continue
                
                elif choice == 'c':
                    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
                    break
                
                else:
                    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
                    continue
        
        # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼ˆæ®‹ã‚Šã®éƒ¨åˆ†ï¼‰...
    
    except Exception as e:
        ErrorHandler.log_error(e, "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã‚¿ã‚¹ã‚¯è¿½åŠ ")


# === _execute_wordpress_task ãƒ¡ã‚½ãƒƒãƒ‰å†…ã«è¿½åŠ  ===
# M&Aé–¢é€£ã‚¿ã‚¹ã‚¯ã®åˆ¤å®šã‚’è¿½åŠ 

async def _execute_wordpress_task(self, task: Dict) -> Dict:
    """WordPressã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
    logger.info("â”Œ" + "â”€"*58 + "â”")
    logger.info("â”‚ ğŸŒ WordPress AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œä¸­")
    logger.info("â”œ" + "â”€"*58 + "â”¤")
    logger.info(f"â”‚ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: {task.get('post_action', 'N/A')}")
    logger.info(f"â”‚ è¨€èª: {task.get('language', 'N/A')}")
    logger.info(f"â”‚ Polylang: {task.get('polylang_lang', 'N/A')}")
    logger.info("â””" + "â”€"*58 + "â”˜")
    
    try:
        # === ã“ã“ã‹ã‚‰è¿½åŠ : M&Aé–¢é€£ã‚¿ã‚¹ã‚¯ã®åˆ¤å®š ===
        description = task['description'].lower()
        
        # M&Aé–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        ma_keywords = [
            'custom post type', 'ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—',
            'acf', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰',
            'taxonomy', 'ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼',
            'm&aæ¡ˆä»¶', 'ma_case',
            'ä¼æ¥­æ¤œç´¢', 'æ¡ˆä»¶ç®¡ç†'
        ]
        
        is_ma_task = any(keyword in description for keyword in ma_keywords)
        
        if is_ma_task:
            logger.info("ğŸ“Š M&Aé–¢é€£ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å®Ÿè¡Œ")
            return await self.ma_executor.execute_ma_task(task)
        # === ã“ã“ã¾ã§è¿½åŠ  ===
        
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
        if 'post_action' not in task:
            task['post_action'] = 'edit'
        if 'polylang_lang' not in task:
            task['polylang_lang'] = 'ja'
        
        # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼ˆæ®‹ã‚Šã®éƒ¨åˆ†ï¼‰...
        
    except Exception as e:
        ErrorHandler.log_error(e, "WordPressã‚¿ã‚¹ã‚¯å®Ÿè¡Œ")
        logger.error(f"âŒ WordPress AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ä¾‹å¤–ç™ºç”Ÿ - {str(e)}")
        return {
            'success': False,
            'error': f'WordPressã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {str(e)}'
        }


# === æ—¢å­˜ã® _display_suggested_tasks, _edit_suggested_tasks, _create_manual_tasks ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‰Šé™¤ ===
# ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ task_executor_content.py ã«ç§»å‹•ã—ãŸãŸã‚ã€
# task_executor.py ã‹ã‚‰ã¯å‰Šé™¤ã—ã¦OK