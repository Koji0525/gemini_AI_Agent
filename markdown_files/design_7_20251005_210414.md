# 設計書: 機密情報（価格など）の表示・非表示、ログイン・非ログインユーザーのアクセス制御に関するセキュリティ仕様定義書作成

タスクID: 7
作成日時: 2025-10-05T21:04:14.970562

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトにおける機密情報の表示・非表示およびアクセス制御に関する具体的なセキュリティ仕様を定義します。これはポータルサイトの信頼性を担保する上で最優先すべき事項です。

タスク概要

目的

M&A案件情報のうち、希望価格や詳細な財務情報などの機密性の高いデータについて、ログイン状態やユーザー権限に基づいた厳格な表示・非表示のロジックを定義します。これにより、情報漏洩リスクを最小限に抑え、必要なユーザーにのみ情報が開示される状態を実現します。

スコープ

機密情報の特定と、公開レベル（一般公開、ログインユーザー、特定権限ユーザー）の定義。

ユーザー認証状態に基づくコンテンツ表示制御ロジック。

API/データベースレベルでのデータ保護とアクセス制限。

WordPress環境下での具体的な実装技術の選定。

設計内容

1. 機密情報の分類とアクセスレベル定義

M&A案件の表示項目を以下の3つのレベルに分類し、アクセス制御の基本方針を定めます。

情報レベル	項目例	アクセス権限	実装場所	公開時の表示
一般公開	案件名、業種、所在地、M&Aスキーム、進捗ステータス（公開中など）	全てのユーザー	フロントエンド	全て表示
ログインユーザー限定	詳細な企業概要、譲渡理由	ログイン済みの全ユーザー (read capability)	フロントエンド/テーマ	ログイン必須のエリアで表示
機密情報（厳格制御）	希望売却/買収価格の具体的な金額、直近3期売上/利益	特定のカスタムロールを持つユーザーのみ（例: ma_reviewer、Partner）	バックエンド（WP_Query/API）	「非公開」「価格レンジ」と表示
Google スプレッドシートにエクスポート

2. アクセス制御ロジックの設計

2.1. 機密情報（価格など）の表示制御

価格 (price_amountカスタムフィールド) などの具体的な機密情報は、以下のロジックに基づきフロントエンドでの表示を厳格に制御します。

ユーザー状態	表示ロジック	実装技術
未ログイン (Guest)	価格データは表示せず、代わりにカスタムフィールド（例: price_range）に格納されたレンジ情報または「非公開」という文字列を表示する。	WordPressテーマのテンプレートファイル内でis_user_logged_in()による条件分岐。
ログイン済み (通常ユーザー)	基本的に未ログインユーザーと同じ制御。特定の権限が付与されていない限り、具体的な金額は表示しない。	current_user_can('view_sensitive_data')などのカスタムケイパビリティで制御。
特定権限ユーザー	具体的な金額を表示する。	権限確認後、get_post_meta('ma_case', 'price_amount', true)で生のデータを取得し表示。
Google スプレッドシートにエクスポート

2.2. バックエンド（API/クエリ）レベルでの制御

機密情報保護のため、フロントエンドでの非表示だけでなく、データ取得の段階で制御をかけます。

WP_Query制御: 案件一覧表示や検索結果表示時、WP_Queryフック（例: posts_fields）を使い、特定権限を持たないユーザーのクエリ結果から、価格などのカスタムフィールドの値を隠蔽またはマスキングすることを検討します。

APIエンドポイント: カスタムREST APIエンドポイントを構築する場合、必ずリクエスト受信時に**current_user_can()**で権限チェックを行い、権限がない場合は機密情報を含まないレスポンスを返すか、エラーコードを返します。

3. データ保護とセキュリティ対策

対策項目	詳細設計	実装場所
機密情報の暗号化	データベースに保存する直前に、希望価格や詳細な財務情報などの機密性の高いカスタムフィールド値を、対称鍵暗号方式（例: AES-256）で暗号化して保存する。	WordPressプラグインまたはテーマのフック（save_post、update_post_meta）にカスタムロジックを実装。
通信の暗号化	全通信において**TLS/SSL (HTTPS)**を必須とする。サイト全体でHSTS (HTTP Strict Transport Security) ヘッダーを有効化する。	サーバー設定（Apache/Nginx）およびWordPress設定。
認証の強化	提携パートナーアカウントには、**多要素認証（MFA）**を強制または推奨する。不正アクセスによるアカウント乗っ取りリスクを低減する。	専用のセキュリティプラグイン（例: iThemes Security, Two Factor）を利用。
レートリミット	検索APIやログインエンドポイントへの連続アクセスに対してレートリミットを導入し、ブルートフォースアタックやDDoS攻撃を緩和する。	サーバー設定（Nginx/Apache）またはCDN（Cloudflareなど）レベル。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
アクセス制御	WordPress Custom Capabilities + current_user_can()	WordPressネイティブの権限制御機構を利用することで、カスタムロール（例: Partner）に対する細かな権限設定を可能にする。
データ制御ロジック	PHP Action/Filter Hooks (例: pre_get_posts)	データの取得時や表示時に介入し、ユーザーの権限に基づいてデータをフィルタリングまたはマスキングするロジックを確実に追加するため。
暗号化	PHPのOpenSSL拡張	データベースに保存する機密情報について、堅牢なAES-256暗号化処理を実装するため。
認証強化	MFAプラグイン	提携パートナーアカウントのセキュリティを迅速かつ効果的に高めるため。
Google スプレッドシートにエクスポート

実装における注意点

二重の非表示対策: フロントエンド（テーマ）での表示制御は容易にバイパスされる可能性があるため、必ず**バックエンド（データ取得時）**での権限チェックとデータマスキングを主とする。

暗号鍵管理: データの暗号化に用いる鍵（シークレットキー）は、WordPressデータベース外の安全な場所（例: サーバー環境変数、WP設定ファイルの保護されたエリア）に厳重に管理し、ソースコードに直接記述しないこと。

キャッシュの扱い: WordPressのオブジェクトキャッシュやページキャッシュを利用する場合、ログインユーザーごとに表示内容が異なるため、機密情報を含むページはユーザーごとにキャッシュを分離する（例: WP Rocketのユーザーキャッシュ機能）か、キャッシュを完全に無効化する必要がある。

次のステップ

データ暗号化モジュール詳細設計: どのカスタムフィールドを、どの鍵とアルゴリズムで暗号化し、いつ復号化するか（読み取り時、管理画面表示時）の具体的なロジックとフックポイントを定義する。

カスタムケイパビリティ定義: view_sensitive_dataなど、アクセス制御に用いるカスタムケイパビリティの一覧と、それらをどのカスタムロールに付与するかを確定させる。