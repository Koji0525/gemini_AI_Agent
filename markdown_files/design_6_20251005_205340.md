# 設計書: 提携パートナー管理機能の具体的な仕様定義書作成（WordPressユーザーロール設計、案件登録/編集フォーム、ステータス管理、アクセス制御（自身が登録した案件のみ）の実現方法）

タスクID: 6
作成日時: 2025-10-05T20:53:40.055640

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトの提携パートナー管理機能の具体的な実装仕様を定義します。これはセキュリティとアクセス制御が最優先される重要な領域です。

タスク概要

目的

M&A提携パートナーが自身の案件を安全かつ効率的に管理・公開するための具体的な機能仕様を定義します。特に、WordPressのユーザー管理機能を活用した厳格なアクセス制御（RBAC）と、案件の公開・非公開を制御するワークフローの実現方法に焦点を当てます。

スコープ

提携パートナー向けのWordPressユーザーロールと権限の設計。

案件の登録・編集フォームの仕様と入力項目のマッピング。

案件ステータス（進捗状況）管理機能の実現方法。

提携パートナーが自身が登録した案件のみを閲覧・編集・管理できるアクセス制御の実現ロジック。

設計内容

1. WordPressユーザーロールと権限設計

既存のWordPressロールに加え、以下のカスタムロールを定義し、厳格な**RBAC (Role-Based Access Control)**を適用します。

ロール名	権限（Capability）	備考
Partner (提携パートナー)	read, edit_posts (カスタム投稿タイプ ma_case のみ), upload_files	最重要: edit_others_posts は許可しない。自身が作成した案件のみ編集可能とする。
Partner_Admin (パートナー管理者)	Partnerの全権限 + 他のパートナーの案件閲覧/編集を限定的に許可（組織内の上位ロール想定）。初期フェーズでは非推奨。	
System_Admin (システム管理者)	administrator権限（全案件の閲覧・編集、パートナーアカウント発行）	全ての案件とパートナーアカウントを管理する。
Google スプレッドシートにエクスポート

アカウント発行:
システム管理者が個別にパートナーアカウントを発行し、厳格な認証（多要素認証の導入を将来的に推奨）を必須とします。

2. 案件登録・編集フォーム仕様

カスタム投稿タイプma_caseの案件登録・編集には、**ACF (Advanced Custom Fields)**または同等のカスタムフィールドプラグインを利用した専用フォームを実装します。

UI要素	目的	データ格納先	備考
案件基本情報	必須情報入力（案件名、スキーム、価格など）	post_title, カスタムフィールド	価格など機密情報は入力時も厳重に管理。
財務/詳細情報	売り手企業（譲渡企業）情報（売上、利益など）	カスタムフィールド（JSONBまたは繰り返しフィールド）	非公開情報。入力後に自動的に非公開フラグを立てる。
進捗ステータス	ドロップダウン選択（公開中、商談中、成約済など）	カスタムタクソノミー (status)	パートナーが変更可能。**「成約済」**に変更した場合は、サイトから自動的に非表示とするロジックを実装。
案件公開ボタン	案件を公開キューに送る	post_statusをpending (レビュー待ち) に設定	ワークフロー制御: パートナーが登録後、サイトに公開される前にシステム管理者の承認（publish権限付与）を必須とする。
Google スプレッドシートにエクスポート

3. アクセス制御と「自身が登録した案件のみ」の実現ロジック

これが最も重要なセキュリティ要件です。WordPressの標準機能では不十分なため、アクションフックを用いてクエリを制御します。

管理画面でのアクセス制限:

提携パートナー (Partnerロール) がWordPress管理画面の案件一覧 (/wp-admin/edit.php?post_type=ma_case) にアクセスした際、**pre_get_posts**アクションフックを使用します。

フック内で現在のユーザーIDを取得し、クエリのauthorパラメータにそのIDを設定します。

これにより、パートナーは自身が投稿（post_authorが一致）した案件のみを一覧で確認・編集できるようになります。

PHP
// 例: pre_get_posts を用いたアクセス制御ロジック（テーマまたはプラグインに実装）
function restrict_partner_access( $query ) {
    if ( ! is_admin() || ! $query->is_main_query() ) {
        return;
    }

    $user = wp_get_current_user();
    if ( in_array( 'partner', $user->roles ) && $query->get( 'post_type' ) == 'ma_case' ) {
        // 他人の投稿を編集する権限を持っていないことを確認
        if ( ! current_user_can( 'edit_others_ma_cases' ) ) {
            $query->set( 'author', $user->ID );
        }
    }
}
add_action( 'pre_get_posts', 'restrict_partner_access' );


案件編集時の制限:

編集画面 (/wp-admin/post.php?post=XXX&action=edit) へのアクセス時、ユーザーがその案件の作成者であるかを確認するチェックを実装します。

異なる案件IDを直接URLで指定された場合でも、権限がない場合は即座にアクセスを拒否（リダイレクトまたはエラー表示）します。

4. 案件ステータスとワークフロー管理

ステータス（statusタクソノミー）	状態 (post_status)	パートナー操作	システム動作
下書き	draft	自由に編集可	サイト非表示
承認待ち	pending	編集可、再申請でステータス維持	サイト非表示。システム管理者に通知。
公開中	publish	編集後、再度承認待ちに遷移	検索結果に表示。
商談中	publish	編集可、再度承認待ちに遷移	検索結果に表示（ステータス表示は「商談中」）。
成約済	private または専用カスタムステータス	編集可	サイトから自動的に非表示とする。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
ベースCMS	WordPress	要件に基づいたプラットフォーム。
カスタム投稿/フィールド	ACF (Advanced Custom Fields) Pro	複雑な入力フォームや繰り返しフィールド（財務情報など）を効率的に設計するため。Pro版はブロックやオプションページ機能も利用可能。
ユーザーロール管理	User Role Editor (URE) または Members Plugin	標準のWordPressロール・権限を細かくカスタマイズし、edit_others_postsなどの権限をカスタム投稿タイプma_caseに対して個別に制御するため。
案件一覧制御	WordPress Action Hooks (pre_get_posts)	パートナーが自身の投稿のみを管理画面で閲覧できるように、コアなクエリレベルでアクセス制御を厳格に実現するため。
Google スプレッドシートにエクスポート

実装における注意点

二重のアクセスチェック: 管理画面とフロントエンド（もしAPI経由でアクセスする場合）の両方で、**post_authorとcurrent_user_can()**による権限チェックを徹底すること。特にpre_get_postsによるクエリ制御はセキュリティの根幹です。

セキュリティ対策: パートナーからのフォーム入力データに対して、サニタイズとバリデーションを徹底し、SQLインジェクションやXSSのリスクを排除すること。

機密情報の取り扱い: 財務情報などの機密性の高いフィールドは、データベースに格納する前に暗号化を検討し、管理画面でもPartnerロールには表示を制限するなどの対策を講じること。

ワークフロー通知: 案件が「承認待ち」になった際、システム管理者へメールまたは管理画面通知を行う通知システムの実装を忘れないこと。

次のステップ