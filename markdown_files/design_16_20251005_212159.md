# 設計書: 提携パートナー管理機能（案件登録・編集、ステータス管理、閲覧履歴）の詳細仕様を要件定義書の第3章に記述する。

タスクID: 16
作成日時: 2025-10-05T21:21:59.817271

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトの提携パートナー管理機能の詳細仕様を定義します。この機能は、案件データのライフサイクル管理と、厳格なアクセス制御（RBAC）の基盤となります。

タスク概要

目的

提携パートナー（案件の提供者）が案件を安全かつ効率的に登録・管理し、管理者との間で承認ワークフローを実現するための具体的な機能仕様を定義します。特に、自身が登録した案件のみを操作できるアクセス制御（RBAC）と、案件のステータス管理、および案件閲覧履歴のトラッキングロジックを確立します。

スコープ

提携パートナー専用のユーザーロールと権限の定義。

案件登録・編集時のアクセス制御（RBAC）ロジック。

案件のステータス遷移（ワークフロー）の定義。

案件閲覧履歴のトラッキングとデータ格納方法。

設計内容

1. ユーザーロールとアクセス制御（RBAC）

提携パートナー専用のカスタムロールを定義し、WordPressのネイティブなpost_author機能を利用して、投稿者ベースのアクセス制御を実現します。

ロール名	権限 (ケイパビリティ)	備考
ma_partner	read, upload_files, view_sensitive_data	案件の登録・編集、機密情報の閲覧が可能。
	edit_ma_cases, edit_published_ma_cases	ma_case CPTの編集・公開権限。
	edit_others_ma_cases は付与しない	自身が登録した案件のみの編集を強制するための最重要設定。
Google スプレッドシートにエクスポート

アクセス制御ロジック（最重要）

閲覧・編集の制限: ma_partner ロールは、案件一覧画面および編集画面において、post_author が自身のユーザーIDと一致する案件のみを閲覧・操作可能とします。

技術的な実現: WordPressの**pre_get_posts フック**を利用し、管理画面の案件一覧表示や編集クエリが実行される直前に、現在のユーザーIDに基づくフィルター（'author' => get_current_user_id()）を強制的に追加します。

2. 案件の登録・編集とステータス管理（ワークフロー）

案件は以下のステータスを遷移し、パートナーと管理者の共同作業で管理されます。

ステータス（WP）	ロール	アクション	遷移先ステータス
pending (承認待ち)	ma_partner	新規登録 / 編集完了	→ pending（新規/再承認待ち）
publish (公開中)	administrator/ma_reviewer	管理者による承認	→ publish
pending	administrator/ma_reviewer	管理者による却下/修正指示	→ draft / pending
closed (カスタム)	administrator	成約/取り下げ	→ closed
Google スプレッドシートにエクスポート

パートナーの挙動: パートナーが新規登録または編集を保存すると、ステータスは自動的に pending に設定され、管理者による承認を待ちます。

成約済み案件の非表示: closed ステータスは、フロントエンドの検索結果および一覧から自動的に除外されます。

3. 案件閲覧履歴機能のトラッキング

提携パートナーがどの案件をいつ閲覧したかをトラッキングし、利用状況分析の基礎データとします。

データ構造設計

WordPressのカスタムテーブルまたは標準のwp_usermetaに格納することを想定します。（スケーラビリティを考慮し、カスタムテーブルを推奨）

テーブル名	wp_ma_view_log	備考
log_id	BIGINT (Primary Key)	ログを一意に識別
user_id	BIGINT (Index)	閲覧した提携パートナーのID
post_id	BIGINT (Index)	閲覧された案件（ma_case）のID
view_timestamp	DATETIME (Index)	閲覧日時（NOW()）
Google スプレッドシートにエクスポート

トラッキングロジック

フック: single_template アクションまたは the_post アクションの直後にカスタム関数をフック。

条件判定:

閲覧ユーザーが**ma_partner ロール**であること。

閲覧対象が ma_case CPTであること。

過去 N 秒間（例: 60秒）以内に同じ案件を閲覧していないこと（重複ログの抑制）。

データ保存: 条件を満たす場合、user_id, post_id, view_timestamp を wp_ma_view_log テーブルに挿入します。

技術選定

分野	技術	選定理由
ロール管理	User Role Editor Plugin + Custom Code	カスタムロールと、RBACの核となるedit_own_ma_caseなどのカスタムケイパビリティを容易に定義するため。
アクセス制御	PHP pre_get_posts フィルター	管理画面およびフロントエンドのデータ取得クエリをフックし、post_authorによる厳格なアクセス制限を低オーバーヘッドで実現するため。
ワークフロー	post_status + wp_insert_post_data フィルター	標準の投稿ステータス（pending, publish）とカスタムステータス（closed）を利用し、状態遷移をカスタムコードで制御するため。
閲覧履歴	カスタムデータベーステーブル	大量のログデータ（数万〜数十万レコード）を効率的に格納・検索し、wp_postmetaテーブルの肥大化とパフォーマンス低下を避けるため。
Google スプレッドシートにエクスポート

実装における注意点

RBACの二重チェック: pre_get_postsによる一覧表示のフィルタリングだけでなく、案件編集画面へのアクセス時には、map_meta_cap フィルターを利用してユーザーの編集権限を再度チェックし、URL直接入力による不正アクセスを完全にブロックすること。

データ暗号化と整合性: 案件編集フォームにおいて、price_amountなどの暗号化対象フィールドは、フォーム表示時に正しく複合化され、保存時に再度暗号化されるロジックが、パートナーの操作によって破綻しないよう入念にテストすること。

閲覧ログのクレンジング: wp_ma_view_logテーブルは肥大化しやすいため、データ保持期間（例：1年間）を設定し、定期的に古いログを削除するメンテナンス（CRONジョブ）の実装を計画すること。

次のステップ

データ暗号化モジュール詳細設計: これまで最重要課題としてきた機密情報保護のため、暗号化・複合化ロジック、鍵管理、およびフックポイントの詳細を定義する。この設計が完了すれば、セキュリティ基盤が整う。

UI/UX画面設計（管理画面含む）: 提携パートナーが利用する案件登録・編集フォーム、案件一覧、および管理者側での承認画面の具体的なワイヤーフレームとデザイン要素を確定させる。