# 設計書: 公開情報と非公開情報（価格など）のアクセス制御（ログイン/非ログイン、権限）に関する具体的な表示・非表示ロジックを要件定義書に記述する。

タスクID: 15
作成日時: 2025-10-05T21:17:34.511207

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトにおける公開情報と非公開情報（機密情報）のアクセス制御ロジックを詳細に定義します。この設計は、情報漏洩を防ぐためのセキュリティの根幹をなします。

タスク概要

目的

M&A案件データのうち、価格や財務情報などの機密性の高いデータについて、ユーザーの認証状態（ログイン済み/未ログイン）および権限（カスタムロール）に基づいた厳格な表示・非表示のロジックを確立します。これにより、必要なユーザーにのみ、必要な粒度の情報が開示される状態を実装可能にします。

スコープ

情報の公開レベル（アクセスレベル）の再定義と確認。

認証状態とカスタム権限に基づくコンテンツ表示制御フローの設計。

フロントエンドだけでなく、バックエンド（データ取得層）での制御ロジックの定義。

設計内容

1. 情報の分類とアクセスレベルの再定義

案件の表示項目を以下の3つのレベルに分類し、制御ロジックの基盤とします。

情報レベル	項目例	アクセス権限	格納先	表示制御の強度
レベル 1: 一般公開情報	案件名、業種、所在地、案件概要（非機密部分）	全てのユーザー (ゲスト含む)	CPT (post_titleなど) / CT	フロントエンドでそのまま表示
レベル 2: ログインユーザー限定情報	詳細な企業概要、譲渡理由の全文	ログイン済みの全ユーザー (read権限)	CPT (post_contentなど)	フロントエンドでの認証チェック
レベル 3: 機密情報（厳格制御）	希望価格の具体的な金額 (price_amount)、直近の財務データ	特定権限を持つカスタムロールのみ（例: ma_partner, ma_reviewer）	CF（暗号化対象）	バックエンド（データ取得時）での厳格な権限チェック
Google スプレッドシートにエクスポート

2. アクセス制御ロジックの設計

機密情報（レベル 3）の具体的な金額データを保護するため、「表示制御」と「データ取得制御」の二重のロジックを適用します。

2.1. フロントエンド（表示）制御ロジック

これはユーザーへのフィードバックとUI/UXを制御する層です。

ユーザー状態	アクセスレベル	処理内容	表示結果
未ログイン (ゲスト)	レベル 1 のみ	機密データは取得せず、代替データ（price_range_text）を表示。	「非公開」「価格レンジ」と表示、またはログイン誘導
ログイン済み (通常ユーザー)	レベル 1, 2 のみ	機密データは取得せず、代替データ（price_range_text）を表示。	「非公開」「価格レンジ」と表示
特定権限ユーザー	レベル 1, 2, 3 全て	バックエンドから取得した生の機密データを表示。	具体的な金額（例: 5,000万円）を表示
Google スプレッドシートにエクスポート

実装方法: WordPressテーマのテンプレートファイル内で、if ( current_user_can('view_sensitive_data') ) などのカスタムケイパビリティ（権限）に基づく条件分岐を実装します。

2.2. バックエンド（データ取得）制御ロジック

これはデータ漏洩を防ぐための主要なセキュリティ層です。機密情報（例: price_amount）は、権限のないユーザーに対して、データベースから取得する段階でマスキングまたは取得をブロックします。

シナリオ	実装フック/技術	制御ロジック
案件一覧/検索結果表示	posts_fields フィルター (WP_Query)	権限チェックを行い、権限のないユーザーの場合、price_amountフィールドの値を「NULL」または「0」などの代替値に置き換えて返す。
REST APIアクセス	rest_prepare_{post_type} フィルター	REST APIエンドポイントへのリクエスト受信時に権限をチェック。権限がない場合は、機密情報フィールドをレスポンスJSONから削除するか、マスキングした値を返す。
データベース暗号化	get_post_meta フィルター	データベースからprice_amountを取得する際、権限を持つユーザーに対してのみ複合化ロジックを適用する。権限のないユーザーの取得リクエストは複合化しない。
Google スプレッドシートにエクスポート

3. カスタム権限（ケイパビリティ）の定義

権限名（ケイパビリティ）	適用ロール	備考
view_sensitive_data	ma_partner, ma_reviewer	レベル 3の機密情報にアクセスするために必須の最小権限。
edit_own_ma_case	ma_partner	自身が登録した案件のみを編集・管理するために使用（RBACの基盤）。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
権限管理	WordPress Custom Capabilities + User Role Editor Plugin	WordPressネイティブの認証・認可機構を利用し、カスタムケイパビリティ(view_sensitive_data)で制御を一元化するため。
データ制御	PHP Filter Hooks (特に posts_fields および get_post_metadata)	データがDBから取得され、フロントエンドに渡される前の最も安全な段階でデータを操作・マスキングするため。
統合制御	条件付き ACF Fields	管理画面での機密情報入力フィールドに対し、特定ロールのみが表示・編集できるようなACFの機能を利用し、管理画面のセキュリティを強化するため。
Google スプレッドシートにエクスポート

実装における注意点

キャッシュの無効化/分離: アクセス制御ロジックはユーザーの権限に依存するため、機密情報を含むページやAPIレスポンスについて、ユーザーごとにキャッシュを分離するか、特定権限を持つユーザーに対するページキャッシュを完全に無効化すること。

サニタイズの徹底: 機密情報の取得ロジック（複合化処理）では、必ずcurrent_user_can()による二重チェックを行い、権限のないリクエストが誤って生のデータにアクセスしないよう検証を厳しく行うこと。

URL直接アクセス対策: 機密情報の直接URL（例: 添付ファイル、画像など）が存在する場合は、必ず.htaccessやPHPによる認証チェックを挟み、ログイン・権限のないアクセスをブロックすること。

次のステップ

提携パートナー管理機能の具体的な仕様定義: このアクセス制御の前提となる、提携パートナーの登録、ロール付与、および自身が登録した案件のみの閲覧・編集に関するRBACロジックを詳細に設計する。

データ暗号化モジュール詳細設計: 機密情報（価格など）の暗号化・複合化ロジック、鍵管理、およびフックポイント（update_post_metaなど）の詳細を定義する。

UI/UX画面設計: ログインが必要なコンテンツへのアクセス時や権限がない場合に表示する適切な誘導メッセージのワイヤーフレームを設計する。