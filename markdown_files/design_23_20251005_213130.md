# 設計書: 提携パートナー向け案件閲覧履歴機能の設計書作成。トラッキング対象、データ格納方法（カスタムDBテーブルまたはカスタムポストメタ）、匿名化されたユーザーIDの定義ロジックを含む。

タスクID: 23
作成日時: 2025-10-05T21:31:30.486378

---

はい、経験豊富なシステム設計者として、提携パートナー向け案件閲覧履歴機能の詳細設計を行います。この機能は、サイトの利用状況を分析し、提携パートナーの活動を把握するために重要ですが、個人情報保護とパフォーマンスへの配慮が不可欠です。

タスク概要

目的

提携パートナーがM&A案件を閲覧した履歴を、効率的かつ安全にトラッキング・格納する機能仕様を定義します。特に、大量のログデータに耐えうるデータ格納方法を選定し、個人情報保護の観点からユーザーIDの匿名化ロジックを含めます。

スコープ

閲覧履歴のトラッキング対象（イベント、ユーザー）の定義。

ログデータ格納方法の選定（カスタムDBテーブル vs カスタムポストメタ）と、選定されたスキーマの詳細定義。

個人情報保護のためのユーザーID匿名化（ハッシュ化）ロジックの定義。

重複ログを避けるためのロギングロジックの定義。

設計内容

1. トラッキング対象とロギングロジック

項目	定義	備考
トラッキングイベント	ma_caseカスタム投稿タイプの個別案件ページ閲覧時のみ。	管理画面での閲覧、一覧ページ、REST APIアクセスは対象外。
トラッキングユーザー	ma_partnerロールを持つ、ログイン済みユーザーのみ。	ゲストユーザーや管理者ロールはトラッキング対象外。
重複ログ制御	ログ挿入前に、過去 60秒以内に同じ user_id が同じ post_id を閲覧した履歴がないかチェックする。	ページリロードによるログの重複を防止し、データ量を最適化。
Google スプレッドシートにエクスポート

2. データ格納方法の選定

選定：カスタムデータベーステーブル（wp_ma_view_log）

観点	カスタムDBテーブル	カスタムポストメタ (wp_usermeta)	選定理由
スケーラビリティ	高。ログ専用のインデックスとクエリが可能。	低。wp_usermetaの肥大化とインデックス効率低下を招く。	大量のログデータが予想されるため、専用テーブルが必須。
検索効率	高。post_idやview_timestampでの高速検索が可能。	低。meta_keyとmeta_valueの組み合わせ検索に制約がある。	ログ分析時の柔軟性と速度を優先。
クレンジング	容易。期間指定での一括削除（DELETE FROM）が容易。	困難。Postmetaの削除ロジックが複雑化する。	メンテナンスの容易性を考慮。
Google スプレッドシートにエクスポート

カスタムデータベーススキーマ詳細（再定義）

テーブル名	wp_ma_view_log	備考
log_id	BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT	プライマリキー。
user_id_hash	CHAR(64) NOT NULL	ユーザーIDのSHA-256ハッシュ値（匿名化データ）。
post_id	BIGINT(20) UNSIGNED NOT NULL	閲覧された案件（ma_case）のID。
view_timestamp	DATETIME NOT NULL	閲覧日時。
Indexes	user_id_hash, post_id, view_timestamp	必須。ログ検索の効率化。
Google スプレッドシートにエクスポート

3. ユーザーID匿名化（ハッシュ化）ロジック

プライバシー保護のため、データベースには生のユーザーID（user_id）を直接格納せず、不可逆なハッシュ値を使用します。

対象: get_current_user_id()で取得した提携パートナーのユーザーID。

アルゴリズム: SHA-256を使用。

ハッシュ生成ロジック: HASH( user_id + SECRET_SALT )

SECRET_SALT: WordPressのwp-config.phpに格納されているユニークな秘密鍵（例: LOG_SALT定数）を使用し、ブルートフォース攻撃やリバースエンジニアリングを困難にする。

用途: ログ分析時に、特定のハッシュ値がどの程度の案件を閲覧したかを統計的に把握するために使用。特定のハッシュ値から元のユーザーIDを特定することはできないようにします。

4. 実装フックとロジックフロー

フックポイント: wp_footer アクション または the_post アクション。

フロー:
a.  is_singular('ma_case')で案件個別ページであることを確認。
b.  current_user_can('ma_partner')で提携パートナーであることを確認。
c.  現在のユーザーIDを取得し、SECRET_SALTを用いて**user_id_hash**を生成。
d.  wpdbクラスを利用し、user_id_hashとpost_idで過去60秒以内の重複ログをチェック。
e.  重複がない場合、user_id_hash, post_id, NOW()をwp_ma_view_logテーブルに挿入。

技術選定

分野	技術	選定理由
データ格納	MySQL カスタムテーブル	スケーラビリティ、メンテナンス性、高速なクエリ性能を確保するため。
DB操作	WordPress $wpdb クラス	WordPress環境での安全かつ標準的なDB操作（インサート、チェック）を実現するため。
匿名化	PHP hash('sha256', ...)	ユーザーIDを不可逆な形式で安全に保存し、個人情報保護の要件を満たすため。
ログクレンジング	WordPress CRON API	大量に蓄積されるログを定期的に自動削除するためのスケジューリング機構。
Google スプレッドシートにエクスポート

実装における注意点

SALT管理: ハッシュ化に使用する SECRET_SALT は、wp-config.phpなどの設定ファイルに厳重に管理し、ソースコードリポジトリに平文で公開しないこと。

CRONジョブ: ログクレンジングのCRONジョブは、サーバー負荷を考慮し、深夜などトラフィックの少ない時間帯に実行されるよう設計すること。

DB接続エラーハンドリング: ログ挿入処理はサイトの中核機能ではないため、DB挿入に失敗した場合でも、サイトの表示自体が停止しないよう、try-catchなどのエラーハンドリングを必ず実装すること。

次のステップ

データ暗号化モジュール詳細設計: 機密情報保護のための最終設計。暗号化・複合化ロジック、鍵管理、およびフックポイントの詳細を定義する。この設計が完了すれば、セキュリティ設計の全工程が完了する。

UI/UX画面設計: 提携パートナー向け管理画面（案件登録/編集、一覧）や、この閲覧履歴データを分析者向けに表示するダッシュボード