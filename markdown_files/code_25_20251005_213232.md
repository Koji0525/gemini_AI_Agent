# コード: 定義されたカスタム投稿タイプ、カスタムロール、アクセス制御ロジックの実装（WordPressテーマ/プラグイン開発）を開始する。

タスクID: 25
作成日時: 2025-10-05T21:32:32.406526

---

タスクの性質上、WordPressのプラグインとして動作するPHPコードと、その動作を確認するためのシンプルなPHPテストコード（ユニットテストではない簡易な動作確認コード）を実装します。このコードは、カスタム投稿タイプ（ma_case）の登録と、提携パートナー（ma_partner）ロールへの投稿者ベースのアクセス制御（RBAC）を確立します。

タスク概要

目的

M&A案件データ格納用のカスタム投稿タイプ（ma_case）を定義し、提携パートナー（ma_partner）専用のカスタムロールを作成します。さらに、このma_partnerが自身が登録した案件のみを管理画面で閲覧・編集できるようにする**投稿者ベースのアクセス制御（RBAC）**ロジックを実装します。

技術的要点

register_post_typeを使用したma_caseの登録。

add_roleとadd_capを使用したma_partnerロールの定義。

pre_get_postsフックを使用した管理画面での案件一覧表示制限。

map_meta_capフックを使用した編集・削除権限の最終チェック。

実装内容

WordPressプラグインのコアファイルとして動作するPHPコードを提供します。このコードは、プラグインの有効化時にロールとCPTを登録し、適切なフックを使ってRBACを実装します。

コード

PHP
<?php
/**
 * Plugin Name: M&A Portal Access Control
 * Description: M&A案件のカスタム投稿タイプと提携パートナーのRBACを実装するプラグイン。
 * Version: 1.0
 * Author: System Designer
 */

// ---------------------------------------------------------------------
// 1. CPTとカスタムロールの定義
// ---------------------------------------------------------------------

/**
 * プラグイン有効化時にカスタムロールとCPTを登録
 */
function ma_portal_register_elements() {
    // 案件管理に必要なカスタムケイパビリティを定義
    $caps = array(
        'edit_post'              => 'edit_ma_case',
        'read_post'              => 'read_ma_case',
        'delete_post'            => 'delete_ma_case',
        'edit_posts'             => 'edit_ma_cases',
        'edit_others_posts'      => 'edit_others_ma_cases',
        'publish_posts'          => 'publish_ma_cases',
        'read_private_posts'     => 'read_private_ma_cases',
        'delete_posts'           => 'delete_ma_cases',
        'delete_private_posts'   => 'delete_private_ma_cases',
        'delete_published_posts' => 'delete_published_ma_cases',
        'delete_others_posts'    => 'delete_others_ma_cases',
        'edit_private_posts'     => 'edit_private_ma_cases',
        'edit_published_posts'   => 'edit_published_ma_cases',
    );
    
    // CPT: M&A案件 (ma_case) の登録
    register_post_type('ma_case',
        array(
            'labels'      => array(
                'name'          => __('M&A案件', 'textdomain'),
                'singular_name' => __('案件', 'textdomain')
            ),
            'public'      => true,
            'has_archive' => true,
            'menu_icon'   => 'dashicons-briefcase',
            'supports'    => array('title', 'editor', 'author'),
            // RBACの核となる設定: 'map_meta_cap'をTrueにし、コアの投稿者ベース制御を有効にする
            'capability_type' => 'ma_case', 
            'map_meta_cap'    => true, 
        )
    );

    // カスタムロール: 提携パートナー (ma_partner) の登録
    // デフォルトの投稿者権限をベースに、ma_case CPTの権限を付与
    $partner_caps = array(
        'read'                  => true,
        'upload_files'          => true, // 案件資料アップロード用
        'view_sensitive_data'   => true, // 機密情報閲覧用（カスタムケイパビリティ）
        
        // 案件（ma_case）に関する権限を付与
        'read_ma_case'             => true,
        'edit_ma_cases'            => true,
        'edit_published_ma_cases'  => true,
        'delete_ma_case'           => true,
        'delete_published_ma_cases'=> true,
        
        // **最重要**: 他者の投稿編集・削除権限は付与しない
        'edit_others_ma_cases'     => false,
        'delete_others_ma_cases'   => false,
        'publish_ma_cases'         => false, // 承認制のため公開権限は管理者のみ
    );

    add_role('ma_partner', __('提携パートナー', 'textdomain'), $partner_caps);
}
add_action('init', 'ma_portal_register_elements', 0);

/**
 * プラグイン非有効化時のクリーンアップ
 */
function ma_portal_cleanup_elements() {
    // ロールの削除 (ロールにユーザーがいないかチェックを推奨)
    remove_role('ma_partner');
}
register_deactivation_hook(__FILE__, 'ma_portal_cleanup_elements');


// ---------------------------------------------------------------------
// 2. RBACロジックの実装 (自身が登録した案件のみに制限)
// ---------------------------------------------------------------------

/**
 * 管理画面の案件一覧/編集クエリをフックし、ma_partnerの閲覧を自身が登録した案件のみに制限する (RBAC: データ取得層)
 * @param WP_Query $query WordPressのクエリオブジェクト
 */
function ma_portal_restrict_ma_case_list($query) {
    // ログイン中のユーザー、かつ管理画面、かつ主クエリ、かつma_case CPTを対象としているか
    if ( is_admin() && $query->is_main_query() && $query->get('post_type') === 'ma_case' ) {
        $user = wp_get_current_user();
        // 提携パートナーロールを持つユーザーのみに適用
        if ( in_array('ma_partner', (array) $user->roles, true) ) {
            // 投稿者IDを現在のユーザーに強制的に設定
            // これにより、管理画面のリストには自身の投稿のみが表示される
            $query->set('author', $user->ID);
        }
    }
}
add_action('pre_get_posts', 'ma_portal_restrict_ma_case_list');

/**
 * 編集・削除権限の最終チェックを行う (RBAC: 権限マッピング層)
 * URLを直接叩かれた際の不正な編集・削除を防ぐための二重チェック
 * @param array $caps 権限配列
 * @param string $cap 権限名
 * @param int $user_id ユーザーID
 * @param array $args 引数
 * @return array 変更された権限配列
 */
function ma_portal_restrict_edit_delete($caps, $cap, $user_id, $args) {
    // 'ma_case' CPTに関連する編集・削除権限をチェック
    if ( in_array($cap, ['edit_ma_case', 'delete_ma_case'], true) ) {
        $post_id = $args[0] ?? 0;
        $post = get_post($post_id);

        if ( $post && $post->post_type === 'ma_case' ) {
            $user = get_user_by('ID', $user_id);
            // 提携パートナーロールを持つユーザーかチェック
            if ( $user && in_array('ma_partner', (array) $user->roles, true) ) {
                // 案件の投稿者IDと現在のユーザーIDが一致しない場合
                if ( (int) $post->post_author !== $user_id ) {
                    // 編集・削除権限を剥奪する
                    $caps[] = 'do_not_allow';
                }
            }
        }
    }
    return $caps;
}
add_filter('map_meta_cap', 'ma_portal_restrict_edit_delete', 10, 4);

// ---------------------------------------------------------------------
// 3. 承認ワークフローの制御（ma_partnerはpublishできない）
// ---------------------------------------------------------------------

/**
 * 提携パートナーによる案件の直接公開をブロックし、ステータスを'pending'に固定する
 * @param array $data 投稿データ
 * @param array $postarr 投稿データ
 * @return array 修正された投稿データ
 */
function ma_portal_block_direct_publish($data, $postarr) {
    if ( $data['post_type'] === 'ma_case' && $data['post_status'] === 'publish' ) {
        $user = wp_get_current_user();
        // ma_partnerロールを持つユーザーが公開しようとした場合
        if ( in_array('ma_partner', (array) $user->roles, true)