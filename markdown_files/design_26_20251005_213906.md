# 設計書: データ暗号化モジュール詳細設計書作成。対象カスタムフィールド、鍵とアルゴリズム、フックポイント（save/get）、鍵の保存場所の具体的な仕様を定義する。

タスクID: 26
作成日時: 2025-10-05T21:39:06.189303

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトにおける機密データの暗号化モジュールの詳細設計を行います。これは、これまで設計してきたアクセス制御（RBAC）とデータベーススキーマを、セキュリティ面で補完する最も重要なタスクです。

タスク概要

目的

案件データのうち、価格や財務情報などの機密性の高いカスタムフィールドについて、データベース格納時に暗号化し、取得時に複合化するモジュールの詳細仕様を定義します。これにより、データベースへの不正アクセスや情報漏洩が発生した場合でも、データの内容を保護することを保証します。

スコープ

暗号化対象となるカスタムフィールドの特定。

使用する暗号化アルゴリズムと鍵管理の仕様定義。

WordPressのデータ保存/取得フック（save/get）を用いた暗号化/複合化の実行ロジック定義。

認証・権限と連携した複合化制御ロジックの定義。

設計内容

1. 暗号化対象フィールドとアルゴリズム

カスタムフィールド（メタキー）	データ内容	暗号化の必要性	アルゴリズム
price_amount	希望価格（数値）	必須	AES-256-GCM
financial_data	財務詳細データ（JSON）	必須	AES-256-GCM
post_content	案件の概要・譲渡理由	不要（アクセス制御で対応）	-
Google スプレッドシートにエクスポート

アルゴリズム選定理由: AES-256-GCMは、業界標準の強力な暗号化（256ビット鍵）を提供するだけでなく、改ざん防止機能（認証タグ）を持つため、データの機密性と完全性の両方を確保できます。

2. 鍵管理（Key Management）の仕様

データベースに保存されるデータと、それを複合化するための鍵は、分離して管理（キーセパレーション）します。

項目	詳細仕様	備考
暗号化鍵 (Encryption Key)	64文字のランダムな秘密鍵 (32バイト)	wp-config.php 内の新しい定数（例: MA_ENCRYPTION_KEY）として定義。鍵はDB外に保持。
初期化ベクトル (IV/Nonce)	各データレコードごとにユニーク	複合化に必要なため、暗号化されたデータと一緒に保存。
鍵のアクセス制御	PHPの実行環境からのみアクセス可能。	wp-config.phpのパーミッションを厳格に制限（例: 400）。
Google スプレッドシートにエクスポート

3. データ保存時の暗号化ロジック (フック: update_post_metadata)

提携パートナーまたは管理者が案件を保存する際に実行されます。

ステップ	処理内容	実行フック
1. データ取得	$_POSTからprice_amount, financial_dataの生の値を取得。	update_post_metadata (またはACFのacf/save_postなど)
2. IV生成	ランダムなユニークなIV（例: 12バイト）を生成。	PHPのopenssl_random_pseudo_bytesを使用。
3. 暗号化実行	openssl_encrypt関数を使用し、AES-256-GCMで値を暗号化。	暗号化後の値、IV、認証タグを生成。
4. 保存データ形式	**BASE64でエンコードした「IV + 認証タグ + 暗号化データ」**を連結した文字列としてDBに保存。	DB格納型はLONGTEXT（wp_postmeta.meta_value）。
Google スプレッドシートにエクスポート

4. データ取得時の複合化ロジック (フック: get_post_metadata)

権限のあるユーザーが案件を閲覧する際に実行されます。

ステップ	処理内容	実行フック
1. 権限チェック (RBAC)	現在のユーザーが**view_sensitive_data**ケイパビリティを持っているか確認。	get_post_metadata
2. データ取得	wp_postmetaから暗号化された文字列を取得。	-
3. データ解析	取得した文字列から、IV、認証タグ、暗号化データを分離。	-
4. 複合化実行	openssl_decrypt関数を使用し、AES-256-GCMでデータを複合化。	複合化に失敗した場合（改ざん検知）、空またはエラー値を返す。
5. 値の返却	複合化された生の値をWP_Queryやテンプレートに返す。	-
6. 非権限ユーザー	権限がない場合（ステップ1）、複合化処理をスキップし、暗号化された文字列をそのまま返す（またはマスキング値を返すロジックを追加）。	-
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
暗号化アルゴリズム	AES-256-GCM (via PHP OpenSSL)	現代のセキュリティ標準であり、認証機能（改ざん防止）を持つため、データの機密性と完全性の両方を確保できる。
DBフック	get_post_metadata / update_post_metadata	WordPressのカスタムフィールド操作の核となるフックであり、データの保存/取得の直前/直後に処理を挿入する最も確実な方法である。
鍵管理	wp-config.php 定数	データベースと分離して鍵を保存する最もシンプルかつ確実な方法。クラウドの鍵管理サービス（KMS）の導入に比べて実装負荷が低い。
Google スプレッドシートにエクスポート

実装における注意点

IV/認証タグの保存: IV（初期化ベクトル）と認証タグは、複合化に必須であるため、暗号化データと一緒にDBに保存されますが、これら自体は機密情報ではないことに留意してください。

パフォーマンス: get_post_metadataフックはデータの取得ごとに実行されるため、大規模なクエリ（特にWP_Queryでの一括取得）で頻繁に複合化が実行されるとパフォーマンス低下を招く可能性があります。このため、検索機能では外部検索エンジン（Elasticsearchなど）の利用を改めて強く推奨します。

エラーハンドリング（改ざん）: openssl_decryptが失敗した（認証タグが一致しない＝データが改ざんされた）場合、致命的なエラーとしてログを記録し、複合化された値ではなく空の値（またはエラー通知）を返すことで、攻撃者に対するフィードバックを防ぐ必要があります。

鍵のローテーション: 鍵のライフサイクル管理はセキュリティ運用上の必須要件です。鍵を定期的に更新（ローテーション）する運用ポリシーを確立する必要があります。これには、古い鍵で複合化し、新しい鍵で再暗号化するバッチ処理の実装が必要です。

次のステップ

UI/UX画面設計: 機能設計の最終段階として、提携パートナー向け管理画面（案件登録/編集、一覧）や、管理者向け分析ダッシュボードの具体的なワイヤーフレームを設計する。

API仕様の定義（REST API）: データアクセス層を完成させるため、RBACと暗号化ロジックを考慮に入れた案件情報取得用REST APIのエンドポイントと認証要件を定義する。

インフラ構成設計: