# コード: 企業情報検索・絞り込み機能のプロトタイプ実装（売上、利益、業種などでのフィルタリング機能）

タスクID: 5
作成日時: 2025-10-05T19:18:39.001562

---

経験豊富なソフトウェアエンジニアとして、M&Aポータルサイトの核心機能である企業情報検索・絞り込み機能のプロトタイプを実装します。WordPressのカスタム投稿タイプ（ma_deal）とカスタムフィールド（ACF）のデータを、効率的にフィルタリングするPHPコードを中心に実装します。

タスク概要

先行タスクで定義・入力されたM&A案件データ（カスタム投稿タイプ ma_deal）に対し、ユーザーが指定した条件（売上レンジ、利益レンジ、業種、所在地）でフィルタリングし、結果一覧を表示する機能のプロトタイプを実装します。

目的

フォーム実装: ユーザーが検索条件を入力するためのHTMLフォームを準備する。

クエリ実装: フォームから送信されたパラメータ（$_GET）を取得し、WP_Queryのmeta_queryとtax_queryを活用してデータを絞り込むロジックを実装する。

エラーハンドリング: パラメータの検証と、検索結果がない場合の適切なメッセージ表示を実装する。

実装内容

この機能は、主に検索フォームの表示と、そのフォームの送信を受けてWP_Queryをカスタマイズするロジックの2つの要素で構成されます。

検索フォーム（HTML/PHP）: 業種と所在地（タクソノミー）の選択肢、売上・利益の範囲入力フィールドを持つシンプルなフォームを作成します。

WP_Queryフック（PHP）: WordPressの標準フックpre_get_postsを使用し、メインクエリが実行される直前にカスタムパラメータ（カスタムフィールドやタクソノミーの条件）を追加することで、データベースへの負荷を抑えつつ柔軟な絞り込みを実現します。

絞り込み条件とWP_Queryへのマッピング

ユーザー入力	データ型 (ACF Key)	WP_Query引数
業種	industry (Taxonomy)	tax_query
所在地	location (Taxonomy)	tax_query
売上レンジ	revenue_last_year (Number)	meta_query (BETWEEN)
利益レンジ	ebitda (Number)	meta_query (BETWEEN)
Google スプレッドシートにエクスポート

コード

以下のコードは、テーマファイル（例: archive-ma_deal.php や functions.php）に配置することを想定しています。

1. 検索フォームの表示 (例: archive-ma_deal.php の上部に配置)

PHP
<?php
/**
 * M&A案件の絞り込み検索フォーム
 * フォームが送信されると、同じアーカイブページにGETリクエストを送信する。
 */

// タクソノミーの選択肢を取得
$industries = get_terms( array('taxonomy' => 'industry', 'hide_empty' => true) );
$locations = get_terms( array('taxonomy' => 'location', 'hide_empty' => true) );

// GETパラメータの安全な取得と初期化
$selected_industry = isset($_GET['industry']) ? sanitize_text_field($_GET['industry']) : '';
$selected_location = isset($_GET['location']) ? sanitize_text_field($_GET['location']) : '';
$min_revenue = isset($_GET['min_revenue']) ? intval($_GET['min_revenue']) : '';
$max_revenue = isset($_GET['max_revenue']) ? intval($_GET['max_revenue']) : '';
$min_ebitda = isset($_GET['min_ebitda']) ? intval($_GET['min_ebitda']) : '';

?>
<form method="get" action="<?php echo esc_url(get_post_type_archive_link('ma_deal')); ?>" class="ma-filter-form">
    <h3>M&A案件 絞り込み検索</h3>
    
    <label for="industry">業種:</label>
    <select name="industry" id="industry">
        <option value="">全ての業種</option>
        <?php foreach ($industries as $term) : ?>
            <option 
                value="<?php echo esc_attr($term->slug); ?>" 
                <?php selected($selected_industry, $term->slug); ?>>
                <?php echo esc_html($term->name); ?>
            </option>
        <?php endforeach; ?>
    </select>
    
    <label for="location">所在地:</label>
    <select name="location" id="location">
        <option value="">全ての所在地</option>
        <?php foreach ($locations as $term) : ?>
            <option 
                value="<?php echo esc_attr($term->slug); ?>" 
                <?php selected($selected_location, $term->slug); ?>>
                <?php echo esc_html($term->name); ?>
            </option>
        <?php endforeach; ?>
    </select>
    
    <fieldset>
        <legend>売上 ($USD)</legend>
        <input type="number" name="min_revenue" placeholder="最小売上" value="<?php echo esc_attr($min_revenue); ?>">
        ～
        <input type="number" name="max_revenue" placeholder="最大売上" value="<?php echo esc_attr($max_revenue); ?>">
    </fieldset>

    <fieldset>
        <legend>EBITDA/利益 ($USD)</legend>
        <input type="number" name="min_ebitda" placeholder="最小利益" value="<?php echo esc_attr($min_ebitda); ?>">
    </fieldset>

    <button type="submit">検索・絞り込み</button>
</form>

<?php
// クエリ結果のループはここから始まる
// if ( have_posts() ) : while ( have_posts() ) : the_post(); ...
// ...
// endwhile; else : ...
// ...
?>


2. WP_Queryのカスタマイズ（functions.phpに配置）

PHP
<?php
/**
 * 検索・絞り込み条件をWP_Queryに適用する関数
 *
 * @param WP_Query $query WordPressのクエリオブジェクト
 * @return void
 */
function apply_ma_deal_filters( $query ) {
    // 1. 管理画面のクエリではないこと and メインクエリであること and ma_dealアーカイブページであること を確認
    if ( is_admin() || ! $query->is_main_query() || ! $query->is_post_type_archive('ma_deal') ) {
        return;
    }

    $meta_query = array( 'relation' => 'AND' ); // カスタムフィールドの条件を格納
    $tax_query = array( 'relation' => 'AND' );  // タクソノミーの条件を格納
    
    // ===============================================
    // 2. タクソノミー (業種/所在地) の絞り込み処理
    // ===============================================
    
    // 業種 (industry) の絞り込み
    if ( ! empty( $_GET['industry'] ) ) {
        $slug = sanitize_text_field( $_GET['industry'] );
        // パラメータが安全であることを確認してから追加
        if ( term_exists($slug, 'industry') ) {
            $tax_query[] = array(
                'taxonomy' => 'industry',
                'field'    => 'slug',
                'terms'    => $slug,
            );
        } else {
            // エラーハンドリング：不正なタクソノミースラッグを無視
            error_log('Invalid industry slug provided: ' . $slug);
        }
    }

    // 所在地 (location) の絞り込み
    if ( ! empty( $_GET['location'] ) ) {
        $slug = sanitize_text_field( $_GET['location'] );
        if ( term_exists($slug, 'location') ) {
            $tax_query[] = array(
                'taxonomy' => 'location',
                'field'    => 'slug',
                'terms'    => $slug,
            );
        }
    }

    // ===============================================
    // 3. カスタムフィールド (売上/利益) の絞り込み処理
    // ===============================================
    
    $min_revenue = isset($_GET['min_revenue']) ? intval($_GET['min_revenue']) : null;
    $max_revenue = isset($_GET['max_revenue']) ? intval($_GET['max_revenue']) : null;
    $min_ebitda = isset($_GET['min_ebitda']) ? intval($_GET['min_ebitda']) : null;
    
    // 売上レンジ (revenue_last_year) の絞り込み
    if ( ! is_null($min_revenue) && $min_revenue >= 0 ) {
        // 最大値が設定されている場合 (レンジ検索)
        if ( ! is_null($max_revenue) && $max_revenue >= $min_revenue ) {
             $meta_query[] = array(
                'key'     => 'revenue_last_year',
                'value'   => array( $min_revenue, $max_revenue ),
                'type'    => 'NUMERIC', // 数値として比較
                'compare' => 'BETWEEN',
            );
        } else {
            // 最小値のみ設定されている場合 (〇〇以上)
            $meta_query[] = array(
                'key'     => 'revenue_last_year',
                'value'   => $min_revenue,
                'type'    => 'NUMERIC',
                'compare' => '>=',
            );
        }
    }
    
    // 利益 (ebitda) の最小値絞り込み (〇〇以上)
    if ( ! is_null($min_ebitda) ) {
        $meta_query[] = array(
            'key'     => 'ebitda',
            'value'   => $min_ebitda,
            'type'    => 'NUMERIC',
            'compare' => '>=',
        );
    }

    // ===============================================
    // 4. クエリへの適用とエラーハンドリング
    // ===============================================
    
    // meta_queryの適用
    if ( count( $meta_query ) > 1 ) { // 'relation' => 'AND' のみの場合(1つ)を除く
        $query->set( 'meta_query', $meta_query );
    }

    // tax_queryの適用
    if ( count( $tax_query ) > 1 ) {
        $query->set( 'tax_query', $