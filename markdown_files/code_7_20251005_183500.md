# コード: Google Apps Scriptによる情報収集の多言語翻訳（7か国語）の精度チェックとロジック改善

タスクID: 7
作成日時: 2025-10-05T18:35:00.336717

---

このタスクでは、Google Apps Script (GAS) を使用して、情報収集したテキストデータの多言語翻訳の精度をチェックし、その結果に基づいて翻訳ロジックを改善するための仕組みを実装します。

GASはサーバーレスで実行でき、Google翻訳サービスへのアクセスが容易なため、この目的に適しています。

タスク概要

情報収集プロセスで得られたテキストデータ（日本語）を、Google翻訳API（LanguageApp.translate）を用いて7か国語に翻訳する際のロジックを実装します。

コアタスクは、単なる翻訳ではなく、翻訳結果の品質（精度）を測定するためのロジックと、その結果を元に翻訳品質を段階的に改善するためのログ記録・評価システムを構築することです。

翻訳対象言語（7か国語）

英語（en）、中国語（zh）、韓国語（ko）、フランス語（fr）、ドイツ語（de）、スペイン語（es）、ポルトガル語（pt）

実装内容

Google Apps Script (GAS) で以下の主要な関数を実装します。

translateAndLogQuality(originalText): 翻訳ロジックの核となる関数。指定された7か国語に翻訳し、翻訳後のテキストの長さや特定のキーワードの有無などをチェックする簡易的な精度チェックロジックを実行します。

runQualityCheck(dataRange): スプレッドシートの指定されたデータ範囲の各セルに対して翻訳を実行し、結果をスプレッドシートに記録します。

簡易的な精度チェック: 今回は、機械学習モデルを使用せず、翻訳後のテキスト長が元のテキスト長の20%〜300%の範囲内にあること、および翻訳前後のテキストに特定のNGワードが含まれていないことを「精度が高い」とする経験則ベースのチェックを実装します（原則3, 5）。

エラーハンドリング: Google翻訳サービスへのアクセス失敗やAPI制限エラーをキャッチします。

コード

このコードは、Google Apps Scriptエディタに貼り付けて使用することを想定しています。

JavaScript
/**
 * Google Apps Scriptによる多言語翻訳の精度チェックとロジック改善ロギング
 * * @fileoverview 情報収集テキストの多言語翻訳（7か国語）を実行し、簡易的な精度チェックと改善のためのロギングを行う。
 * @version 1.0.0
 * @author YourName
 */

// 翻訳対象の言語コード (ISO 639-1)
const TARGET_LANGUAGES = ['en', 'zh', 'ko', 'fr', 'de', 'es', 'pt'];
// 翻訳元言語 (ここでは日本語を想定)
const SOURCE_LANGUAGE = 'ja';
// 翻訳ロジック改善のためのNGワードチェックリスト (例: 固有名詞などが不適切に翻訳された場合)
const NG_WORDS_ORIGINAL = ['特定名称A', '特定名称B']; // 日本語NGワード
const NG_WORDS_TRANSLATED = ['SpecificNameA', 'SpecificNameB']; // 翻訳後NGワード

/**
 * スプレッドシートの指定された範囲のテキストを翻訳し、品質チェックを実行する。
 *
 * @param {string} dataRange スプレッドシート上のデータ範囲 (例: 'A2:A11')。
 */
function runQualityCheck(dataRange = 'A2:A11') {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getRange(dataRange).getValues();
    
    // ヘッダー行をスキップし、結果の書き込み開始列を計算
    // A列が元テキストの場合、結果はB列から開始
    const startRow = sheet.getRange(dataRange).getRow();
    const startCol = sheet.getRange(dataRange).getColumn() + 1;

    // ログシートを設定 (改善ロジックのためのデータ蓄積場所)
    const logSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('TranslationLog') || 
                     SpreadsheetApp.getActiveSpreadsheet().insertSheet('TranslationLog');
    
    // ロギング用ヘッダー
    if (logSheet.getLastRow() === 0) {
        const logHeaders = ['Timestamp', 'OriginalText', 'TargetLang', 'TranslatedText', 'QualityScore', 'Reason'];
        logSheet.appendRow(logHeaders);
    }

    // 各行のテキストに対して翻訳と品質チェックを実行
    data.forEach((row, index) => {
        const originalText = row[0];
        const currentRow = startRow + index;
        
        // 元のテキストが空の場合はスキップ (原則3)
        if (!originalText || originalText.trim() === '') {
            sheet.getRange(currentRow, startCol).setValue('SKIP: Empty Text');
            return;
        }

        // 翻訳と品質チェック
        const results = translateAndLogQuality(originalText, logSheet);

        // スプレッドシートに結果を書き込み
        results.forEach((result, langIndex) => {
            // 書き込み位置: 開始列 + 翻訳言語インデックス
            const col = startCol + langIndex; 
            
            let output = result.translatedText;
            
            // 精度が低い場合はマークを付与
            if (result.qualityScore < 0.8) {
                output = `🚨 [SCORE: ${result.qualityScore.toFixed(2)}] ${result.translatedText}`;
            }
            
            // 結果をシートに書き込む
            sheet.getRange(currentRow, col).setValue(output);
        });
    });

    Browser.msgBox('翻訳と品質チェックが完了しました。');
}


/**
 * 7か国語に翻訳し、簡易的な精度チェックを実行する。
 *
 * @param {string} originalText 翻訳元のテキスト（日本語）。
 * @param {GoogleAppsScript.Spreadsheet.Sheet} logSheet ログを書き込むシート。
 * @returns {Array<Object>} 翻訳結果と品質スコアの配列。
 */
function translateAndLogQuality(originalText, logSheet) {
    const results = [];
    
    TARGET_LANGUAGES.forEach(targetLang => {
        let translatedText = '';
        let qualityScore = 1.0; // 初期スコア
        let reason = 'OK';
        
        try {
            // Google翻訳サービスによる翻訳 (原則5: ベストプラクティス)
            translatedText = LanguageApp.translate(originalText, SOURCE_LANGUAGE, targetLang);
            
            // 4. 簡易的な精度チェックロジックの実行
            const checkResult = checkTranslationQuality(originalText, translatedText);
            qualityScore = checkResult.score;
            reason = checkResult.reason;
            
        } catch (e) {
            // 🚨 エラーハンドリング: API制限やその他のエラーを捕捉 (原則3)
            Logger.log(`Translation Error for ${targetLang}: ${e.message}`);
            translatedText = `ERROR: ${e.message.substring(0, 50)}...`;
            qualityScore = 0.0;
            reason = `API_ERROR: ${e.message}`;
        }
        
        results.push({
            targetLang: targetLang,
            translatedText: translatedText,
            qualityScore: qualityScore
        });

        // 翻訳ロジック改善のためのログ記録
        logSheet.appendRow([
            new Date(),
            originalText,
            targetLang,
            translatedText,
            qualityScore.toFixed(2),
            reason
        ]);
    });
    
    return results;
}


/**
 * 簡易的な経験則ベースの翻訳精度チェックロジック。
 *
 * @param {string} originalText 翻訳元のテキスト。
 * @param {string} translatedText 翻訳後のテキスト。
 * @returns {Object} スコアと理由を含むオブジェクト。
 */
function checkTranslationQuality(originalText, translatedText) {
    let score = 1.0;
    let reason = 'OK';
    
    const originalLen = originalText.length;
    const translatedLen = translatedText.length;

    // A. 長さチェック (翻訳後のテキスト長が極端に短い/長い場合に減点)
    // 経験則: 元テキスト長の20%未満、または300%超は低品質
    if (translatedLen < originalLen * 0.2) {
        score -= 0.3;
        reason = 'Too_Short';
    } else if (translatedLen > originalLen * 3.0) {
        score -= 0.3;
        reason = 'Too_Long';
    }

    // B. NGワードチェック (特定の単語が不適切に翻訳されていないか)
    // 元テキストにNGワードが含まれていて、翻訳後テキストに不適切なNGワードが残っている場合に減点
    NG_WORDS_ORIGINAL.forEach(word => {
        // 大文字・小文字を無視してチェック
        if (originalText.toLowerCase().includes(word.toLowerCase())) {
            NG_WORDS_TRANSLATED.forEach(ngWord => {
                if (translatedText.toLowerCase().includes(ngWord.toLowerCase())) {
                    score -= 0.5; // 重大な減点
                    reason = 'NG_Word_Detected';
                }
            });
        }
    });

    // スコアは0未満にならないように調整
    score = Math.max(0, score); 
    
    return { score: score, reason: reason };
}

// ----------------------------------------------------
// 【GASのカスタムメニュー用コード】
// ----------------------------------------------------

/**
 * スプレッドシートにカスタムメニューを追加する (可読性/使用方法の改善)
 */
function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('翻訳ツール')
      .addItem('翻訳と品質チェックを実行 (A2:A11)', 'runQualityCheckWrapper')
      .addToUi();
}

/**
 * runQualityCheck関数をメニューから呼び出すためのラッパー
 */
function runQualityCheckWrapper() {
  // 実行するデータ範囲を任意に変更可能
  runQualityCheck('A2:A11'); 
}