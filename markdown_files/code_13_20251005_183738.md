# コード: 提携パートナー管理用CRM（Google Sheetsなど）の構築と初期パートナー情報の登録

タスクID: 13
作成日時: 2025-10-05T18:37:38.486718

---

前のタスクで設計した「現地パートナー候補」のリスト管理基盤を、具体的なGoogle Apps Script (GAS) を用いて構築し、初期パートナー情報を**スプレッドシート（Google Sheets）**へ登録するロジックを実装します。

これは、Google Sheetsをデータストアとして、GASをバックエンドロジックとして利用する、迅速なプロトタイピングに適したベストプラクティスです。

タスク概要

提携パートナー候補を管理するための簡易CRMを、Google SheetsとGoogle Apps Script (GAS) を用いて構築します。具体的には、パートナー情報の入力フォームの設置（GASのUI）、データの検証、およびスプレッドシートへの安全な登録を行うためのコードを実装します。

目的

パートナー情報の登録・管理を構造化されたデータ形式で行う。

データ登録時に入力検証とエラーハンドリングを実施する（原則3）。

GASのカスタムUIを利用し、使いやすいインターフェースを提供する（原則1）。

実装内容

実装は、以下の2つの主要なコンポーネントで構成されます。

Google Apps Script (GAS):

onOpen(): スプレッドシートを開いたときにカスタムメニューを追加し、入力フォームを開く機能を提供します。

showPartnerForm(): パートナー情報入力用のHTMLサイドバー（フォーム）を表示します。

registerPartner(formData): フォームデータを受け取り、バリデーションとエラーチェックを行った後、スプレッドシートに登録します。

HTML/JavaScript:

入力項目（氏名、カテゴリ、優先度など）を持つフォームを定義します。

フォームの送信時にデータをGASのバックエンド関数に渡すJavaScriptロジックを記述します。

コード

1. Google Apps Script (GAS) コード

このコードは、Google Sheetsの「拡張機能」→「Apps Script」エディタに貼り付けます。

JavaScript
/**
 * Partner Management CRM - Google Apps Script Backend
 * 提携パートナー情報の登録と管理を行うGAS関数群。
 *
 * @version 1.0
 * @author YourName
 */

// 定数定義
const SHEET_NAME = 'PartnerList';
const HEADERS = [
    'Partner ID', 'Full Name (Local)', 'Full Name (Romaji)', 'Role Category', 
    'Organization', 'Contact Source', 'Initial Priority', 'Key Expertise', 
    'Risk Flag', 'Data Collector', 'Created At'
];

/**
 * 1. スプレッドシートを開いたときにカスタムメニューを作成 (原則1)
 */
function onOpen() {
    SpreadsheetApp.getUi()
        .createMenu('パートナー管理CRM')
        .addItem('新規パートナー登録', 'showPartnerForm')
        .addToUi();
}

/**
 * 2. サイドバーにパートナー登録フォームを表示
 */
function showPartnerForm() {
    // フォームのHTMLファイルをロード
    const html = HtmlService.createHtmlOutputFromFile('PartnerForm')
        .setWidth(300)
        .setTitle('新規パートナー情報登録');
    SpreadsheetApp.getUi().showSidebar(html);
}

/**
 * 3. パートナー情報登録ロジック (フォームからデータを受け取る)
 *
 * @param {Object} formData フォームから送信されたデータ
 * @returns {Object} 登録結果 (成功/失敗メッセージ)
 */
function registerPartner(formData) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(SHEET_NAME);

    // シートが存在しない場合は新規作成し、ヘッダーを設定
    if (!sheet) {
        sheet = ss.insertSheet(SHEET_NAME);
        sheet.appendRow(HEADERS);
    }
    
    // 🚨 データ検証とエラーハンドリング (原則3, 1)
    if (!formData.fullNameLocal || !formData.roleCategory || !formData.contactSource || !formData.initialPriority) {
        return { success: false, message: 'エラー: 必須フィールドが空です (氏名, カテゴリ, 情報源, 優先度)。' };
    }

    // データのサニタイズと型変換
    const initialPriority = parseInt(formData.initialPriority);
    const riskFlag = formData.riskFlag === 'true'; // 文字列をブール値に変換
    
    // 優先度が有効な範囲内かチェック (1-5)
    if (isNaN(initialPriority) || initialPriority < 1 || initialPriority > 5) {
        return { success: false, message: 'エラー: 初期優先度は1から5の数値で指定してください。' };
    }
    
    try {
        // IDの生成: 最後の行のID + 1とする (簡易的なスケーラビリティ対策)
        const lastRow = sheet.getLastRow();
        const partnerId = lastRow === 0 ? 1 : (sheet.getRange(lastRow, 1).getValue() || 0) + 1;
        
        // データの構築
        const rowData = [
            partnerId,
            formData.fullNameLocal,
            formData.fullNameRomaji || '',
            formData.roleCategory,
            formData.organization || '',
            formData.contactSource,
            initialPriority,
            formData.keyExpertise || '',
            riskFlag ? 'TRUE' : 'FALSE',
            Session.getActiveUser().getEmail() || 'System', // 🚨 セキュリティ: 登録ユーザーを記録
            new Date()
        ];
        
        // データをシートに追記
        sheet.appendRow(rowData);
        
        // シートのフォーマット調整 (可読性向上)
        if (sheet.getLastRow() === 2) { // 初回データ登録時のみ
            sheet.setColumnWidth(2, 180);
            sheet.setColumnWidth(6, 250);
            sheet.setFrozenRows(1);
        }

        return { success: true, message: `パートナーID ${partnerId} の登録が完了しました。` };

    } catch (e) {
        // 🚨 データベース書き込み時のエラーハンドリング
        Logger.log('Database Write Error: ' + e.toString());
        return { success: false, message: '致命的なエラーが発生しました: ' + e.toString() };
    }
}


2. HTML/JavaScript コード (PartnerForm.html)

GASエディタで「ファイル」→「新規作成」→「HTML」を選択し、ファイル名を PartnerForm として以下のコードを貼り付けます。

HTML
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body { font-family: sans-serif; margin: 10px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 3px; }
        input[type="text"], input[type="number"], select {
            width: 95%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;
        }
        button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .required::after { content: " *"; color: red; }
        #message { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <form id="partnerForm">
        <div class="form-group">
            <label for="fullNameLocal" class="required">氏名 (現地語):</label>
            <input type="text" id="fullNameLocal" name="fullNameLocal" required>
        </div>
        <div class="form-group">
            <label for="fullNameRomaji">氏名 (ローマ字):</label>
            <input type="text" id="fullNameRomaji" name="fullNameRomaji">
        </div>
        <div class="form-group">
            <label for="roleCategory" class="required">役割カテゴリ:</label>
            <select id="roleCategory" name="roleCategory" required>
                <option value="">選択してください</option>
                <option value="弁護士">弁護士</option>
                <option value="政治家">政治家</option>
                <option value="ITパーク主要人物">ITパーク主要人物</option>
                <option value="財界人">財界人</option>
                <option value="その他">その他</option>
            </select>
        </div>
        <div class="form-group">
            <label for="organization">所属組織:</label>
            <input type="text" id="organization" name="organization">
        </div>
        <div class="form-group">
            <label for="contactSource" class="required">情報源:</label>
            <input type="text" id="contactSource" name="contactSource" required placeholder="例: A氏紹介, LinkedIn, 〇〇ニュース">
        </div>
        <div class="form-group">
            <label for="initialPriority" class="required">初期優先度 (1-5):</label>
            <input type="number" id="initialPriority" name="initialPriority" min="1" max="5" required>
        </div>
        <div class="form-group">
            <label for="keyExpertise">主な専門分野:</label>
            <input type="text" id="keyExpertise" name="keyExpertise">
        </div>
        <div class="form-group">
            <input type="checkbox" id="riskFlag" name="riskFlag" value="true">
            <label for="riskFlag" style="display: inline;">リスク懸念あり</label>
        </div>
        
        <button type="submit" id="submitButton">登録</button>
    </form>
    <div id="message"></div>

    <script>
        document.getElementById('partnerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e