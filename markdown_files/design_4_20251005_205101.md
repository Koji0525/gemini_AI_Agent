# 設計書: WordPressにおける検索機能の具体的な実装仕様定義書作成（カスタムタクソノミー/カスタムフィールド検索の設計、検索対象項目、価格帯レンジ検索の実現方法）

タスクID: 4
作成日時: 2025-10-05T20:51:01.464006

---

はい、経験豊富なシステム設計者として、WordPressにおけるM&Aポータルサイトの検索機能について、具体的な実装仕様を定義します。

タスク概要

目的

M&Aポータルサイトの中核機能である検索機能を、WordPressの標準機能とプラグインを活用して実現するための具体的な実装仕様を定義します。特に、企業情報として定義されたカスタムフィールドやカスタムタクソノミーを検索対象とする方法、および価格帯レンジ検索の実現方法に焦点を当てます。

スコープ

検索対象となるカスタムフィールドおよびカスタムタクソノミーの定義。

検索UIの振る舞いと結果表示の仕様。

価格帯レンジ検索を可能にするデータ格納とクエリの設計。

セキュリティ（非公開情報のアクセス制御）の考慮。

設計内容

1. 案件データ構造の再定義（WordPress向け）

M&A案件情報をカスタム投稿タイプma_caseとして定義し、各表示項目を以下の方法で格納します。

項目名	格納方法	備考
案件名	post_title	WordPress標準のタイトル
M&Aスキーム	カスタムタクソノミー (ma_scheme)	ENUM/複数選択を考慮し、カスタムタクソノミーとして設計。
業種カテゴリ	カスタムタクソノミー (industry)	多対多を考慮し、カスタムタクソノミーとして設計。
所在地	カスタムタクソノミー (location)	都道府県・市区町村レベル。
進捗ステータス	カスタムタクソノミー (status)	公開中、商談中など。検索/表示フィルタに利用。
希望価格	カスタムフィールド (price_amount)	**数値（整数）**として格納。メタキー検索に使用。
キーワード	post_content	概要や譲渡理由などをここに格納し、標準の全文検索対象とする。
Google スプレッドシートにエクスポート

2. 検索対象項目と検索クエリ仕様

WordPressの標準クエリWP_Queryの拡張、または専用の検索プラグインを用いて以下の検索機能を実現します。

検索対象	実現方法	検索タイプ	備考
案件名	sパラメータ	部分一致	標準機能を利用
業種カテゴリ	tax_query	完全一致/複数選択	industryタクソノミーをAND/OR検索
所在地	tax_query	完全一致/複数選択	locationタクソノミーをAND/OR検索
M&Aスキーム	tax_query	完全一致/複数選択	ma_schemeタクソノミーをAND/OR検索
キーワード	sパラメータ	全文検索	post_contentを対象とした標準の全文検索
希望価格帯	meta_query	レンジ検索	price_amountカスタムフィールドに対してBETWEENクエリを実行（後述）
Google スプレッドシートにエクスポート

3. 価格帯レンジ検索の実現方法

実現ステップ:

データ格納: 希望売却/買収価格を、カスタムフィールドprice_amountに単位を統一した整数（例: 万円単位）で格納します。

UI: 検索UIには、Min/Maxの入力フィールド（例: 100万円〜500万円）を設けます。

クエリ生成: ユーザー入力（$min_price, $max_price）に基づき、WP_Queryに以下の**meta_query**を適用します。

PHP
$args['meta_query'][] = array(
    'key'     => 'price_amount',
    'value'   => array( $min_price, $max_price ),
    'type'    => 'NUMERIC', // 数値型として比較
    'compare' => 'BETWEEN',
);


4. 検索UIの振る舞いと結果表示

結果表示: 案件一覧表示にはWP_Queryの結果を使用し、ページネーションを必須とします（posts_per_pageは20件に設定）。

ソート機能: 以下のソートオプションを実装します。

新着順（デフォルト）：orderby=date, order=DESC

更新日順：orderby=modified, order=DESC

希望価格順：orderby=meta_value_num, meta_key=price_amount, order=ASC/DESC

5. セキュリティ/アクセス制御

非公開情報（価格の具体的な金額）:

検索結果一覧には、ログインユーザーかつ機密情報開示の許可を得たユーザー（提携パートナーなど）にのみ具体的な価格を表示します。

一般公開ユーザーには、価格レンジまたは「非公開」と表示するカスタムフィールドの表示制御ロジックをテーマ側で実装します。

提携パートナー管理:

提携パートナーは、カスタム投稿タイプ編集画面（/wp-admin/edit.php?post_type=ma_case）において、自身が投稿した案件のみが表示・編集できるように、pre_get_postsアクションフックなどを用いてクエリを制御します。

WordPressの**RBAC (Role-Based Access Control)**を拡張するプラグイン（例: User Role Editor）の導入を推奨します。

技術選定

分野	技術	選定理由
ベースCMS	WordPress	要求されたベースシステム。カスタム投稿タイプとカスタムフィールドの柔軟な構造化に対応。
データ構造拡張	ACF (Advanced Custom Fields) または Custom Post Type UI	案件のカスタム投稿タイプと、複雑なカスタムフィールド（価格、財務情報など）の管理を容易にする。
検索機能（コア）	WP_Query	カスタムタクソノミー検索 (tax_query) とカスタムフィールド検索 (meta_query) を用いて、要件の絞り込み検索を実現する。
検索UI/UX	Search & Filter Pro または FacetWP	WP_Queryの複雑なクエリをGUIで設定でき、価格レンジ検索や複数タクソノミー選択といった高度な絞り込みUIを素早く実装するため。
Google スプレッドシートにエクスポート

実装における注意点

価格データの型: カスタムフィールドprice_amountは、必ず**数値型（NUMERICまたはDECIMAL）**としてデータベースに格納し、meta_queryでも'type' => 'NUMERIC'を指定することで、正確なレンジ検索（大小比較）を保証します。文字列として格納すると、辞書順比較となり、検索結果が狂う原因となります。

検索パフォーマンス: meta_queryやtax_queryを多用するため、データベースインデックスの最適化が必須です。特にwp_postmetaテーブルのmeta_keyとmeta_valueには適切なインデックスを設定してください。

権限の徹底: 提携パートナー向けの管理画面では、必ずcurrent_user_can()関数やpre_get_postsフックを用いて、他パートナーの案件がクエリに含まれないように徹底的にアクセス制御を実装すること。

次のステップ

データベーススキーマ詳細設計: 本定義に基づき、カスタムタクソノミー名、カスタムフィールドキー名、データ型、デフォルト値を含む具体的なデータベーススキーマ定義書を作成する（特にwp_postmetaとカスタムタクソノミーテーブルの構造）。

提携パートナー管理機能のUI/UX設計: 提携パートナー専用の案件登録・編集フォームの画面遷移とUI詳細を設計する。