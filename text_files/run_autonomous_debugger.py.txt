# run_autonomous_debugger.py
import asyncio
import logging
import argparse
from pathlib import Path

from config_utils import config, ErrorHandler
from sheets_manager import GoogleSheetsManager
from browser_controller import BrowserController
from autonomous_debugger import AutonomousDebugger

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

async def main():
    parser = argparse.ArgumentParser(description='è‡ªå¾‹ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ')
    parser.add_argument('--command', type=str, required=True, help='ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰')
    parser.add_argument('--files', type=str, nargs='+', required=True, help='ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«')
    parser.add_argument('--pc-id', type=int, default=1, help='PC_ID')
    parser.add_argument('--max-attempts', type=int, default=5, help='æœ€å¤§è©¦è¡Œå›æ•°')
    
    args = parser.parse_args()
    
    print("=== è‡ªå¾‹ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹• ===")
    
    # åˆæœŸåŒ–
    sheets_manager = GoogleSheetsManager(config.SPREADSHEET_ID)
    browser = BrowserController(Path("."), mode='text', service='google')
    
    await browser.setup_browser()
    await browser.navigate_to_gemini()
    
    # ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    credentials = sheets_manager.load_credentials_from_sheet(args.pc_id)
    browser.credentials = credentials
    
    # è‡ªå¾‹ãƒ‡ãƒãƒƒã‚¬ãƒ¼èµ·å‹•
    debugger = AutonomousDebugger(
        browser_controller=browser,
        sheets_manager=sheets_manager,
        max_attempts=args.max_attempts
    )
    
    try:
        # ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ
        result = await debugger.debug_until_success(args.command, args.files)
        
        # çµæœè¡¨ç¤º
        print("\n" + "=" * 50)
        print("ãƒ‡ãƒãƒƒã‚°çµæœ")
        print("=" * 50)
        print(f"æˆåŠŸ: {result['success']}")
        print(f"è©¦è¡Œå›æ•°: {result['attempts']}")
        
        if result['success']:
            print("ğŸ‰ ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã—ã¾ã—ãŸï¼")
        else:
            print("âŒ ãƒ‡ãƒãƒƒã‚°ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ")
            print(debugger.generate_debug_report())
        
    except Exception as e:
        logger.error(f"ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    finally:
        await browser.cleanup()

if __name__ == "__main__":
    asyncio.run(main())