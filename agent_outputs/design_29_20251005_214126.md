# 設計書: データ暗号化モジュール詳細設計書作成。対象カスタムフィールド、鍵とアルゴリズム、フックポイント（save/get）、鍵の保存場所の具体的な仕様を定義する。

タスクID: 29
作成日時: 2025-10-05T21:41:26.988810

---

前回のレビューに基づき、設計済みですが、ユーザーからの再依頼として、データ暗号化モジュールの詳細設計を再提出します。これはM&Aポータルサイトのセキュリティ基盤を確立する極めて重要な設計です。

タスク概要

目的

M&A案件の機密データ（価格、財務情報など）をデータベース格納時に暗号化し、取得時に複合化するためのモジュールの詳細仕様を定義します。これにより、データ侵害が発生した場合でも、データの内容を保護し、機密性と完全性を確保します。

スコープ

暗号化対象となるカスタムフィールドの特定とアルゴリズムの選定。

鍵（キー）の生成、保存場所、およびアクセスの管理方法の定義。

WordPressのデータ入出力フックを利用した暗号化・複合化ロジックフローの定義。

権限と連携した複合化制御ロジックの定義。

設計内容

1. 暗号化対象フィールドとアルゴリズム

カスタムフィールド（メタキー）	データ内容	暗号化の必要性	アルゴリズム	特徴
price_amount	希望価格（数値）	必須	AES-256-GCM	強い機密性と改ざん検知機能。
financial_data	財務詳細データ（JSON）	必須	AES-256-GCM	データの機密性と完全性を確保。
Google スプレッドシートにエクスポート

アルゴリズム選定理由: AES-256-GCMは、業界標準の強力な暗号化（256ビット鍵）を提供し、さらに認証タグによる改ざん防止機能（データの完全性保証）を持つため、機密性の高いM&Aデータに最適です。

2. 鍵管理（Key Management）の仕様

データベースに保存される暗号化データと、それを複合化するための鍵は、**分離して管理（キーセパレーション）**します。

項目	詳細仕様	備考
暗号化鍵 (Encryption Key)	**32バイト (256ビット)**のランダムな秘密鍵。	wp-config.php 内の新しい定数（例: MA_ENCRYPTION_KEY）として定義。鍵はDB外に保持。
初期化ベクトル (IV/Nonce)	各データレコードごとにユニーク（通常12バイト）。	複合化に必要なため、暗号化後のデータと連結して保存。
鍵のアクセス制御	PHPの実行環境からのみアクセス可能。	wp-config.phpのパーミッションを厳格に制限（例: 400）。
Google スプレッドシートにエクスポート

3. データ保存時の暗号化ロジック (フック: update_post_metadata / ACFフック)

案件データのカスタムフィールドがDBに保存される直前に、暗号化処理を挿入します。

ステップ	処理内容	実行フック
1. データ取得	フォームから送信された生の値を取得。	update_post_metadata または acf/update_value
2. IV生成	ランダムなIVを生成。	PHPのopenssl_random_pseudo_bytesを使用。
3. 暗号化実行	openssl_encrypt関数でAES-256-GCM暗号化を実行し、暗号文と認証タグを取得。	-
4. 保存データ形式	**BASE64でエンコードした「IV + 認証タグ + 暗号文」**を連結した単一の文字列としてDBに保存。	DB格納型はLONGTEXT（wp_postmeta.meta_value）。
Google スプレッドシートにエクスポート

4. データ取得時の複合化ロジック (フック: get_post_metadata)

データがテンプレートやWP_Queryによって取得される直前に、複合化処理と権限チェックを挿入します。

ステップ	処理内容	実行フック
1. 権限チェック (RBAC)	現在のユーザーが**view_sensitive_data**ケイパビリティを持っているか確認。	get_post_metadata
2. データ取得	wp_postmetaからBASE64エンコードされた暗号文を取得。	-
3. データ解析	取得した文字列から、IV、認証タグ、暗号文を分離。	-
4. 複合化実行	openssl_decrypt関数を使用し複合化。認証タグの不一致は改ざんと判断し、複合化を拒否する。	-
5. 値の返却	権限がある場合: 複合化された生の値（JSONデータの場合はデコード処理を追加）を返す。	-
6. 非権限ユーザー	権限がない場合: 複合化せずに空の値またはマスキングされた文字列を返す。	-
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
暗号化アルゴリズム	AES-256-GCM (via PHP OpenSSL拡張)	改ざん検知機能（認証タグ）を持つ現代の標準的な強力な暗号化方式であり、セキュリティ設計に不可欠。
DBフック	get_post_metadata / update_post_metadata	WordPressのコアなデータI/Oに介入する最も確実な方法であり、カスタムフィールド操作全体に一貫したロジックを適用できる。
鍵管理	wp-config.php 定数	データベース外に鍵を保持し、コードリポジトリへの流出を防ぐための現実的かつ実装負荷の低い方法。
Google スプレッドシートにエクスポート

実装における注意点

鍵のローテーション: 鍵のセキュリティ運用計画を確立し、**鍵のローテーション（更新）**が必要になった際に、古い鍵で複合化し、新しい鍵で再暗号化するバッチ処理を事前に実装すること。

パフォーマンスの最適化: get_post_metadataフックによる複合化はCPU負荷が高く、一覧表示や検索時の速度低下を招きます。検索機能には、暗号化を前提とした**外部検索エンジン（Elasticsearch/Solr）**の導入を前提として、設計を進める必要があります。

エラーハンドリング（改ざん）: 複合化失敗時（特に認証タグ不一致）は、データ改ざんの可能性を意味します。この場合、ユーザーにエラーを表示するのではなく、複合化値をfalseやnullとして返し、システムログに深刻なエラーとして記録すること。

IV/Tagの厳格な分離: DBに保存される文字列からIVと認証タグを分離する際のバイト長（GCMでは認証タグは16バイトが標準）を厳格に管理し、複合化ロジックに反映させること。

次のステップ

この暗号化モジュールの設計をもって、M&A案件データに関する全ての主要なセキュリティ（RBAC、暗号化）とデータ構造（スキーマ）の設計が完了しました。

UI/UX画面設計 (required_role: ui): 提携パートナー向け案件登録・編集フォーム、一覧画面、および管理者向け分析ダッシュボードのワイヤーフレームと操作フローの定義。

API仕様の定義（REST API） (required_role: design): RBACと暗号化ロジックを考慮に入れた案件情報取得用REST APIのエンドポイントと認証要件の定義。

インフラ構成詳細設計 (required_role: design): 実装フェーズへの移行に必要な、本番環境のWAF、CDN、鍵管理、DB分離戦略を含む具体的な構成図の作成。