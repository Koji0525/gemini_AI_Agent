# コード: フロントエンドでの企業情報絞り込み検索機能の実装（業種、売上、利益での検索対応）

タスクID: 5
作成日時: 2025-10-05T18:34:27.662811

---

これは、WordPressのカスタム投稿タイプ「企業情報 (ma_company)」のデータを、フロントエンドでユーザーが指定した条件（業種、売上高）で絞り込み、表示するための機能実装です。

このタスクでは、PHP（WordPressのフック）とJavaScript（Ajax）を組み合わせて、ページ遷移なしで動的な絞り込みを実現する最新のベストプラクティスに基づいたコードを提供します。

タスク概要

M&A企業情報データベース（カスタム投稿タイプ ma_company）のフロントエンドに、以下の条件で投稿を絞り込むためのフォームを実装します。

検索フォーム: 業種（テキスト検索）、年間売上高（数値範囲）、M&Aステージ（プルダウン選択）を入力できるフォーム。

Ajax処理: フォーム送信時にページをリロードすることなく、サーバーサイドで絞り込み検索を実行し、結果を返す。

サーバーサイド処理: WP_Queryを使用してカスタムフィールド（meta_query）による高度な絞り込みを実施し、結果をHTMLで整形して返す。

実装内容

実装は3つの主要なコンポーネントに分かれます。

PHP (functions.php):

検索フォームを表示するためのショートコードを登録。

フロントエンドでAjaxを処理するためのエンドポイント（wp_ajax_* および wp_ajax_nopriv_*）を登録。

JavaScript:

フォームの送信イベントを捕捉し、Ajaxリクエストを構築・送信。

返されたHTMLを結果表示領域に挿入。

HTML/CSS:

検索フォームと結果表示領域の基本構造を定義。

今回は、コアロジックであるPHPとJavaScriptを提供します。

コード

1. PHPコード (functions.phpに追加)

PHP
<?php
// 1. フロントエンドで必要なスクリプトをエンキュー (原則5: ベストプラクティス)
function ma_company_enqueue_scripts() {
    // スクリプトの読み込み
    wp_enqueue_script(
        'ma-company-filter', // ハンドル名
        get_template_directory_uri() . '/js/ma-company-filter.js', // JSファイルのパス
        array( 'jquery' ), // 依存ライブラリ
        '1.0',
        true // フッターで読み込み
    );

    // Ajaxに必要なURLやNonceをJSに渡す (原則2: セキュリティ考慮)
    wp_localize_script( 'ma-company-filter', 'maCompanyAjax', array(
        'ajaxurl' => admin_url( 'admin-ajax.php' ),
        'nonce'   => wp_create_nonce( 'ma_company_filter_nonce' ) // Nonceの生成
    ));
}
add_action( 'wp_enqueue_scripts', 'ma_company_enqueue_scripts' );


// 2. 絞り込み検索フォームのショートコード (フロントエンドの表示)
function ma_company_filter_form_shortcode() {
    ob_start(); // バッファリング開始
    ?>
    <div id="ma-company-filter-container">
        <form id="ma-company-filter-form" class="ma-filter-form">
            <fieldset>
                <legend>企業情報 絞り込み</legend>

                <div class="filter-group">
                    <label for="ma_industry_text">業種名:</label>
                    <input type="text" id="ma_industry_text" name="industry" placeholder="例: ITサービス">
                </div>

                <div class="filter-group">
                    <label for="ma_revenue_min">年間売上高 (百万円):</label>
                    <input type="number" id="ma_revenue_min" name="revenue_min" placeholder="最小" min="0">
                    ～
                    <input type="number" id="ma_revenue_max" name="revenue_max" placeholder="最大" min="0">
                </div>

                <div class="filter-group">
                    <label for="ma_stage_select">M&Aステージ:</label>
                    <select id="ma_stage_select" name="stage">
                        <option value="">すべて</option>
                        <option value="検討中">検討中</option>
                        <option value="交渉中">交渉中</option>
                        <option value="基本合意済">基本合意済</option>
                        <option value="成約済">成約済</option>
                    </select>
                </div>

                <button type="submit">検索</button>
                <div id="ma-filter-loading" style="display:none;">検索中...</div>
            </fieldset>
        </form>
        
        <div id="ma-company-results">
            <?php echo ma_company_render_results(); // 初期表示データをロード ?>
        </div>
    </div>
    <?php
    return ob_get_clean();
}
add_shortcode( 'ma_company_filter', 'ma_company_filter_form_shortcode' );


/**
 * 3. 絞り込み検索を実行し、結果のHTMLを返す (Ajaxコールバック)
 * wp_ajax_nopriv_ と wp_ajax_ の両方に登録し、ログイン・非ログインユーザーどちらも使えるようにする。
 */
function ma_company_filter_ajax_handler() {
    // 🚨 セキュリティチェック (原則2, 3)
    // Nonceの検証: 不正なリクエストをブロック
    if ( ! check_ajax_referer( 'ma_company_filter_nonce', 'nonce', false ) ) {
        // エラーレスポンス
        wp_send_json_error( array( 'message' => 'Nonce検証エラー: 不正なリクエストです。' ) );
        wp_die();
    }
    
    // 検索パラメータの取得とサニタイズ
    $industry    = sanitize_text_field( $_POST['industry'] ?? '' );
    $revenue_min = absint( $_POST['revenue_min'] ?? 0 );
    $revenue_max = absint( $_POST['revenue_max'] ?? 0 );
    $stage       = sanitize_text_field( $_POST['stage'] ?? '' );
    
    // 結果のHTMLを生成
    $output = ma_company_render_results( $industry, $revenue_min, $revenue_max, $stage );
    
    // JSON形式でHTMLを返す
    wp_send_json_success( array( 'html' => $output ) );
    
    // 処理の終了
    wp_die();
}
add_action( 'wp_ajax_ma_company_filter', 'ma_company_filter_ajax_handler' );
add_action( 'wp_ajax_nopriv_ma_company_filter', 'ma_company_filter_ajax_handler' );


/**
 * 4. 企業情報を取得し、結果のHTMLを生成する汎用関数
 * @param string $industry 業種名
 * @param int $revenue_min 最小売上高
 * @param int $revenue_max 最大売上高
 * @param string $stage M&Aステージ
 * @return string 結果HTML
 */
function ma_company_render_results( $industry = '', $revenue_min = 0, $revenue_max = 0, $stage = '' ) {
    // WP_Queryの引数を構築
    $args = array(
        'post_type'      => 'ma_company',
        'post_status'    => 'publish',
        'posts_per_page' => 10, // 表示件数
        'orderby'        => 'date',
        'order'          => 'DESC',
    );

    // カスタムフィールドによる絞り込みの配列 (原則5: meta_queryの利用)
    $meta_query = array( 'relation' => 'AND' );

    // 業種での絞り込み (部分一致検索)
    if ( ! empty( $industry ) ) {
        $meta_query[] = array(
            'key'     => '_ma_company_industry',
            'value'   => $industry,
            'compare' => 'LIKE', // 部分一致
            'type'    => 'CHAR',
        );
    }

    // 売上高での絞り込み (数値範囲検索)
    if ( $revenue_min > 0 || $revenue_max > 0 ) {
        // 🚨 エラーハンドリング: 最大値が最小値より小さい場合の調整
        if ($revenue_min > 0 && $revenue_max > 0 && $revenue_min > $revenue_max) {
             $revenue_max = $revenue_min; // 最大値を最小値に合わせる
        }
        
        $value = array();
        if ($revenue_min > 0) $value[] = $revenue_min;
        if ($revenue_max > 0) $value[] = $revenue_max;
        
        if (!empty($value)) {
             $meta_query[] = array(
                'key'     => '_ma_company_revenue',
                'value'   => $value,
                'type'    => 'NUMERIC',
                // 範囲が指定されていればBETWEEN、そうでなければ単一の比較
                'compare' => (count($value) === 2) ? 'BETWEEN' : ((count($value) === 1 && $revenue_min > 0) ? '>=' : '<='), 
            );
        }
    }
    
    // M&Aステージでの絞り込み (完全一致)
    if ( ! empty( $stage ) ) {
        $meta_query[] = array(
            'key'     => '_ma_company_stage',
            'value'   => $stage,
            'compare' => '=',
            'type'    => 'CHAR',
        );
    }

    // meta_queryをクエリに追加
    if ( count( $meta_query ) > 1 ) { // 'relation'だけではない場合
        $args['meta_query'] = $meta_query;
    }

    $query = new WP_Query( $args );
    
    ob_start