# 設計書: 提携パートナーのロールと、自身が登録した案件のみを編集・管理できるRBAC（Role-Based Access Control）の要件を詳細に定義する（WordPressのユーザー権限管理拡張プラグインの利用を前提）。

タスクID: 17
作成日時: 2025-10-05T21:23:04.560424

---

このタスクは、前回の「提携パートナー管理機能の設計」で概要を定義したRBAC（Role-Based Access Control）ロジックを、具体的な実装手順と詳細な技術要素に落とし込むものです。

タスク概要

目的

M&Aポータルサイトの提携パートナー（案件提供者）に対し、自身が登録した案件（カスタム投稿タイプ: ma_case）のみを閲覧・編集・管理できる厳格なロールベースアクセス制御（RBAC）を確立します。これにより、データ隔離とセキュリティを確保し、マルチテナント的な案件管理環境の基礎を築きます。

スコープ

提携パートナー用カスタムロールの具体的な定義。

投稿者ベースのアクセス制御を実現するための技術的フックとロジックの詳細化。

WordPress管理画面およびフロントエンドでの編集権限チェックの定義。

設計内容

1. カスタムロールとケイパビリティの定義

WordPressの標準機能とカスタムロール拡張プラグイン（例: User Role Editor）を利用し、提携パートナー（ma_partner）ロールに、投稿者ベースの権限のみを付与します。

ロール名	表示名	権限 (ケイパビリティ)	備考
ma_partner	提携パートナー	read (フロント閲覧)	サイトの基本的な閲覧権限。
		view_sensitive_data (カスタム)	機密情報（価格など）の閲覧権限（前タスクで定義）。
		upload_files	案件資料のアップロードを許可。
		edit_ma_cases	ma_case CPTの投稿権限。
		edit_published_ma_cases	承認済み案件の編集権限。
管理者ロールからの除外設定		edit_others_ma_cases	絶対に付与しない。 これにより、他者の案件へのアクセスをブロックする。
Google スプレッドシートにエクスポート

2. アクセス制御ロジック（技術的詳細）

RBACの実現は、主にWordPressの2つのフックを利用した二重チェックで行います。

2.1. データ取得・一覧表示の制限（管理画面・フロントエンド）

提携パートナーが案件一覧（wp-admin/edit.php?post_type=ma_case）やフロントエンドのマイページなどで、自身が登録した案件のみを見られるようにするロジックです。

フック: pre_get_posts

処理内容:

現在のユーザーが ma_partner ロールを持っているかチェック。

クエリが管理画面または案件一覧ページ（ma_case CPT）を対象としているかチェック。

条件を満たす場合、$query->set('author', get_current_user_id()); を実行し、現在のユーザーが投稿者である案件のみを強制的にフィルタリングします。

2.2. 編集・削除権限の厳格なチェック（URL直接入力対策）

権限のないユーザーが案件のURLを直接入力して編集を試みるのを防ぐための、最終的なセキュリティ層です。

フック: map_meta_cap

処理内容:

現在のユーザーが ma_partner ロールであるかチェック。

要求されているケイパビリティが edit_post または delete_post（ma_case CPT）であるかチェック。

対象案件（post_id）の post_author が、現在のユーザーIDと一致しない場合、要求されたケイパビリティを**do_not_allow**（許可しない）にマッピングし直します。

これにより、ma_partnerは、自身が投稿していない案件に対する編集・削除アクションを、システムのどの層からも実行できなくなります。

3. ステータス管理との連携

案件のライフサイクルにおけるステータス変更（特に公開/非公開）も、RBACに基づいて制御します。

ユーザーロール	ステータス変更の権限	備考
ma_partner	自身が登録した案件を publish に変更する権限は持たない。	新規登録や編集後の保存は**pending**（承認待ち）ステータスのみに制限（前タスクで定義）。
administrator/ma_reviewer	どの案件でも pending → publish への遷移が可能。	案件の公開承認権限を持つ。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
ロール/ケイパビリティ定義	User Role Editor (URE) または Custom Code	GUIでロールとカスタムケイパビリティを容易に作成し、管理者の運用負荷を軽減するため。
データアクセス制御	PHP Filter pre_get_posts	WordPressのクエリ実行直前の段階で投稿者IDによるフィルタを挿入し、管理画面・フロントエンド双方の案件一覧を効率的かつセキュアに制限するため。
編集権限制御	PHP Filter map_meta_cap	WordPressのコアな権限マッピング機能を利用し、URL直接入力などによる不正な編集・削除リクエストを防止する最終チェックポイントとするため。
Google スプレッドシートにエクスポート

実装における注意点

管理画面のUI調整: pre_get_posts フィルターを適用すると、管理画面の**「すべて」**タブの件数表示などが崩れる場合があるため、表示件数のカウントロジック（parse_queryフックなど）も調整が必要になることがあります。

map_meta_capの優先度: map_meta_capフィルターは非常に強力であるため、他のプラグインやテーマの権限制御ロジックと衝突しないよう、フックの優先度（priority）を調整し、入念にテストを実施すること。

ケイパビリティの一元管理: view_sensitive_data や edit_ma_cases などのカスタムケイパビリティは、プラグインの設定ファイルやカスタムコード内で一元管理し、ロールの付与・剥奪が容易な状態を維持すること。

次のステップ

データ暗号化モジュール詳細設計: これまで設計してきたセキュリティとRBACを機能させるための、機密情報の暗号化・複合化ロジックと鍵管理の詳細を定義する。

UI/UX画面設計（提携パートナー向け）: 定義されたRBACに基づき、ma_partnerが見る案件登録・編集フォーム、一覧画面、および管理者側の承認画面の具体的なワイヤーフレームを設計する。

API仕様の定義（REST API）: 将来的な外部連携に備え、RBACロジックを考慮に入れた案件情報取得用REST APIのエンドポイントと認証要件の概要を定義する。