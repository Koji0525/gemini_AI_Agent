# 設計書: 提携パートナー管理機能の具体的な仕様定義書作成（WordPressユーザーロール設計、案件登録/編集フォーム、アクセス制御の実現方法）。

タスクID: 38
作成日時: 2025-10-05T21:55:26.842487

---

💡以前の設計と重複していますが、最新の要件に基づき、提携パートナー管理機能の最終設計を再提出します。

タスク概要

目的

M&Aポータルにおける提携パートナー（案件の出し手）が自身の案件を安全に登録、編集、管理するための機能仕様を定義します。具体的には、専用のWordPressユーザーロール（ma_partner）、案件のフロントエンドフォームの仕様、および投稿者ベースのアクセス制御（RBAC）の実装方法を明確にします。

スコープ

専用ユーザーロールma_partnerのカスタムケイパビリティの定義。

案件のCRUD操作を可能にするフロントエンドフォームの構成と動作。

パートナーが自身の案件のみを操作できるアクセス制御（pre_get_posts, map_meta_cap）の実装仕様。

設計内容

1. ユーザーロール設計: ma_partner

提携パートナー（案件の作成者）には、自身の案件（ma_case CPT）に対する操作権限のみを限定的に付与し、管理画面の広範なアクセスを遮断します。

Keicapability (ケイパビリティ)	権限レベル	備考
read	WordPress標準	全体のコンテンツ閲覧権限。
read_ma_case	CPTカスタム	自身の ma_case 投稿タイプを閲覧する権限。
edit_ma_case	CPTカスタム	自身の ma_case を編集する権限。
delete_ma_case	CPTカスタム	自身の ma_case を削除する権限。
view_sensitive_data	カスタムケイパビリティ	**機密データ（価格など）**を複合化して閲覧する権限。
upload_files	WordPress標準	案件資料などをアップロードする権限。
Google スプレッドシートにエクスポート

ロールの制限: ma_partnerには、WordPress管理画面へのログインは許可しますが、コアな管理メニュー（テーマ、プラグイン、ユーザー管理など）へのアクセスは全て拒否します。

2. 案件登録/編集フォーム（フロントエンド）

案件の登録・編集は、セキュリティ担保とUX統一のため、必ず専用のフロントエンドフォームを通じて行います。

フォーム要素	項目名（メタキー）	制御	備考
タイトル	post_title	必須入力	案件の識別名。
業種/地域	Taxonomy	必須入力 (プルダウン/チェックボックス)	既に定義されたカスタムタクソノミーを操作。
価格/財務	price_amount, latest_revenue	必須入力 (数値)	暗号化対象フィールド。入力値は保存時に自動暗号化。
財務詳細	financial_data	任意入力 (リピーター)	JSON/配列として格納されるフィールド。
譲渡理由	transfer_reason	必須入力 (テキストエリア)	
ステータス	post_status	制御 (非表示)	登録時はpending（承認待ち）に、編集時は現在のステータスを維持。パートナーによるステータス変更は不可。
Google スプレッドシートにエクスポート

フォームの編集動作:

フォームロード時、編集対象案件のデータをget_post_metadata経由で取得。暗号化フィールドの値は複合化してフォームに表示されます。

データ送信時、wp_insert_post()またはwp_update_post()を使用。post_authorは必ずログイン中のパートナーIDで上書き（またはチェック）されます。

3. アクセス制御の実装（投稿者ベースRBAC）

パートナーが自身の作成した案件のみを操作できるように、投稿者ベースのアクセス制御をWordPressコアフックを利用して強制します。

制御対象	実装フック	ロジック概要	備考
案件一覧制限	pre_get_posts	ログインユーザーがma_partnerロールの場合、WP_Queryのauthorパラメータに**current_user_id()**を設定し、クエリを強制的にフィルタリング。	他のパートナーの案件が一覧に表示されるのを防ぐ。
編集/削除制限	map_meta_cap	ユーザーがedit_ma_caseまたはdelete_ma_caseを要求した際、対象案件のpost_authorとcurrent_user_idを比較。不一致の場合は**権限を拒否（do_not_allow）**する。	URLを直接叩かれた際の不正編集・削除を防ぐ。
機密データ制限	get_post_metadata	暗号化モジュール内で、複合化前にcurrent_user_can('view_sensitive_data')をチェック。	機密データが非権限ユーザーに誤って複合化されるのを防ぐ。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
ユーザーロール/権限	PHP (add_role, add_cap, map_meta_cap)	WordPressのコア機能を利用した、最も堅牢で信頼性の高い権限管理方法。
フォーム管理	Advanced Custom Fields (ACF) Pro	リピーターやグループフィールド（financial_data）の扱いが容易であり、迅速な開発を可能にする。セキュリティ要件の高いバックエンド処理はカスタムPHPで対応。
投稿者ベース制御	pre_get_posts / map_meta_cap	WordPressクエリと権限チェックの最も深い層に介入し、強制的なアクセス制御を実現するための標準的かつ最良のフック。
Google スプレッドシートにエクスポート

実装における注意点

セキュリティ（NONCE）: フロントエンドフォームからのデータ送信処理には、必ずWordPress NONCE（ワンタイムトークン）によるCSRF対策をサーバーサイドで実装すること。

ダブルチェック: フォームのUIで項目を非表示（例: ステータス）にするだけでなく、データ送信時には必ずサーバーサイドで権限・データの整合性をチェックし、不正な値（post_statusの不正変更など）を破棄または上書きすること。

フックの優先度: 暗号化モジュール（get_post_metadata）のフックと、フォーム処理を行うプラグイン（ACFなど）のフックが競合しないよう、add_filter()の優先度（Priority）を厳密に定義し、テストすること。

編集時の複合化: 編集フォームでは、暗号化モジュールがデータを複合化した後、ACFがその値をロードする必要があります。このフローが、非権限ユーザーに対しても安全に動作することを徹底的に確認すること。

次のステップ

UI/UX画面設計 (required_role: ui): 案件の登録/編集フォーム、提携パートナー専用ダッシュボード、および案件一覧画面のワイヤーフレームと操作フローを設計する。

API仕様の定義（REST API） (required_role: design): 案件情報、検索、閲覧履歴を含む、全機能統合型のREST API仕様を最終確定し、フロントエンド開発を可能にする。

コアモジュールの統合開発