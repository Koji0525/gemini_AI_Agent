# 設計書: 検索機能仕様（検索対象、UIの振る舞い、ソート機能）の詳細を要件定義書の第2章に記述する。

タスクID: 13
作成日時: 2025-10-05T21:14:41.276229

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトの検索機能仕様の詳細を定義します。これは、ユーザー体験とサイト利用率に直結する中核機能です。

タスク概要

目的

定義された企業情報データ構造（CPT/CF/CT）に基づき、ユーザーが目的のM&A案件を効率的に絞り込み、一覧表示するための具体的な検索機能仕様を定義します。価格帯レンジ検索、カスタムタクソノミー検索、および検索結果のソート機能に焦点を当てます。

スコープ

検索対象となるデータ項目と、それぞれの検索ロジックの定義。

検索フォームの構成とUIの振る舞い。

検索結果の表示仕様（ページネーション、表示件数）。

ソートオプションとその実現方法。

設計内容

1. 検索対象項目と検索ロジック

検索は、WordPressの標準機能（WP_Query）を拡張し、主にtax_query（カスタムタクソノミー）とmeta_query（カスタムフィールド）を用いて実現します。

検索項目	格納先（データ型）	検索ロジック	備考
キーワード	post_title, post_content (文字列)	部分一致（標準sクエリ）	案件名および譲渡理由（フリーテキスト）を対象。
業種カテゴリ	industry (カスタムタクソノミー)	完全一致/AND・OR選択	選択された複数の業種タグをOR条件で検索。
所在地	location (カスタムタクソノミー)	完全一致/AND・OR選択	都道府県または市区町村を選択。階層構造を考慮。
M&Aスキーム	ma_scheme (カスタムタクソノミー)	完全一致/AND・OR選択	株式譲渡、事業譲渡など。
希望価格帯	price_amount (数値)	レンジ検索 (BETWEEN)	ユーザー入力の最小値・最大値を用いた数値比較。
Google スプレッドシートにエクスポート

価格帯レンジ検索の具体的なクエリ仕様

UI: 検索フォームには、最小価格（Min: min_price）と最大価格（Max: max_price）の入力フィールドを設けます。

ロジック: $min_price と $max_price を利用し、WP_Queryのmeta_queryで以下の条件を適用します。

PHP
// price_amountが $min_price と $max_price の間にある案件を検索
$args['meta_query'][] = array(
    'key'     => 'price_amount',
    'value'   => array( $min_price, $max_price ),
    'type'    => 'NUMERIC', // 数値として厳密に比較
    'compare' => 'BETWEEN',
);


2. 検索フォーム (UI) の振る舞い

入力形式:

キーワード: 任意のテキスト入力フィールド。

タクソノミー: チェックボックスまたはマルチセレクトボックス（複数選択を許可）。

価格帯: 最小値と最大値の数値入力フィールド。

初期状態: 検索項目は全て空、または推奨値（価格帯は「全価格帯」など）が設定されます。

絞り込み: ユーザーが検索を実行すると、選択された条件が全てAND条件として組み合わされ、結果一覧が更新されます（ファセット検索の概念）。

3. 検索結果の表示仕様とソート機能

項目	仕様詳細	実現方法
投稿タイプ	ma_case のみを対象とする。	post_type パラメータで固定。
除外条件	進捗ステータスが「成約済」または「下書き」「承認待ち」の案件は除外する。	tax_query または post_status で制御。
表示件数	20件/ページ	posts_per_page パラメータで固定。
ページネーション	必須。検索条件を維持したままページ遷移が可能であること。	paginate_links() 関数またはプラグイン機能を利用。
デフォルトソート	新着順	orderby=date, order=DESC
ソートオプション	以下の3つのオプションを提供。	WP_Queryのorderbyとmeta_keyパラメータで制御。
Google スプレッドシートにエクスポート

ソート機能の具体的ロジック

ソート項目	WP_Query パラメータ	備考
新着順	orderby=date, order=DESC	標準の投稿日（最新）順。
価格順	orderby=meta_value_num, meta_key=price_amount, order=ASC/DESC	**meta_value_num**を指定し、数値としてソートを保証。
更新日順	orderby=modified, order=DESC	案件情報が最後に更新された日時順。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
コア検索機能	WP_Query	WordPressネイティブのクエリ機能を利用することで、tax_queryとmeta_queryによる複雑な絞り込み検索（特にレンジ検索）を確実に実現するため。
検索UI/UX	Search & Filter Pro または FacetWP	WP_Queryの複雑なクエリをGUIで設定でき、価格レンジ検索や複数タクソノミー選択といった高度な絞り込みUIを迅速に実装し、開発負荷を軽減するため。
データ整合性	MySQL meta_value_num	price_amountの数値比較・ソートを正確に行うため、カスタムフィールドの値をDBに数値型として格納する前提（前タスクで定義済み）を利用する。
Google スプレッドシートにエクスポート

実装における注意点

パフォーマンスボトルネック: meta_queryはデータ量が増えるとパフォーマンスが低下しやすい。price_amountには必ずMySQLの適切なインデックスを設定し、応答速度を確保すること。

セキュリティとデータマスキング: 検索結果一覧に表示されるprice_amountは、アクセス制御の仕様に基づき、特定権限のないユーザーには具体的な金額が表示されないよう、テーマテンプレートレベルではなく、データ取得時（WP_Queryフック）でマスキングするロジックを適用すること。

空値の扱い: 価格帯検索において、min_priceまたはmax_priceが空の場合、クエリ条件を適切に除外するロジック（例: min_priceのみ指定なら $price >= min_price）をPHP側で実装すること。

次のステップ

提携パートナー管理機能の設計: 案件の登録、編集、およびセキュリティ（RBAC）に関する具体的な機能仕様の設計を開始する。これは検索結果のデータソースを管理する重要な機能である。

UI/UX設計（ワイヤーフレーム）: 定義された検索項目とソートオプションに基づき、検索フォームと結果一覧画面のワイヤーフレームおよびUIデザインの定義を作成する。

データ暗号化モジュール詳細設計: 機密情報（価格など）の暗号化・複合化ロジックの詳細設計を早期に完了させる。