# 設計書: 非公開情報（具体的な価格、財務情報）の表示制御について、Wordpressのユーザーログイン状態と権限（RBAC）に基づくアクセス制御の仕様を定義書に記述する。

タスクID: 48
作成日時: 2025-10-06T19:57:40.065994

---

タスク概要

目的

WordPress上で、非公開情報（価格、財務情報など）へのアクセスを、**ユーザーのログイン状態と権限（RBAC: Role-Based Access Control）**に基づいて厳密に制御するためのシステム仕様を定義する。これにより、情報セキュリティとデータの機密性を確保しつつ、必要なユーザーのみが情報にアクセスできるようにする。

対象情報

特定のカスタム投稿タイプ（例：private_data）に保存される投稿/記事

特定のカスタムフィールド（例：_financial_value）に保存されるデータ

特定のREST APIエンドポイントから取得されるデータ

設計内容

1. アクセス制御の基本原則

制御レベル	ユーザー状態	権限レベル	アクセス可否
未ログイン	ログアウト	N/A	拒否
一般登録	ログイン済	subscriber など	拒否
限定公開	ログイン済	editor または専用カスタムロール (private_viewer)	許可
完全公開	ログイン済	administrator	許可
Google スプレッドシートにエクスポート

2. 権限（Role-Based Access Control: RBAC）の定義

ロール名（Slug）	WordPress標準機能	主な機能（今回のタスク関連）
administrator	標準（管理者）	全ての非公開情報にアクセス可能
editor	標準（編集者）	アクセスレベル1（限定的な非公開情報）までアクセス可能
private_viewer	カスタムロール	アクセスレベル2（特定の非公開情報）のみ閲覧可能
subscriber	標準（購読者）	非公開情報へのアクセスは不可
Google スプレッドシートにエクスポート

3. データ制御の実装仕様

3.1. フロントエンド（投稿/記事）の表示制御

フックの利用: WordPressのループ処理前（例：pre_get_posts）または記事表示前（例：the_contentフィルター）で制御を行う。

実装ロジック:

現在アクセスしているユーザーがログインしているかを確認する（is_user_logged_in()）。

ログインしている場合、**必要な権限（current_user_can('private_viewer')など）**を持っているかを確認する。

ユーザーが権限を持っていない場合、以下の処理を行う。

記事全体の場合: 投稿を表示せずに404 Not Foundとするか、ログイン/権限不足メッセージを表示する。

記事内の特定カスタムフィールドの場合: 当該カスタムフィールドの値を空にするか、[非公開情報]などのプレースホルダに置き換える。

3.2. REST APIエンドポイントのアクセス制御

フックの利用: REST APIルート登録時またはコールバック関数内で制御を行う。

実装ロジック:

カスタムREST APIエンドポイントのコールバック関数内で、current_user_can('read_private_data')などの権限チェックを最初に実行する。

権限がない場合、APIレスポンスとしてHTTPステータスコード 403 Forbiddenを返し、データアクセスを拒否する。

権限がある場合のみ、データを取得し、JSONレスポンスを返す。

技術選定

技術/コンポーネント	選定理由
WordPress Core Function	is_user_logged_in()、**current_user_can()**などの標準関数を利用することで、既存のセキュリティモデルに準拠し、実装の信頼性が高まる。
Custom Role & Capability	標準の**add_role()とadd_cap()を使用して、private_viewer**のようなカスタムロールと権限を定義する。これにより、柔軟で明確なRBAC管理が可能になる。
pre_get_posts Action Hook	クエリ実行前に処理を行うことで、表示する記事自体を制御でき、非公開情報が誤って公開されるのを防ぐセキュリティ上の強固な層となる。
WP REST API Authentication	標準のCookie/Nonce認証を利用する。カスタムAPIキー認証は、セキュリティ実装の複雑性が増すため、今回は既存のWordPress認証機構を信頼し、強化する。
Google スプレッドシートにエクスポート

実装における注意点

二重チェック: アクセス制御は、サーバーサイド（バックエンド）で必ず行うこと。クライアントサイド（JavaScriptなど）での表示/非表示制御は、セキュリティ対策として不十分である。

サニタイズ/エスケープ: データベースから取得したデータや、ユーザー権限に依存する制御ロジックは、常に適切なサニタイズ・エスケープ処理を適用し、SQLインジェクションやクロスサイトスクリプティング（XSS）などの脆弱性を防ぐ。

キャッシュ制御: 非公開情報を扱うページは、Varnish, Redis, WordPressのオブジェクトキャッシュプラグインなどによる外部キャッシュを避けるか、ユーザー単位でのキャッシュ（Authenticated Cache）を適切に設定する。未ログインユーザー向けのキャッシュに、誤って機密情報が含まれないように注意する。

権限のスラッグ: カスタム権限（Capability）のスラッグは、一意で推測されにくいもの（例：read_financial_report）を使用し、他のプラグインとの衝突を避ける。

次のステップ

詳細なカスタムロール・権限定義: 定義したカスタムロール（private_viewer）に対して、具体的な権限（read_private_data, edit_private_dataなど）の一覧と、どの投稿タイプ/フィールドに適用するかを詳細にマッピングする。

データベーススキーマの設計: 非公開情報が保存されるカスタム投稿タイプやカスタムフィールドの定義（フィールド名、データ型）を具体的に設計する。

APIエンドポイントの定義: 非公開情報を取得するための具体的なREST APIエンドポイント（URL、メソッド、必須パラメータ、レスポンス構造）を定義する。

セキュリティ監査計画: 実装後のアクセス制御機能について、権限昇格のテストや認証バイパスのテストを含むセキュリティ監査（ペネトレーションテスト）計画を策定する。