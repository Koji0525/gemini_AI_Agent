# 設計書: 検索機能の要件（検索対象、ソート、セキュリティ）に基づき、利用するWordpressプラグイン（例: SearchWP, FacetWP）の選定と仕様（カスタムフィールド連携）を定義する。

タスクID: 46
作成日時: 2025-10-06T19:22:58.309383

---

タスク概要

目的

Wordpressサイトに、投稿記事（カスタム投稿タイプを含む）、固定ページ、カスタムフィールドを対象とした高性能で柔軟な検索機能と、結果の**ソート・絞り込み（ファセット）**機能を実現する。セキュリティとスケーラビリティを考慮し、最適な検索プラグインを選定し、その連携仕様を定義する。

要件

検索対象: 投稿、固定ページに加え、特定のカスタム投稿タイプ（例: product）およびカスタムフィールド（例: price, sku）を対象に含めること。

ソート: 検索結果を「関連度（デフォルト）」、「日付（新しい順/古い順）」、「価格（カスタムフィールド）」でソートできること。

セキュリティ: 検索フォームからのSQLインジェクションなどの脆弱性を防止すること。

絞り込み（ファセット）: カテゴリ、タグ、カスタムタクソノミー（例: brand）で結果を絞り込めること。

設計内容

1. プラグイン選定

カテゴリ	選定プラグイン	理由
検索エンジン	SearchWP	非常に柔軟なインデックス機能を提供し、カスタムフィールドやカスタムタクソノミーを検索対象として容易に追加・重み付けできるため。結果のソート機能（特にカスタムフィールドでのソート）にも対応。
絞り込み/ファセット	FacetWP	SearchWPとの連携が公式にサポートされており、高い互換性を持つ。タクソノミー、カスタムフィールド、日付範囲など多岐にわたるファセット（絞り込み）機能の実装が容易であるため。
Google スプレッドシートにエクスポート

2. SearchWP 連携仕様（インデックス設定）

設定項目	値	目的
検索エンジン	Default	基本検索エンジンとして設定
対象投稿タイプ	post, page, product (例)	要件に基づく検索対象の明確化
ソース/属性	Title (10), Content (5), Slug (2)	基本的な重み付け（Titleを最も重視）
カスタムフィールド	price (2), sku (3), description_short (5)	カスタムフィールドを検索対象に含め、skuを比較的重く設定
カスタムタクソノミー	category, tag, brand (例)	タクソノミー名も検索対象に含める
Google スプレッドシートにエクスポート

3. ソート機能実装仕様

SearchWPのソート機能を利用し、以下のソートオプションを検索結果ページに実装する。

ソートオプション	SearchWP設定/実装方法
関連度	デフォルトのソート順（重み付けに基づく）
日付	orderby=date, order=DESC/ASC
価格	orderby=_price (カスタムフィールド名)
Google スプレッドシートにエクスポート

4. FacetWP 連携仕様（ファセット設定）

以下のファセットを検索結果ページのサイドバー等に配置する。

ファセットタイプ	対象 (Data Source)	表示形式	目的
カテゴリ	Taxonomy: category	チェックボックス	標準カテゴリによる絞り込み
ブランド	Taxonomy: brand	ドロップダウン	カスタムタクソノミーによる絞り込み
価格帯	Custom Field: price	スライダー	価格カスタムフィールドの値による範囲絞り込み
Google スプレッドシートにエクスポート

技術選定

技術/ツール	理由
WordPress	システム基盤。
SearchWP	高機能なインデックス作成とカスタムフィールドへの対応が決定的な選定理由。デフォルトのWordPress検索よりも高速で柔軟な検索スコアリングが可能。
FacetWP	SearchWPとのシームレスな連携と、AJAXによる高速な絞り込みを実現できる点。ユーザーエクスペリエンスの向上に不可欠。
PHP/MySQL	WordPressの標準開発言語およびデータベース。
JavaScript/AJAX	FacetWPが利用する技術。検索結果のリアルタイム更新（リロードなし）を実現し、ユーザー体験を向上させる。
Google スプレッドシートにエクスポート

実装における注意点

SearchWPインデックス再構築: 設定変更後、または大規模なデータインポート後は、必ずSearchWPのインデックスを再構築し、最新のデータが検索可能であることを確認すること。

カスタムフィールドのデータ型: 価格（price）などのカスタムフィールドは、FacetWPで数値範囲のファセットとして使用するため、データベース上で数値として正しく保存されていることを確認する（ACFやMeta Box利用時は設定に注意）。

セキュリティ: プラグインが標準でセキュリティ対策（SQLインジェクション防止など）を講じているが、独自の検索クエリやフックを使用する場合は、$wpdb->prepare()や適切なエスケープ処理を厳格に適用すること。

パフォーマンス: 大量のカスタムフィールドをインデックスに含めすぎると、インデックス作成時間やディスク容量に影響が出る可能性があるため、検索に真に必要なフィールドのみを含めること。

UI/UX: ソート・ファセット機能を実装する際は、ユーザーが直感的に操作できるように、検索結果ページへの配置とデザインに配慮すること。

次のステップ

環境構築: 開発環境にWordPress、SearchWP、FacetWPをインストールし、ライセンスを有効化する。

基本実装: SearchWPで基本的なインデックス設定（投稿タイプ、主要フィールド）を完了し、デフォルトの検索が機能することを確認する。

ファセット実装: FacetWPでカテゴリ、ブランド、価格帯のファセットを作成し、検索結果ページに表示する実装を行う。

ソート機能実装: 価格カスタムフィールドでのソートが正しく機能するように、テーマファイルまたはプラグインのフックを使用してソートロジックを実装する。

テスト計画: 動作検証のため、上記の要件に基づくテストケース（検索、ソート、絞り込み）を作成する。