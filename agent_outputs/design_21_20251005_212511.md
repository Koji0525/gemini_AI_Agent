# 設計書: M&A案件のカスタム投稿タイプ、カスタムタクソノミー（ma_scheme, industry, locationなど）、およびカスタムフィールド（price_amountなど）の具体的なデータベーススキーマ定義書を作成する。

タスクID: 21
作成日時: 2025-10-05T21:25:11.758282

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトのコアデータ構造であるカスタム投稿タイプ（CPT）、カスタムタクソノミー（CT）、およびカスタムフィールド（CF）の具体的なデータベーススキーマ定義書を作成します。これは、案件データの永続的な保存と整合性を保証する基盤です。

タスク概要

目的

これまでの要件定義に基づき、WordPressのデータベース構造（主に標準テーブルとカスタムテーブル）に案件データをどのように格納するかを具体的に定義します。特に、カスタムフィールドのデータ型、インデックス設定、およびカスタムタクソノミーとの関係性を明確にします。

スコープ

案件データ格納に使用される主要なWordPress標準テーブル（wp_posts, wp_postmeta, wp_termsなど）における役割の定義。

カスタムフィールド（CF）の格納（wp_postmeta）における具体的なキー名、データ型、およびインデックス設定。

カスタムタクソノミー（CT）のスキーマ定義。

閲覧履歴機能用のカスタムテーブル（wp_ma_view_log）のスキーマ定義。

設計内容

WordPressは標準のテーブル構造を利用するため、カスタムフィールドとカスタムタクソノミーは主に既存のテーブルに追加のレコードとして格納されます。

1. カスタム投稿タイプ (CPT: ma_case) のスキーマ定義

テーブル名	wp_posts	備考
ID	BIGINT(20) UNSIGNED	案件ID（プライマリキー）。
post_author	BIGINT(20) UNSIGNED	提携パートナーのユーザーID（RBACの基盤）。
post_date	DATETIME	案件の登録日時。
post_content	LONGTEXT	譲渡理由（フリーテキスト）。
post_title	VARCHAR(255)	案件名。
post_status	VARCHAR(20)	案件ステータス（pending, publish, closedなど）。
post_type	VARCHAR(20)	固定値として**ma_case**を格納。
Google スプレッドシートにエクスポート

2. カスタムフィールド (CF) のスキーマ定義（wp_postmeta）

カスタムフィールドは全てこのテーブルに格納されます。検索・ソートに必須の数値データは、インデックスと**meta_value_num**の利用を前提とします。

メタキー名	格納データ型 (PHP)	DB格納型 (meta_valueの物理型はLONGTEXT)	インデックスの必要性	備考
price_amount	float/int	数値 (暗号化された文字列)	必須 (meta_key/meta_value_num)	機密情報。 データベースには暗号化された文字列として格納。検索・ソートはカスタムロジックで処理。
price_range_text	string	文字列	不要	一般公開用テキスト表示。
start_date	string (YYYY-MM-DD)	文字列	不要	掲載期間開始日。
end_date	string (YYYY-MM-DD)	文字列	不要	掲載期間終了日。
employees_count	int	文字列	推奨 (meta_key/meta_value_num)	従業員数。ソート対象になり得る。
financial_data	array/JSON string	文字列 (暗号化された文字列)	不要	機密情報。 財務データのRepeater（繰り返しフィールド）をJSON化して格納。
Google スプレッドシートにエクスポート

3. カスタムタクソノミー (CT) のスキーマ定義

以下のタクソノミーは、wp_terms, wp_term_taxonomy, wp_term_relationshipsの標準テーブル群を利用します。

タクソノミ名	階層構造	関連 CPT	備考
ma_scheme	なし	ma_case	株式譲渡、事業譲渡など。検索フィルタとして使用。
industry	なし	ma_case	業種分類。検索フィルタとして使用。
location	あり	ma_case	都道府県/市区町村。階層検索に利用。
status	なし	ma_case	案件ワークフローの状態（公開中、成約済）。
Google スプレッドシートにエクスポート

4. カスタムテーブル：案件閲覧履歴

大量のログデータによる標準テーブルの肥大化を避けるため、閲覧履歴用にカスタムテーブルを定義します。

テーブル名	wp_ma_view_log	備考
log_id	BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT	ログID (Primary Key)。
user_id	BIGINT(20) UNSIGNED NOT NULL	閲覧した提携パートナーのID。
post_id	BIGINT(20) UNSIGNED NOT NULL	閲覧された案件（ma_case）のID。
view_timestamp	DATETIME NOT NULL	閲覧日時。
Primary Key	log_id	-
Indexes	user_id, post_id, view_timestamp	効率的な検索、期間指定、およびユーザーごとの履歴取得のためにインデックスを定義。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
コアデータ格納	WordPress 標準データベース構造	CPT/CT/CFの管理に標準テーブル（wp_posts, wp_postmeta, wp_termsなど）を利用し、既存プラグイン（ACF, CPT UI）との互換性を最大化するため。
閲覧履歴ログ	MySQL カスタムテーブル	大量のアクセスログによる wp_postmeta の肥大化を防ぎ、ログデータの高速な挿入・検索を実現するため。
検索・ソート効率	MySQL meta_key + meta_value_num インデックス	数値データ（price_amount, employees_count）の範囲検索およびソートにおいて、データベースレベルでの効率を確保するため。
Google スプレッドシートにエクスポート

実装における注意点

暗号化データの検索・ソート処理: price_amountはDBに暗号化された文字列として格納されるため、標準のmeta_value_numインデックスは利用できません。検索・ソート機能は、**カスタムロジック（暗号化/複合化処理）**を伴うWP_Queryフック（例: posts_join, posts_where）で処理するか、**外部検索エンジン（Elasticsearch）**の利用を検討すること。

カスタムテーブルの管理: wp_ma_view_logは、プラグインのアクティベート時に**dbDelta関数**を用いて安全に作成すること。また、データクレンジングのCRONジョブ（古いログの削除）の実装を忘れないこと。

データ整合性: CPT ma_case の登録・更新時、**post_author**に提携パートナーIDが確実に格納されることを担保すること。これはRBACの技術的な基盤です。

次のステップ

データ暗号化モジュール詳細設計: これまで最重要課題としてきた機密情報保護のため、暗号化・複合化ロジック、鍵管理、およびフックポイントの詳細を定義する。この設計が完了すれば、実装フェーズへ移行できる。

UI/UX画面設計: 定義された機能（RBAC、ワークフロー）に基づき、案件登録・編集フォーム、一覧画面、および管理者側の承認画面の具体的なワイヤーフレームを設計する。