# 設計書: 提携パートナー管理機能の具体的な仕様定義書作成（WordPressユーザーロール設計、案件登録/編集フォーム、アクセス制御の実現方法）。

タスクID: 36
作成日時: 2025-10-05T21:52:28.688647

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトにおける提携パートナー管理機能の詳細仕様を定義します。この設計は、先に定義したRBACとカスタム投稿タイプを統合し、ユーザーインターフェースと権限管理の基盤を確立します。

タスク概要

目的

提携パートナー（案件の出し手）が自身の案件を安全に登録、編集、管理するための機能仕様を定義します。具体的には、専用のWordPressユーザーロール（ma_partner）の設計、案件のCRUD操作を可能にするフロントエンドフォームの仕様、およびアクセス制御（RBAC）の実装方法を明確にします。

スコープ

専用ユーザーロールma_partnerのケイパビリティ定義。

案件の登録・編集を可能にするフロントエンドフォームの仕様。

パートナーが自身の案件のみにアクセス・編集できる「投稿者ベースのアクセス制御」の実装方法。

設計内容

1. ユーザーロール設計: ma_partner

提携パートナーには、自身が作成した案件（ma_case CPT）に対してのみ、限定的な権限を付与します。

Keicapability (ケイパビリティ)	権限レベル	備考
read	WordPress標準	全体のコンテンツ閲覧権限。
read_ma_case	CPTカスタム	ma_case投稿タイプを閲覧する権限（自身の案件のみ）。
edit_ma_case	CPTカスタム	ma_caseを編集する権限。
edit_published_ma_cases	CPTカスタム	公開中のma_caseを編集する権限。
view_sensitive_data	カスタムケイパビリティ	**機密データ（価格など）**を複合化して閲覧する権限。
upload_files	WordPress標準	案件資料などをアップロードする権限。
Google スプレッドシートにエクスポート

ロール定義: ma_partnerロールには上記のケイパビリティを付与し、他の管理画面アクセス権（例: ユーザー管理、プラグイン管理など）は一切付与しません。

2. 案件登録/編集フォーム（フロントエンド）

セキュリティとUXの観点から、案件の登録・編集は必ずWordPress管理画面ではなく専用のフロントエンドフォームを通じて行います。

フォーム要素	項目名（メタキー）	制御	備考
タイトル	post_title	必須入力	案件の識別名。
業種	industry (Taxonomy)	必須入力 (プルダウン)	標準のcategory/tagと同様にタクソノミー項目を操作。
従業員数	employees_count	必須入力 (数値)	カスタムフィールド。数値バリデーション必須。
希望譲渡価格	price_amount	必須入力 (数値)	暗号化対象フィールド。入力値は保存時に自動暗号化。
財務詳細データ	financial_data	任意入力 (リピーター)	JSON/配列として格納されるカスタムフィールド。
譲渡理由	transfer_reason	必須入力 (テキストエリア)	
ステータス	post_status	制御 (非表示)	フォームからは操作させず、登録時はpending（承認待ち）に固定。
Google スプレッドシートにエクスポート

フォームの動作:

登録時: フォームのデータはwp_insert_post()関数を通じて送信され、post_typeはma_case、post_authorはログイン中の**ma_partnerのユーザーID**に設定されます。

編集時: 編集権限チェックを行い、成功した場合のみ既存のカスタムフィールド値をフォームにロードします。この際、暗号化フィールドの値は複合化してフォームに表示する必要があります。

3. アクセス制御の実装（投稿者ベース）

提携パートナーが自身の案件のみを編集・閲覧できるように、コアなWordPressフックを利用して強制的なアクセス制御を実装します。

制御対象	実装フック	ロジック	備考
案件一覧	pre_get_posts	ログインユーザーがma_partnerロールの場合、authorパラメータに自身のユーザーIDを設定し、他のユーザーの案件を除外する。	管理画面・フロントエンドの案件一覧に適用。
案件編集	map_meta_cap	ユーザーがedit_ma_caseを要求した際、編集対象のpost_authorが自身のユーザーIDと一致するかを確認。不一致なら権限を拒否する。	投稿画面へのアクセス制御に必須。
機密データ表示	get_post_metadata	既に設計済みの暗号化モジュール内ロジック。**view_sensitive_data**ケイパビリティの有無で複合化を制御。	権限のないユーザーには暗号化されたデータ（または空の値）が返される。
Google スプレッドシートにエクスポート

技術選定

分野	技術	選定理由
ユーザーロール管理	PHP (add_role, add_cap)	WordPressのコア機能を利用し、ma_partnerロールとカスタムケイパビリティを永続的に定義する。
フォーム実装	Advanced Custom Fields (ACF) Pro または カスタムPHPコード	ACFはリピーターフィールド（financial_data）や柔軟な入力インターフェースの実装が容易。セキュリティ要件が厳しい場合はカスタムPHPコードで実装。
アクセス制御	WordPressフック (pre_get_posts, map_meta_cap)	WordPressのコアな処理フローに介入し、権限を細かく制御するための最も確実で標準的な方法。
Google スプレッドシートにエクスポート

実装における注意点

セキュリティ（NONCE）: フロントエンドフォームからのデータ送信時には、必ず**WordPress NONCE（ワンタイムトークン）**の検証を行うロジックを実装し、CSRF（クロスサイトリクエストフォージェリ）攻撃を防ぐこと。

暗号化/複合化のフック順序: 編集フォームで暗号化された値を複合化して表示し、保存時に再暗号化する際、標準のメタデータフック（get_post_metadata/update_post_metadata）がACFなどのフォーム処理と衝突しないよう、フックの優先度（Priority）を厳密に管理すること。

データバリデーション: price_amountやemployees_countなどの数値フィールドは、DB保存前にサーバーサイドで厳密な型チェックと範囲チェックを行い、不正なデータやXSSの混入を防ぐこと。

UIの制限: 提携パートナー向けのフォームでは、案件のステータス変更（例: 公開→非公開）や他のユーザーが作成した案件のID変更など、本来許可されない操作をHTML/JSで非表示にするだけでなく、必ずサーバーサイドの権限チェックで制御すること。

次のステップ