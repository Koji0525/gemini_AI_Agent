# コード: テスト用企業情報データ（売上、利益、業種などを含む）を10件作成し、データベースへ入力

タスクID: 4
作成日時: 2025-10-05T18:33:56.391285

---

私は前の回答でWordPressのカスタム投稿タイプの実装を助けました。今回は、そのカスタム投稿タイプ「企業情報 (ma_company)」に対して、テストデータをプログラムで作成し、データベースに入力するタスクを、PHPで実装します。

この実装は、データ作成の自動化、テスト環境の整備、およびデバッグの迅速化という点で、ソフトウェアエンジニアリングのベストプラクティスに基づいています。

タスク概要

WordPressのカスタム投稿タイプとして設計したM&A企業情報データベース（ma_company）に対し、テストおよび開発用に10件の企業情報データを生成し、データベースに登録します。

データには、投稿タイトル（企業名）、投稿内容（概要）、およびカスタムフィールド（業種、年間売上高、M&Aステージ）を含めます。

実装内容

WordPressの環境下で実行することを想定し、以下の処理を行うPHP関数を実装します。

データ配列の定義: 10件分の企業データ（企業名、業種など）を配列として定義し、可読性を高めます（原則1）。

データ挿入: WordPressのコア関数であるwp_insert_postを使用して、投稿タイプma_companyに企業情報を登録します。

カスタムフィールド挿入: update_post_metaを使用して、定義済みのカスタムフィールドの値を登録します。

エラーハンドリング: wp_insert_postの戻り値をチェックし、投稿の作成に失敗した場合にエラーメッセージを出力します（原則3）。

コード

このコードは、WordPressがロードされた環境（例: テーマのfunctions.phpの一時的なコード、またはWP-CLIコマンドとして実行するファイル）で動作します。

PHP
<?php
/**
 * テスト用M&A企業情報データジェネレーター
 * * functions.php やカスタムプラグインで実行することを想定
 */

/**
 * M&A企業情報データベースにテストデータを挿入する。
 * * @param int $count 作成するデータの件数。
 * @return void
 */
function ma_company_insert_test_data( $count = 10 ) {
    // 投稿タイプが実際に存在するかチェック (原則3: 適切なエラーハンドリング)
    if ( ! post_type_exists( 'ma_company' ) ) {
        error_log( 'エラー: カスタム投稿タイプ "ma_company" が登録されていません。' );
        return;
    }

    // テストデータセットの定義 (原則1: 可読性の高いデータ構造)
    $test_data_sets = [
        [
            'title'   => 'アーク・テクノロジー株式会社',
            'content' => 'IT分野における独自のクラウドソリューションを持つ企業。近年、成長が加速。',
            'meta'    => [
                '_ma_company_industry' => 'ITサービス',
                '_ma_company_revenue'  => 850, // 百万円
                '_ma_company_stage'    => '交渉中',
            ],
        ],
        [
            'title'   => 'メトロ精密機器工業',
            'content' => '医療機器部品製造に特化した老舗企業。高い技術力を持つが、後継者不在。',
            'meta'    => [
                '_ma_company_industry' => '製造業',
                '_ma_company_revenue'  => 3200,
                '_ma_company_stage'    => '検討中',
            ],
        ],
        [
            'title'   => 'グリーンフードサプライ',
            'content' => 'オーガニック食品のD2C販売を展開。地域限定だが熱心な顧客ベースを持つ。',
            'meta'    => [
                '_ma_company_industry' => '飲食料品小売',
                '_ma_company_revenue'  => 120,
                '_ma_company_stage'    => '基本合意済',
            ],
        ],
        [
            'title'   => 'リーガル・コンサルタント合同会社',
            'content' => 'ニッチな法務分野に特化したコンサルティングファーム。高い利益率を誇る。',
            'meta'    => [
                '_ma_company_industry' => 'プロフェッショナルサービス',
                '_ma_company_revenue'  => 450,
                '_ma_company_stage'    => '成約済',
            ],
        ],
        [
            'title'   => 'ウエスト・ロジスティクス',
            'content' => '西日本を中心に展開する倉庫・配送業者。デジタル化の遅れが課題。',
            'meta'    => [
                '_ma_company_industry' => '運輸・倉庫業',
                '_ma_company_revenue'  => 5500,
                '_ma_company_stage'    => '検討中',
            ],
        ],
        [
            'title'   => 'クリスタル・ラボ株式会社',
            'content' => '次世代素材の研究開発ベンチャー。技術力は高いが商業化に課題。',
            'meta'    => [
                '_ma_company_industry' => '化学・素材',
                '_ma_company_revenue'  => 50,
                '_ma_company_stage'    => '交渉中',
            ],
        ],
        [
            'title'   => '教育システム開発合同',
            'content' => '学校向けeラーニングシステムの開発・提供。安定した顧客基盤を持つ。',
            'meta'    => [
                '_ma_company_industry' => '教育サービス',
                '_ma_company_revenue'  => 980,
                '_ma_company_stage'    => '交渉中',
            ],
        ],
        [
            'title'   => 'リフレッシュ・ホテルズ',
            'content' => '地方都市に特化したビジネスホテルチェーン。不動産価値が高い。',
            'meta'    => [
                '_ma_company_industry' => '不動産・宿泊',
                '_ma_company_revenue'  => 2100,
                '_ma_company_stage'    => '基本合意済',
            ],
        ],
        [
            'title'   => 'エンゼル・ファイナンス',
            'content' => '小口事業者向け融資サービス。FinTechを活用し急速に成長中。',
            'meta'    => [
                '_ma_company_industry' => '金融サービス',
                '_ma_company_revenue'  => 1500,
                '_ma_company_stage'    => '成約済',
            ],
        ],
        [
            'title'   => 'デジタル広告ラボ',
            'content' => 'Webマーケティングと効果測定に特化したコンサルティングエージェンシー。',
            'meta'    => [
                '_ma_company_industry' => '広告・マーケティング',
                '_ma_company_revenue'  => 620,
                '_ma_company_stage'    => '検討中',
            ],
        ],
    ];
    
    // 指定された件数にデータを切り詰める
    $data_to_insert = array_slice( $test_data_sets, 0, $count );
    $inserted_count = 0;

    foreach ( $data_to_insert as $data ) {
        // 投稿データの準備
        $post_data = array(
            'post_title'   => $data['title'],
            'post_content' => $data['content'],
            'post_status'  => 'publish', // 公開状態
            'post_type'    => 'ma_company',
            // セキュリティ: 投稿者IDを設定（ここでは管理者ID=1を想定）
            'post_author'  => get_current_user_id() ?: 1,
        );

        // 投稿を挿入
        $post_id = wp_insert_post( $post_data, true ); // 第2引数(true)でWP_Errorオブジェクトを返すようにする

        // 投稿挿入のエラーハンドリング (原則3)
        if ( is_wp_error( $post_id ) ) {
            error_log( 'データ挿入エラー: ' . $data['title'] . ' - ' . $post_id->get_error_message() );
            continue; // 次のデータへ
        }
        
        // カスタムフィールドの保存
        if ( ! empty( $data['meta'] ) ) {
            foreach ( $data['meta'] as $key => $value ) {
                // update_post_metaは、存在しない場合は追加、存在する場合は更新を行う
                // キー名は前のタスクで定義したカスタムフィールドのメタキーと一致させる
                update_post_meta( $post_id, $key, $value );
            }
        }
        $inserted_count++;
    }

    error_log( sprintf( 'M&A企業情報データベースに %d 件のテストデータを挿入しました。', $inserted_count ) );
}

// 実行フックを一時的に設定 (管理者のみが実行できるようにする)
// 本番環境で実行されないよう、実行後にこの add_action は削除してください。
// if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
//    add_action( 'init', 'ma_company_insert_test_data' );
// }

// 外部から手動で関数を呼び出すための記述 (例: /wp-admin/admin.php?page=run_data_generator など)
// 開発環境でのみ使用し、セキュリティのため