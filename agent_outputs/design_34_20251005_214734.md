# 設計書: 提携パートナー向け案件閲覧履歴機能の設計書作成。トラッキング対象、データ格納方法、匿名化されたユーザーIDの定義ロジックを含む。

タスクID: 34
作成日時: 2025-10-05T21:47:34.481679

---

はい、経験豊富なシステム設計者として、M&Aポータルサイトにおける提携パートナー向け案件閲覧履歴機能の詳細設計を行います。この機能は、パートナーのアクティビティを把握し、サイト運営側が案件への関心度を分析するための重要な基盤となります。

タスク概要

目的

提携パートナー（ma_partnerロール）が特定の案件（ma_case CPT）を閲覧した履歴をセキュアに記録・追跡するためのシステム仕様を定義します。特に、個人の特定を防ぐためのユーザーIDの匿名化を最重要セキュリティ要件として実装します。

スコープ

トラッキング対象となるアクションとデータの定義。

閲覧履歴データを格納するデータベーススキーマの設計（カスタムテーブル）。

パートナーIDを匿名化するためのロジック（ハッシュ化/ソルト）と保存方法の定義。

データの保存と取得のロジックフロー。

設計内容

1. トラッキング対象とデータ定義

閲覧履歴は、誰が（匿名ID）、どの案件を（案件ID）、いつ（タイムスタンプ）閲覧したかを記録します。

No.	項目名	メタキー名	データ型 (DB)	必須/任意	備考
1	匿名ユーザーID	anonymous_partner_id	VARCHAR(64)	必須	SHA-256ハッシュ値。パートナー特定は不可。
2	案件ID	case_id	BIGINT(20)	必須	ma_case CPTのID。
3	閲覧日時	view_timestamp	DATETIME	必須	履歴データのソートと時系列分析に使用。
4	閲覧回数	view_count	INT	任意	同一セッション内の再閲覧をカウントアップ。
Google スプレッドシートにエクスポート

2. データ格納方法（カスタムデータベーステーブル）

パフォーマンスとスケーラビリティを考慮し、WordPressの標準wp_postmetaではなく、専用のカスタムテーブルを設計します。

テーブル名: ma_view_history

カラム名	データ型	属性	備考
id	BIGINT(20)	PRIMARY KEY, AUTO_INCREMENT	履歴レコードの一意ID。
anonymous_partner_id	VARCHAR(64)	INDEX	最も重要なインデックス。匿名IDによる検索を高速化。
case_id	BIGINT(20)	INDEX	案件IDによる検索を高速化。
view_timestamp	DATETIME	INDEX	時系列ソートと期間検索用。
view_count	INT(11)	NOT NULL, DEFAULT 1	
Google スプレッドシートにエクスポート

3. 匿名化されたユーザーIDの定義ロジック

提携パートナー（wp_usersのID）のプライバシーを保護しつつ、システム内での追跡可能性を確保するため、可逆性のない一方向ハッシュを使用します。

項目	ロジック	備考
生ID	current_user_id() (提携パートナーのID)	データベースには保存しない。
ソルト	MA_PARTNER_SALT (wp-config.phpで定義)	ハッシュのレインボーテーブル攻撃を防ぐための秘密の文字列。
匿名ID生成	anonymous_partner_id = SHA256( raw_partner_id + MA_PARTNER_SALT )	SHA-256を使用。不可逆性により、ハッシュ値から生IDを特定できない。
保存先	ma_view_history.anonymous_partner_id	
Google スプレッドシートにエクスポート

4. 閲覧履歴の記録ロジックフロー

閲覧履歴の記録は、提携パートナーが案件詳細ページ（ma_caseシングルページ）にアクセスした際に、フロントエンド側の権限チェック後に実行します。

トリガー: ma_caseのシングルページ読み込み時（wpアクションフックなど）。

権限チェック: current_user_can('read_ma_case')およびcurrent_user_can('ma_partner')を確認。権限がない場合は処理を終了。

匿名ID生成: ログイン中のユーザーIDとMA_PARTNER_SALTからanonymous_partner_idを生成。

記録: wpdbクラスを使用し、case_idとanonymous_partner_id、view_timestampをma_view_historyテーブルに挿入する。

技術選定

分野	技術	選定理由
データベース操作	$wpdbクラス (WordPress標準)	カスタムテーブルへのCRUD操作に必須。セキュリティ（SQLインジェクション対策）と互換性を確保。
匿名化アルゴリズム	SHA-256	業界標準の強力な一方向ハッシュ関数。不可逆性を保証し、個人の特定を防ぐ。
記録トリガー	WordPressアクションフック（wpまたはtemplate_redirect）	案件詳細ページが読み込まれたタイミングを正確に捉え、処理を実行できる。
スケジュール管理	Action Scheduler (推奨)	履歴データの定期的なクリーンアップ（例：1年経過後のデータ削除）処理を非同期で実行するために利用。
Google スプレッドシートにエクスポート

実装における注意点

匿名化ソルトの管理: MA_PARTNER_SALT