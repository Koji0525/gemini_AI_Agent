nameAutoCopyPasteSystem

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯'
        required: true
        default: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®README.mdã‚’ç¢ºèªã—ã¦ã€ä¸è¶³ãŒã‚ã‚Œã°è¿½åŠ ã—ã¦ãã ã•ã„'
        type: string
      max_iterations:
        description: 'æœ€å¤§åå¾©å›æ•°'
        required: false
        default: '5'
        type: string

jobs:
  auto-copypaste:
    name: ğŸš€ è‡ªå‹•ã‚³ãƒ”ãƒšå®Ÿè¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install --upgrade pip
        pip install google-generativeai requests pyyaml
    
    - name: ğŸ” Codespaceåã‚’å–å¾—
      id: get-codespace
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
        
        echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
        CODESPACE_NAME=$(gh codespace list --json name --jq '.[0].name' 2>/dev/null || echo "")
        
        if [ -z "$CODESPACE_NAME" ]; then
          echo "âš ï¸ CodespaceãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™..."
          CODESPACE_NAME=$(gh codespace create --repo ${{ github.repository }} --machine basicLinux32gb --retention-period 1h --json name --jq '.name')
          echo "âœ… Codespaceä½œæˆ: $CODESPACE_NAME"
        else
          echo "âœ… æ—¢å­˜ã®Codespaceä½¿ç”¨: $CODESPACE_NAME"
        fi
        
        echo "codespace_name=$CODESPACE_NAME" >> $GITHUB_OUTPUT
    
    - name: ğŸ¤– è‡ªå‹•ã‚³ãƒ”ãƒšãƒ­ãƒœãƒƒãƒˆå®Ÿè¡Œ
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GITHUB_PAT: ${{ secrets.GH_PAT }}
        CODESPACE_NAME: ${{ steps.get-codespace.outputs.codespace_name }}
        TASK: ${{ github.event.inputs.task }}
        MAX_ITERATIONS: ${{ github.event.inputs.max_iterations }}
      run: |
        python scripts/auto_copypaste_api.py
    
    - name: ğŸ“Š çµæœã‚’è¡¨ç¤º
      if: always()
      run: |
        echo "ğŸ‰ å®Ÿè¡Œå®Œäº†"
        if [ -f results.txt ]; then
          echo "ğŸ“ çµæœ:"
          cat results.txt
        fi
    
    - name: ğŸ’¾ ãƒ­ã‚°ä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: execution-logs
        path: |
          *.log
          *.txt
        retention-days: 7
