name: Auto CopyPaste System
on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to execute'
        required: true
        default: 'Check README.md and add missing information'
        type: string
      max_iterations:
        description: 'Maximum iterations'
        required: false
        default: '5'
        type: string

jobs:
  auto-copypaste:
    name: Execute Auto CopyPaste
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install google-generativeai requests pyyaml
    
    - name: Get Codespace name
      id: get-codespace
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
        
        echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
        CODESPACE_NAME=$(gh codespace list --json name --jq '.[0].name' 2>/dev/null || echo "")
        
        if [ -z "$CODESPACE_NAME" ]; then
          echo "Creating new Codespace..."
          CODESPACE_NAME=$(gh codespace create --repo ${{ github.repository }} --machine basicLinux32gb --retention-period 1h --json name --jq '.name')
          echo "Codespace created: $CODESPACE_NAME"
        else
          echo "Using existing Codespace: $CODESPACE_NAME"
        fi
        
        echo "codespace_name=$CODESPACE_NAME" >> $GITHUB_OUTPUT
    
    - name: Run Auto CopyPaste Bot
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GITHUB_PAT: ${{ secrets.GH_PAT }}
        CODESPACE_NAME: ${{ steps.get-codespace.outputs.codespace_name }}
        TASK: ${{ github.event.inputs.task }}
        MAX_ITERATIONS: ${{ github.event.inputs.max_iterations }}
      run: |
        python scripts/auto_copypaste_api.py
    
    - name: Display results
      if: always()
      run: |
        echo "Execution completed"
        if [ -f results.txt ]; then
          echo "Results:"
          cat results.txt
        fi
    
    - name: Save logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: execution-logs
        path: |
          *.log
          *.txt
        retention-days: 7
