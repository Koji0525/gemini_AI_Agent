#!/usr/bin/env python3
"""
ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³M&Aãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆè¨­è¨ˆã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
"""
import asyncio
import os
from browser_control.browser_controller import BrowserController

async def run_uzbekistan_ma_task():
    print("\n" + "="*70)
    print("ğŸ¯ ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³M&Aãƒãƒ¼ã‚¿ãƒ« - ã‚µã‚¤ãƒˆè¨­è¨ˆã‚¿ã‚¹ã‚¯")
    print("="*70)
    
    async with BrowserController(download_folder="./downloads") as browser:
        # ã‚¹ãƒ†ãƒƒãƒ—1: Geminiã«ã‚¢ã‚¯ã‚»ã‚¹
        print("\n[1/5] Geminiã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...")
        logged_in = await browser.navigate_to_gemini()
        
        if not logged_in:
            print("\nâŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™")
            print("ğŸ’¡ VNCã§æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€å†å®Ÿè¡Œã—ã¦ãã ã•ã„")
            print("   http://localhost:6080/vnc.html")
            return False
        
        print("âœ… Geminiãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿")
        
        # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæº–å‚™
        print("\n[2/5] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæº–å‚™ä¸­...")
        
        prompt = """Create a comprehensive site structure for an Uzbekistan M&A Portal website.

**Requirements:**
1. Main Pages (7-10 pages)
   - Home page with key features
   - M&A Listings page
   - Company Profiles
   - Resources/Knowledge Base
   - About Us
   - Contact

2. Key Features to include:
   - Search and filter M&A opportunities
   - Company matching system
   - Document repository
   - Due diligence tools
   - Communication platform

3. Target Audience:
   - Uzbekistan business owners
   - International investors
   - M&A advisors
   - Legal/financial professionals

4. Technical Considerations:
   - Bilingual (English/Uzbek)
   - Mobile-responsive design
   - Secure document handling

Please provide:
- Page structure with navigation hierarchy
- Key features for each page
- User flow recommendations
- Content priorities

Keep the response organized and under 1000 words."""

        print(f"âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæº–å‚™å®Œäº†ï¼ˆ{len(prompt)} æ–‡å­—ï¼‰")
        
        # ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡
        print("\n[3/5] Geminiã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ä¸­...")
        print(f"ğŸ“ {prompt[:100]}...")
        
        try:
            await browser.send_prompt(prompt)
            print("âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡æˆåŠŸ")
        except Exception as e:
            print(f"âŒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
            return False
        
        # ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾…æ©Ÿ
        print("\n[4/5] ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆå¾…æ©Ÿä¸­...")
        print("â³ æœ€å¤§60ç§’å¾…æ©Ÿã—ã¾ã™...")
        
        try:
            await browser.wait_for_text_generation(max_wait=60)
            print("âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆå®Œäº†")
        except Exception as e:
            print(f"âš ï¸  å¾…æ©Ÿã‚¨ãƒ©ãƒ¼: {e}")
            print("ğŸ’¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—ã‚’è©¦ã¿ã¾ã™...")
        
        # ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—
        print("\n[5/5] ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—ä¸­...")
        
        try:
            response = await browser.extract_latest_text_response()
            
            if response and len(response) > 100:
                print("\n" + "="*70)
                print("ğŸ“ ç”Ÿæˆçµæœ")
                print("="*70)
                print(f"æ–‡å­—æ•°: {len(response)} æ–‡å­—")
                print(f"å˜èªæ•°: {len(response.split())} èª")
                print("="*70)
                print("\nã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰ã€‘")
                print(response[:500] + "...")
                print("\n" + "="*70)
                
                # ä¿å­˜
                os.makedirs("agent_outputs/design", exist_ok=True)
                output_file = "agent_outputs/design/uzbekistan_ma_portal_structure.md"
                
                with open(output_file, "w", encoding="utf-8") as f:
                    f.write(f"# Uzbekistan M&A Portal - Site Structure Design\n\n")
                    f.write(f"**Generated by**: Gemini AI\n")
                    f.write(f"**Task**: Site Structure Design\n")
                    f.write(f"**Date**: {os.popen('date').read().strip()}\n\n")
                    f.write("---\n\n")
                    f.write(response)
                
                print(f"\nğŸ’¾ çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ: {output_file}")
                print("\nâœ…âœ…âœ… ã‚¿ã‚¹ã‚¯å®Ÿè¡ŒæˆåŠŸï¼")
                return True
            else:
                print(f"\nâš ï¸  ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒçŸ­ã™ãã¾ã™ï¼ˆ{len(response) if response else 0} æ–‡å­—ï¼‰")
                print("ğŸ’¡ VNCã§ç”»é¢ã‚’ç¢ºèªã—ã¦ãã ã•ã„")
                return False
                
        except Exception as e:
            print(f"âŒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return False

if __name__ == "__main__":
    print("\nğŸš€ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé–‹å§‹")
    print("DISPLAY: " + os.environ.get("DISPLAY", "æœªè¨­å®š"))
    
    # DISPLAYè¨­å®šç¢ºèª
    if not os.environ.get("DISPLAY"):
        os.environ["DISPLAY"] = ":1"
        print("âš ï¸  DISPLAYã‚’:1ã«è¨­å®šã—ã¾ã—ãŸ")
    
    result = asyncio.run(run_uzbekistan_ma_task())
    
    if result:
        print("\n" + "="*70)
        print("ğŸŠ ã‚¿ã‚¹ã‚¯å®Œäº†ï¼")
        print("="*70)
        print("\næ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
        print("  1. agent_outputs/design/uzbekistan_ma_portal_structure.md ã‚’ç¢ºèª")
        print("  2. å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼")
        print("  3. å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ãƒ»è¿½åŠ ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ")
    else:
        print("\n" + "="*70)
        print("âš ï¸  ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ")
        print("="*70)
        print("\nãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:")
        print("  1. VNCã§ç”»é¢ç¢ºèª: http://localhost:6080/vnc.html")
        print("  2. ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª")
        print("  3. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç¢ºèª: debug_gemini_page.png")

