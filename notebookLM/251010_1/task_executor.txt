"""
task_executor.py - ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰
"""

import asyncio
import logging
from typing import Dict, List, Optional, Any
from datetime import datetime

# ===== è¨­å®šã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
from config_utils import ErrorHandler, config

# ===== ãƒ‡ãƒ¼ã‚¿ç®¡ç† =====
from sheets_manager import GoogleSheetsManager

# ===== ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ =====
try:
    from error_handler_enhanced import (
        EnhancedErrorHandler,
        TaskErrorHandler
    )
    HAS_ENHANCED_HANDLER = True
except ImportError:
    HAS_ENHANCED_HANDLER = False
    logger = logging.getLogger(__name__)
    logger.warning("âš ï¸ error_handler_enhancedæœªæ¤œå‡ºï¼ˆæ¨™æº–ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ä½¿ç”¨ï¼‰")

# ===== åˆ†é›¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« =====
try:
    from task_executor_content import ContentTaskExecutor
    from task_executor_ma import MATaskExecutor
    HAS_SPECIALIZED_EXECUTORS = True
except ImportError:
    HAS_SPECIALIZED_EXECUTORS = False
    ContentTaskExecutor = None
    MATaskExecutor = None

# ===== WordPressé€£æºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ =====
try:
    from wordpress.wp_utils import task_router
    HAS_TASK_ROUTER = True
except ImportError:
    HAS_TASK_ROUTER = False
    task_router = None

logger = logging.getLogger(__name__)


class TaskExecutor:
    """ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰"""
    
    def __init__(
        self, 
        sheets_manager: GoogleSheetsManager, 
        browser_controller=None, 
        max_iterations: int = None
    ):
        """
        åˆæœŸåŒ–
        
        Args:
            sheets_manager: GoogleSheetsManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
            browser_controller: BrowserController ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            max_iterations: æœ€å¤§åå¾©å›æ•°
        """
        self.sheets_manager = sheets_manager
        self.browser = browser_controller
        self.agents = {}
        self.review_agent = None
        
        if max_iterations is None:
            self.max_iterations = config.MAX_ITERATIONS
        else:
            self.max_iterations = max_iterations
        
        self.current_iteration = 0
        
        logger.info(f"TaskExecutor: æœ€å¤§åå¾©å›æ•° = {self.max_iterations}")
        
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è‡ªå‹•åˆæœŸåŒ–
        self._initialize_agents()
        
        # === åˆ†é›¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ– ===
        if HAS_SPECIALIZED_EXECUTORS and ContentTaskExecutor and MATaskExecutor:
            try:
                # è¨˜äº‹ç”Ÿæˆå°‚ç”¨ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼
                self.content_executor = ContentTaskExecutor(self.agents)
                logger.info("âœ… ContentTaskExecutor åˆæœŸåŒ–å®Œäº†")
                
                # M&Aå°‚ç”¨ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼
                self.ma_executor = MATaskExecutor(self.agents)
                logger.info("âœ… MATaskExecutor åˆæœŸåŒ–å®Œäº†")
                
                logger.info("="*60)
                logger.info("åˆ†é›¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†")
                logger.info("  - ContentTaskExecutor (è¨˜äº‹ç”Ÿæˆå°‚ç”¨)")
                logger.info("  - MATaskExecutor (M&A/ä¼æ¥­æ¤œç´¢å°‚ç”¨)")
                logger.info("="*60)
            except Exception as e:
                logger.warning(f"âš ï¸ åˆ†é›¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–å¤±æ•—: {e}")
                self.content_executor = None
                self.ma_executor = None
        else:
            logger.warning("âš ï¸ åˆ†é›¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“")
            self.content_executor = None
            self.ma_executor = None
    
    def _initialize_agents(self):
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è‡ªå‹•åˆæœŸåŒ–"""
        logger.info("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆæœŸåŒ–ä¸­...")
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å¤–éƒ¨ã‹ã‚‰ register_agent() ã§ç™»éŒ²ã•ã‚Œã‚‹
        logger.info("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†")
    
    def register_agent(self, role: str, agent):
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç™»éŒ²"""
        self.agents[role] = agent
        logger.info(f"ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ '{role}' ã‚’ç™»éŒ²ã—ã¾ã—ãŸ")
    
    def register_review_agent(self, review_agent):
        """ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç™»éŒ²"""
        self.review_agent = review_agent
        logger.info("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ")
    

    async def load_pending_tasks(self) -> List[Dict]:
        """ä¿ç•™ä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰"""
        try:
            logger.info("ğŸ“‹ ä¿ç•™ä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ä¸­...")
            tasks = await self.sheets_manager.load_tasks_from_sheet('pm_tasks')
            
            if not tasks:
                logger.info("ğŸ“­ pm_tasksã‚·ãƒ¼ãƒˆã«ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“")
                return []
            
            # statusãŒ'pending'ã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿
            pending_tasks = [
                task for task in tasks 
                if task.get('status', '').lower() == 'pending'
            ]
            
            logger.info(f"ğŸ“Š ä¿ç•™ä¸­ã®ã‚¿ã‚¹ã‚¯: {len(pending_tasks)}ä»¶")
            
            # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if pending_tasks:
                for i, task in enumerate(pending_tasks[:3]):  # æœ€åˆã®3ä»¶ã‚’è¡¨ç¤º
                    logger.info(f"  {i+1}. {task.get('description', '')[:60]}...")
                if len(pending_tasks) > 3:
                    logger.info(f"  ... ä»– {len(pending_tasks)-3}ä»¶")
            
            return pending_tasks
            
        except Exception as e:
            logger.error(f"âŒ ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    async def update_task_status(self, task: Dict, status: str, error: str = None):
        """ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°"""
        try:
            task_id = task.get('task_id', 'UNKNOWN')
            logger.info(f"ã‚¿ã‚¹ã‚¯ {task_id} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ '{status}' ã«æ›´æ–°")
            
            await self.sheets_manager.update_task_status(
                task_id, 
                status, 
                error_message=error
            )
            
        except Exception as e:
            logger.warning(f"âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å¤±æ•—ï¼ˆç¶šè¡Œï¼‰: {e}")
    
    async def save_task_output(self, task: Dict, result: Dict):
        """ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›ã‚’ä¿å­˜"""
        try:
            task_id = task.get('task_id', 'UNKNOWN')
            logger.info(f"ã‚¿ã‚¹ã‚¯ {task_id} ã®å‡ºåŠ›ã‚’ä¿å­˜ä¸­...")
            
            output_data = {
                'task_id': task_id,
                'summary': result.get('summary', ''),
                'full_text': result.get('full_text', ''),
                'screenshot': result.get('screenshot', ''),
                'timestamp': datetime.now().isoformat()
            }
            
            await self.sheets_manager.save_task_output(output_data)
            logger.info("âœ… å‡ºåŠ›ä¿å­˜å®Œäº†")
            
        except Exception as e:
            logger.warning(f"âš ï¸ å‡ºåŠ›ä¿å­˜å¤±æ•—ï¼ˆç„¡è¦–ï¼‰: {e}")
    
    async def execute_task(self, task: Dict) -> bool:
        """
        å˜ä¸€ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆ + wp_dev/M&Aå¯¾å¿œï¼‰
        """
        task_id = task.get('task_id', 'UNKNOWN')
        
        try:
            # === ã‚¿ã‚¹ã‚¯é–‹å§‹ãƒ˜ãƒƒãƒ€ãƒ¼ ===
            print("\n" + "ğŸ”·"*40)
            print("=" * 80)
            print(f"ğŸ¯ ã‚¿ã‚¹ã‚¯é–‹å§‹: {task_id}")
            print("=" * 80)
            print(f"ğŸ“ å†…å®¹: {task['description'][:70]}...")
            print(f"ğŸ‘¤ æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: {task['required_role'].upper()}")
            
            # === ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š ===
            task_type = 'default'
            if HAS_TASK_ROUTER and task_router:
                try:
                    task_type = task_router.determine_task_type(task)
                    logger.info(f"ğŸ“Š ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¤å®š: {task_type}")
                    print(f"ğŸ” ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—: {task_type.upper()}")
                except Exception as e:
                    logger.warning(f"âš ï¸ ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¤å®šå¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡¦ç†: {e}")
            
            print("=" * 80)
            print("ğŸ”·"*40 + "\n")
            
            logger.info(f"ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡Œé–‹å§‹")
            
            # ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’'in_progress'ã«æ›´æ–°
            try:
                await self.update_task_status(task, 'in_progress')
            except Exception as e:
                logger.warning(f"âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å¤±æ•—ï¼ˆç¶šè¡Œï¼‰: {e}")
            
            # æ‹…å½“AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—
            role = task['required_role'].lower()
            
            # === ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š ===
            timeout_map = {
                'ma': 300.0,
                'content': 240.0,
                'review': 180.0,
                'wordpress': 300.0,
                'wp_dev': 300.0,  # â† wp_dev ã‚’è¿½åŠ 
                'wp_design': 300.0,  # â† wp_design ã‚’è¿½åŠ 
                'default': 180.0
            }
            task_timeout = timeout_map.get(task_type, 180.0)
            
            # === ã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰ ===
            result = None
            
            try:
                # ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã®ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚’ä½œæˆ
                if task_type == 'ma' and self.ma_executor:
                    logger.info("="*60)
                    logger.info("ğŸ“Š M&A/ä¼æ¥­æ¤œç´¢ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†")
                    logger.info("="*60)
                    task_coro = self.ma_executor.execute_ma_task(task)
                
                elif task_type == 'content' and self.content_executor:
                    logger.info("="*60)
                    logger.info("âœï¸ è¨˜äº‹ç”Ÿæˆã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†")
                    logger.info("="*60)
                    task_coro = self.content_executor.execute_writer_task(task, role)
                
                elif task_type == 'review':
                    logger.info("="*60)
                    logger.info("âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†")
                    logger.info("="*60)
                    task_coro = self._execute_review_task(task)
                
                # === wp_dev ã¨ wp_design ã®å‡¦ç†ã‚’è¿½åŠ  ===
                elif role == 'wp_dev':
                    logger.info("="*60)
                    logger.info("ğŸ”§ WordPressé–‹ç™ºã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†")
                    logger.info("="*60)
                    agent = self.agents.get('wp_dev')
                    if agent:
                        task_coro = agent.process_task(task)
                    else:
                        logger.warning("âš ï¸ wp_dev ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - é€šå¸¸å‡¦ç†ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯")
                        task_coro = self._execute_wordpress_task(task)
                
                elif role == 'wp_design':
                    logger.info("="*60)
                    logger.info("ğŸ¨ WordPressè¨­è¨ˆã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†")
                    logger.info("="*60)
                    agent = self.agents.get('wp_design')
                    if agent:
                        task_coro = agent.process_task(task)
                    else:
                        logger.warning("âš ï¸ wp_design ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - é€šå¸¸å‡¦ç†ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯")
                        task_coro = self._execute_design_task(task)
                
                else:
                    logger.info("="*60)
                    logger.info(f"ğŸ“‹ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯ ({role}) ã¨ã—ã¦å‡¦ç†")
                    logger.info("="*60)
                    
                    # å¾“æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯
                    if role == 'design':
                        task_coro = self._execute_design_task(task)
                    elif role == 'dev':
                        task_coro = self._execute_dev_task(task)
                    elif role == 'ui':
                        task_coro = self._execute_ui_task(task)
                    elif role == 'wordpress':
                        task_coro = self._execute_wordpress_task(task)
                    elif role == 'plugin':
                        task_coro = self._execute_plugin_task(task)
                    else:
                        # æœªç™»éŒ²ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
                        agent = self.agents.get(role)
                        if not agent:
                            logger.warning(f"æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ '{role}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
                            await self.update_task_status(task, 'skipped')
                            return False
                        task_coro = agent.process_task(task)
                
                # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œ
                if HAS_ENHANCED_HANDLER:
                    result = await EnhancedErrorHandler.timeout_wrapper(
                        task_coro,
                        timeout=task_timeout,
                        context=f"ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡Œ"
                    )
                else:
                    result = await asyncio.wait_for(task_coro, timeout=task_timeout)
            
            except asyncio.TimeoutError:
                logger.error("="*60)
                logger.error(f"â±ï¸ ã‚¿ã‚¹ã‚¯ {task_id} ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ{task_timeout}ç§’ï¼‰")
                logger.error("="*60)
                
                await self.update_task_status(task, 'failed')
                
                print("\n" + "ğŸ”·"*40)
                print("=" * 80)
                print(f"â±ï¸ ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: {task_id}")
                print(f"åˆ¶é™æ™‚é–“: {task_timeout}ç§’")
                print("=" * 80)
                print("ğŸ”·"*40 + "\n")
                
                return False
            
            except Exception as e:
                logger.error("="*60)
                logger.error(f"âŒ ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡Œä¸­ã«ä¾‹å¤–ç™ºç”Ÿ")
                logger.error(f"ã‚¨ãƒ©ãƒ¼: {str(e)}")
                logger.error("="*60)
                
                if HAS_ENHANCED_HANDLER:
                    EnhancedErrorHandler.log_error_with_context(
                        e, 
                        f"ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡Œ"
                    )
                
                await self.update_task_status(task, 'failed')
                
                print("\n" + "ğŸ”·"*40)
                print("=" * 80)
                print(f"ğŸ’¥ ã‚¿ã‚¹ã‚¯ä¾‹å¤–: {task_id}")
                print(f"ä¾‹å¤–: {str(e)}")
                print("=" * 80)
                print("ğŸ”·"*40 + "\n")
                
                return False
            
            # === å®Ÿè¡Œçµæœã®å‡¦ç† ===
            if result and result.get('success'):
                logger.info("="*60)
                logger.info(f"âœ… ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡ŒæˆåŠŸ")
                logger.info("="*60)
                
                try:
                    await self.update_task_status(task, 'completed')
                    await self.save_task_output(task, result)
                except Exception as e:
                    logger.warning(f"âš ï¸ çµæœä¿å­˜å¤±æ•—ï¼ˆã‚¿ã‚¹ã‚¯è‡ªä½“ã¯æˆåŠŸï¼‰: {e}")
                
                # ãƒ¬ãƒ“ãƒ¥ãƒ¼AIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼
                if self.review_agent and role != 'review' and task_type != 'review':
                    try:
                        logger.info("="*60)
                        logger.info("âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼AIã§ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹")
                        logger.info("="*60)
                        
                        if HAS_ENHANCED_HANDLER:
                            await EnhancedErrorHandler.timeout_wrapper(
                                self.perform_review_and_add_tasks(task, result),
                                timeout=120.0,
                                context=f"ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¿ã‚¹ã‚¯ {task_id}ï¼‰"
                            )
                        else:
                            await asyncio.wait_for(
                                self.perform_review_and_add_tasks(task, result),
                                timeout=120.0
                            )
                    except Exception as e:
                        logger.warning(f"âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤±æ•—ï¼ˆç„¡è¦–ï¼‰: {e}")
                
                print("\n" + "ğŸ”·"*40)
                print("=" * 80)
                print(f"âœ… ã‚¿ã‚¹ã‚¯å®Œäº†: {task_id}")
                print(f"ã‚¿ã‚¤ãƒ—: {task_type.upper()}")
                print(f"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æˆåŠŸ")
                print("=" * 80)
                print("ğŸ”·"*40 + "\n")
                
                return True
            else:
                error_msg = result.get('error', 'ä¸æ˜') if result else 'çµæœãªã—'
                logger.error("="*60)
                logger.error(f"âŒ ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡Œå¤±æ•—")
                logger.error(f"ã‚¨ãƒ©ãƒ¼: {error_msg}")
                logger.error("="*60)
                
                await self.update_task_status(task, 'failed')
                
                print("\n" + "ğŸ”·"*40)
                print("=" * 80)
                print(f"âŒ ã‚¿ã‚¹ã‚¯å¤±æ•—: {task_id}")
                print(f"ã‚¿ã‚¤ãƒ—: {task_type.upper()}")
                print(f"ã‚¨ãƒ©ãƒ¼: {error_msg}")
                print("=" * 80)
                print("ğŸ”·"*40 + "\n")
                
                return False
        
        except Exception as e:
            logger.error(f"âŒ ã‚¿ã‚¹ã‚¯ {task_id} å‡¦ç†å…¨ä½“ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼")
            
            if HAS_ENHANCED_HANDLER:
                EnhancedErrorHandler.log_error_with_context(
                    e, 
                    f"ã‚¿ã‚¹ã‚¯ {task_id} å…¨ä½“å‡¦ç†"
                )
            else:
                ErrorHandler.log_error(e, f"ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡Œ")
            
            try:
                await self.update_task_status(task, 'failed')
            except:
                pass
            
            print("\n" + "ğŸ”·"*40)
            print("=" * 80)
            print(f"ğŸ’¥ ã‚¿ã‚¹ã‚¯é‡å¤§ã‚¨ãƒ©ãƒ¼: {task_id}")
            print(f"ä¾‹å¤–: {str(e)}")
            print("=" * 80)
            print("ğŸ”·"*40 + "\n")
            
            return False
    
    async def _execute_design_task(self, task: Dict) -> Dict:
        """è¨­è¨ˆã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
        agent = self.agents.get('design')
        if not agent:
            return {'success': False, 'error': 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
        return await agent.process_task(task)
    
    async def _execute_dev_task(self, task: Dict) -> Dict:
        """é–‹ç™ºã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
        agent = self.agents.get('dev')
        if not agent:
            return {'success': False, 'error': 'é–‹ç™ºã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
        return await agent.process_task(task)
    
    async def _execute_ui_task(self, task: Dict) -> Dict:
        """UIã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
        agent = self.agents.get('ui')
        if not agent:
            return {'success': False, 'error': 'UIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
        return await agent.process_task(task)
    
    async def _execute_wordpress_task(self, task: Dict) -> Dict:
        """WordPressã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
        logger.info("â”Œ" + "â”€"*58 + "â”")
        logger.info("â”‚ ğŸŒ WordPress AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œä¸­")
        logger.info("â”œ" + "â”€"*58 + "â”¤")
        logger.info(f"â”‚ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: {task.get('post_action', 'N/A')}")
        logger.info(f"â”‚ è¨€èª: {task.get('language', 'N/A')}")
        logger.info(f"â”‚ Polylang: {task.get('polylang_lang', 'N/A')}")
        logger.info("â””" + "â”€"*58 + "â”˜")
        
        try:
            # M&Aé–¢é€£ã‚¿ã‚¹ã‚¯ã®å†åˆ¤å®š
            if HAS_TASK_ROUTER and task_router and task_router.is_ma_task(task):
                logger.info("ğŸ“Š M&Aé–¢é€£ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å†æŒ¯ã‚Šåˆ†ã‘")
                if self.ma_executor:
                    return await self.ma_executor.execute_ma_task(task)
            
            # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            if 'post_action' not in task:
                task['post_action'] = 'edit'
            if 'polylang_lang' not in task:
                task['polylang_lang'] = 'ja'
            
            agent = self.agents.get('wordpress')
            if not agent:
                logger.error("âŒ WordPress AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“")
                return {
                    'success': False,
                    'error': 'wordpress ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'
                }
            
            result = await agent.process_task(task)
            
            if result.get('success'):
                logger.info("âœ… WordPress AI: ã‚¿ã‚¹ã‚¯å®Œäº†")
            else:
                logger.error(f"âŒ WordPress AI: å¤±æ•— - {result.get('error', 'ä¸æ˜')}")
            
            return result
            
        except Exception as e:
            ErrorHandler.log_error(e, "WordPressã‚¿ã‚¹ã‚¯å®Ÿè¡Œ")
            logger.error(f"âŒ WordPress AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ä¾‹å¤–ç™ºç”Ÿ - {str(e)}")
            return {
                'success': False,
                'error': f'WordPressã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {str(e)}'
            }
    
    async def _execute_plugin_task(self, task: Dict) -> Dict:
        """ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
        agent = self.agents.get('plugin')
        if not agent:
            return {'success': False, 'error': 'ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
        return await agent.process_task(task)
    
    async def _execute_review_task(self, task: Dict) -> Dict:
        """ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ"""
        if not self.review_agent:
            return {'success': False, 'error': 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
        
        try:
            review_target_id = task.get('review_target_task_id')
            if not review_target_id:
                return {'success': False, 'error': 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã‚¿ã‚¹ã‚¯IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'}
            
            # ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
            result = await self.review_agent.review_task(review_target_id)
            return result
            
        except Exception as e:
            ErrorHandler.log_error(e, "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ")
            return {'success': False, 'error': str(e)}
    
    async def perform_review_and_add_tasks(self, task: Dict, result: Dict):
        """ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨è¿½åŠ ã‚¿ã‚¹ã‚¯ç”Ÿæˆ"""
        try:
            logger.info(f"\nã‚¿ã‚¹ã‚¯ {task['task_id']} ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹...")
            
            output_content = result.get('full_text', result.get('summary', ''))
            
            task['output_content'] = output_content
            review_result = await self.review_agent.review_completed_task(task, output_content)
            
            if not review_result.get('success'):
                logger.warning("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ")
                return
            
            review_data = review_result.get('review', {})
            next_actions = review_data.get('next_actions', {})
            
            if next_actions.get('required'):
                suggested_tasks = next_actions.get('suggested_tasks', [])
                
                if suggested_tasks:
                    print(f"\nææ¡ˆã‚¿ã‚¹ã‚¯: {len(suggested_tasks)}ä»¶")
                    
                    while True:
                        choice = input("\nææ¡ˆã‚¿ã‚¹ã‚¯ã‚’ã©ã†ã—ã¾ã™ã‹?\n"
                                     "(y)è¿½åŠ  / (n)ã‚¹ã‚­ãƒƒãƒ— / (v)ç¢ºèª / (e)ç·¨é›† / (m)æ‰‹å‹•å…¥åŠ› / (c)ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ").lower()
                        
                        if choice == 'y':
                            added_count = await self.review_agent.add_suggested_tasks_to_sheet(
                                task['task_id'], 
                                suggested_tasks
                            )
                            print(f"{added_count}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
                            logger.info(f"{added_count}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
                            break
                        
                        elif choice == 'n':
                            print("ã‚¿ã‚¹ã‚¯è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ")
                            break
                        
                        elif choice == 'v':
                            if self.content_executor:
                                self.content_executor.display_suggested_tasks(suggested_tasks)
                            else:
                                self._display_suggested_tasks(suggested_tasks)
                            continue
                        
                        elif choice == 'e':
                            if self.content_executor:
                                edited_tasks = await self.content_executor.edit_suggested_tasks(suggested_tasks)
                            else:
                                edited_tasks = await self._edit_suggested_tasks(suggested_tasks)
                            
                            if edited_tasks:
                                confirm = input(f"ç·¨é›†å¾Œã®ã‚¿ã‚¹ã‚¯ {len(edited_tasks)} ä»¶ã‚’è¿½åŠ ã—ã¾ã™ã‹? (y/n): ").lower()
                                if confirm == 'y':
                                    added_count = await self.review_agent.add_suggested_tasks_to_sheet(
                                        task['task_id'], 
                                        edited_tasks
                                    )
                                    print(f"{added_count}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
                                    break
                            continue
                        
                        elif choice == 'm':
                            if self.content_executor:
                                manual_tasks = await self.content_executor.create_manual_tasks()
                            else:
                                manual_tasks = await self._create_manual_tasks()
                            
                            if manual_tasks:
                                confirm = input(f"æ‰‹å‹•å…¥åŠ›ã—ãŸã‚¿ã‚¹ã‚¯ {len(manual_tasks)} ä»¶ã‚’è¿½åŠ ã—ã¾ã™ã‹? (y/n): ").lower()
                                if confirm == 'y':
                                    added_count = await self.review_agent.add_suggested_tasks_to_sheet(
                                        task['task_id'], 
                                        manual_tasks
                                    )
                                    print(f"{added_count}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
                                    break
                            continue
                        
                        elif choice == 'c':
                            print("ã‚¿ã‚¹ã‚¯è¿½åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
                            break
                        
                        else:
                            print("ä¸æ­£ãªå…¥åŠ›ã§ã™ã€‚y, n, v, e, m, c ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
                            continue
                else:
                    logger.info("ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ: è¿½åŠ ã‚¿ã‚¹ã‚¯ä¸è¦")
            else:
                logger.info("ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ: è¿½åŠ ã‚¿ã‚¹ã‚¯ä¸è¦")
        
        except Exception as e:
            ErrorHandler.log_error(e, "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã‚¿ã‚¹ã‚¯è¿½åŠ ")
    
    def _display_suggested_tasks(self, tasks: List[Dict]):
        """ææ¡ˆã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        print("\n" + "="*60)
        print("ææ¡ˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯:")
        print("="*60)
        for i, task in enumerate(tasks, 1):
            print(f"\n{i}. {task.get('description', 'N/A')}")
            print(f"   æ‹…å½“: {task.get('required_role', 'N/A')}")
            print(f"   å„ªå…ˆåº¦: {task.get('priority', 'medium')}")
        print("="*60)
    
    async def _edit_suggested_tasks(self, tasks: List[Dict]) -> List[Dict]:
        """ææ¡ˆã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        print("\nç·¨é›†æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“")
        return tasks
    
    async def _create_manual_tasks(self) -> List[Dict]:
        """æ‰‹å‹•ã‚¿ã‚¹ã‚¯ä½œæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        print("\næ‰‹å‹•ä½œæˆæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“")
        return []
    
    async def run_all_tasks(self, auto_continue: bool = False, enable_review: bool = True):
        """
        å…¨ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰
        """
        try:
            logger.info("="*60)
            logger.info("ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé–‹å§‹")
            logger.info("="*60)
            
            iteration = 0
            tasks_executed = 0
            tasks_success = 0
            tasks_failed = 0
            failed_tasks_list = []
            
            while iteration < self.max_iterations:
                iteration += 1
                
                logger.info(f"\n{'='*60}")
                logger.info(f"åå¾© {iteration}/{self.max_iterations}")
                logger.info(f"{'='*60}")
                
                try:
                    pending_tasks = await self.load_pending_tasks()
                    
                    if not pending_tasks:
                        logger.info("âœ… å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ã¾ãŸã¯ä¿ç•™ã‚¿ã‚¹ã‚¯ãªã—")
                        break
                    
                    logger.info(f"ğŸ“‹ å®Ÿè¡Œäºˆå®šã‚¿ã‚¹ã‚¯: {len(pending_tasks)}ä»¶")
                    
                    for task in pending_tasks:
                        task_id = task.get('task_id', 'UNKNOWN')
                        
                        try:
                            logger.info(f"\n{'â”€'*60}")
                            logger.info(f"ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ: {task_id}")
                            logger.info(f"{'â”€'*60}")
                            
                            tasks_executed += 1
                            
                            success = await self.execute_task(task)
                            
                            if success:
                                tasks_success += 1
                                logger.info(f"âœ… ã‚¿ã‚¹ã‚¯ {task_id} æˆåŠŸ")
                            else:
                                tasks_failed += 1
                                failed_tasks_list.append({
                                    'task_id': task_id,
                                    'description': task.get('description', 'N/A')
                                })
                                logger.error(f"âŒ ã‚¿ã‚¹ã‚¯ {task_id} å¤±æ•—")
                            
                            if not auto_continue:
                                continue_task = input(
                                    f"\næ¬¡ã®ã‚¿ã‚¹ã‚¯ã«é€²ã¿ã¾ã™ã‹? "
                                    f"(y/n/a=ä»¥é™å…¨ã¦å®Ÿè¡Œ): "
                                ).lower()
                                
                                if continue_task == 'n':
                                    logger.info("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ä¸­æ–­")
                                    return
                                elif continue_task == 'a':
                                    auto_continue = True
                                    logger.info("è‡ªå‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ")
                            
                            await asyncio.sleep(2)
                            
                        except KeyboardInterrupt:
                            logger.warning("â¸ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ä¸­æ–­")
                            raise
                        
                        except Exception as e:
                            tasks_failed += 1
                            failed_tasks_list.append({
                                'task_id': task_id,
                                'description': task.get('description', 'N/A'),
                                'error': str(e)
                            })
                            
                            logger.error(f"âŒ ã‚¿ã‚¹ã‚¯ {task_id} ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼")
                            
                            if HAS_ENHANCED_HANDLER:
                                EnhancedErrorHandler.log_error_with_context(
                                    e,
                                    f"ã‚¿ã‚¹ã‚¯ {task_id} å®Ÿè¡Œä¸­"
                                )
                            
                            if not auto_continue:
                                cont = input(
                                    f"\nâš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç¶šè¡Œã—ã¾ã™ã‹? (y/n): "
                                ).lower()
                                if cont != 'y':
                                    logger.info("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ä¸­æ–­")
                                    break
                
                except Exception as e:
                    logger.error(f"âŒ åå¾© {iteration} å…¨ä½“ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ")
                    
                    if HAS_ENHANCED_HANDLER:
                        EnhancedErrorHandler.log_error_with_context(
                            e,
                            f"åå¾© {iteration}"
                        )
                    
                    if "critical" in str(e).lower():
                        logger.error("ğŸ’¥ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼æ¤œå‡º - å®Ÿè¡Œä¸­æ–­")
                        raise
                    
                    logger.warning("âš ï¸ éè‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ - æ¬¡ã®åå¾©ã¸")
                    continue
            
            # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
            self._print_execution_report(
                tasks_executed,
                tasks_success,
                tasks_failed,
                failed_tasks_list
            )
            
        except KeyboardInterrupt:
            logger.warning("\nâ¸ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ä¸­æ–­")
            raise
        
        except Exception as e:
            logger.error("âŒ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œå…¨ä½“ã§é‡å¤§ã‚¨ãƒ©ãƒ¼")
            
            if HAS_ENHANCED_HANDLER:
                EnhancedErrorHandler.log_error_with_context(
                    e,
                    "ã‚¿ã‚¹ã‚¯å®Ÿè¡Œå…¨ä½“"
                )
            
            raise
    
    def _print_execution_report(
        self, 
        total: int, 
        success: int, 
        failed: int, 
        failed_list: list
    ):
        """å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›"""
        print("\n" + "="*80)
        print("ğŸ“Š ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ")
        print("="*80)
        print(f"ç·å®Ÿè¡Œæ•°: {total}")
        print(f"âœ… æˆåŠŸ: {success}")
        print(f"âŒ å¤±æ•—: {failed}")
        
        if total > 0:
            success_rate = (success / total) * 100
            print(f"ğŸ“ˆ æˆåŠŸç‡: {success_rate:.1f}%")
        
        if failed_list:
            print("\nâŒ å¤±æ•—ã—ãŸã‚¿ã‚¹ã‚¯:")
            for item in failed_list:
                print(f"  - {item['task_id']}: {item['description'][:50]}...")
                if 'error' in item:
                    print(f"    ã‚¨ãƒ©ãƒ¼: {item['error'][:100]}")
        
        print("="*80)