# sheets_manager.py
"""Google Sheetsç®¡ç†ã‚¯ãƒ©ã‚¹(æ‹¡å¼µç‰ˆ: Google Driveå¯¾å¿œ)"""
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from google.auth import default
from google.auth.transport.requests import Request
from pathlib import Path
from typing import List, Dict, Optional
import logging
import re

from config_utils import config, ErrorHandler

logger = logging.getLogger(__name__)

class GoogleSheetsManager:
    """Google Sheetsç®¡ç†ã‚¯ãƒ©ã‚¹(æ‹¡å¼µç‰ˆ: Google Driveå¯¾å¿œ)"""
    
    # Google API ã‚¹ã‚³ãƒ¼ãƒ—ã®å®šç¾©
    GOOGLE_SHEETS_SCOPE = [
        'https://spreadsheets.google.com/feeds',
        'https://www.googleapis.com/auth/spreadsheets',
        'https://www.googleapis.com/auth/drive.file',
        'https://www.googleapis.com/auth/drive.readonly'
    ]
    
    def __init__(self, spreadsheet_id: str, service_account_file: Optional[str] = None):
        self.spreadsheet_id = spreadsheet_id
        self.service_account_file = service_account_file
        self.gc: Optional[gspread.Client] = None
        self.drive_service = None  # Google Drive APIç”¨
        self.setup_client()
    
    def setup_client(self) -> None:
        """Google Sheets ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®š"""
        try:
            if self.service_account_file and Path(self.service_account_file).exists():
                # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼
                creds = ServiceAccountCredentials.from_json_keyfile_name(
                    self.service_account_file, self.GOOGLE_SHEETS_SCOPE)
                self.gc = gspread.authorize(creds)
                
                # Google Drive APIç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚åˆæœŸåŒ–
                self._setup_drive_service(creds)
                
                logger.info("âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ Google Sheets ã«æ¥ç¶šã—ã¾ã—ãŸ")
            else:
                # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                try:
                    creds, project = default(scopes=self.GOOGLE_SHEETS_SCOPE)
                    if creds.expired and creds.refresh_token:
                        creds.refresh(Request())
                    self.gc = gspread.authorize(creds)
                    
                    # Google Drive APIç”¨
                    self._setup_drive_service(creds)
                    
                    logger.info("âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼ã§ Google Sheets ã«æ¥ç¶šã—ã¾ã—ãŸ")
                except Exception as e:
                    logger.warning(f"âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
                    logger.warning("ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã§ã™")
                    self.gc = None
                    
        except Exception as e:
            ErrorHandler.log_error(e, "Google Sheets ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š")
            self.gc = None
    
    def _setup_drive_service(self, creds):
        """Google Drive APIã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–"""
        try:
            from googleapiclient.discovery import build
            self.drive_service = build('drive', 'v3', credentials=creds)
            logger.info("âœ… Google Drive APIã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ")
        except Exception as e:
            logger.warning(f"âš ï¸ Google Drive APIã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—: {e}")
            self.drive_service = None
    
    def _ensure_client(self) -> None:
        """ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"""
        if not self.gc:
            raise Exception("Google Sheets ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
    
    async def load_tasks_from_sheet(self, sheet_name: str = "pm_tasks") -> List[Dict]:
        """æŒ‡å®šã•ã‚ŒãŸã‚·ãƒ¼ãƒˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã‚¨ãƒ©ãƒ¼ä¿®æ­£ç‰ˆï¼‰"""
        try:
            self._ensure_client()
        
            sheet = self.gc.open_by_key(self.spreadsheet_id)
        
            try:
                task_sheet = sheet.worksheet(sheet_name)
            except gspread.exceptions.WorksheetNotFound:
                logger.error(f"âŒ ã‚·ãƒ¼ãƒˆ '{sheet_name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return []
        
            # â˜…â˜…â˜… ä¿®æ­£: ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®å•é¡Œã‚’å›é¿ã™ã‚‹æ–¹æ³• â˜…â˜…â˜…
            try:
                # æ–¹æ³•1: get_all_records() ã‚’è©¦ã™
                records = task_sheet.get_all_records()
                logger.info(f"âœ… get_all_records() ã§ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: {len(records)}è¡Œ")
            except Exception as e:
                logger.warning(f"âš ï¸ get_all_records() å¤±æ•—: {e}")
                logger.info("ğŸ”§ ä»£æ›¿æ–¹æ³•ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™...")
                
                # æ–¹æ³•2: ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æ‰‹å‹•ã§å‡¦ç†
                all_values = task_sheet.get_all_values()
                
                if len(all_values) <= 1:
                    logger.info("ğŸ“­ ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“")
                    return []
                
                # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—
                headers = all_values[0]
                logger.info(f"ğŸ“‹ ãƒ˜ãƒƒãƒ€ãƒ¼: {headers}")
                
                # ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡¦ç†
                records = []
                for i, row in enumerate(all_values[1:], start=2):
                    if not any(row):  # ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                        continue
                    
                    record = {}
                    for j, header in enumerate(headers):
                        if j < len(row) and header:  # ãƒ˜ãƒƒãƒ€ãƒ¼ãŒç©ºã§ãªã„å ´åˆã®ã¿
                            record[header] = row[j]
                        elif j < len(row):
                            record[f'column_{j+1}'] = row[j]  # ç©ºãƒ˜ãƒƒãƒ€ãƒ¼ã®å ´åˆ
                    
                    records.append(record)
                
                logger.info(f"âœ… ä»£æ›¿æ–¹æ³•ã§ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: {len(records)}è¡Œ")
        
            tasks = []
            for i, record in enumerate(records, start=2):
                # ã‚¿ã‚¹ã‚¯IDã®å‡¦ç†ã‚’æ”¹å–„
                task_id = str(record.get('task_id', '')).strip()
                if not task_id and 'task_id' not in record:
                    # æœ€åˆã®åˆ—ã‚’ã‚¿ã‚¹ã‚¯IDã¨ã—ã¦ä½¿ç”¨
                    first_col = list(record.values())[0] if record else ''
                    task_id = str(first_col).strip()
                
                task = {
                    'task_id': task_id,
                    'description': record.get('task_description', record.get('description', '')),
                    'required_role': record.get('required_role', ''),
                    'status': record.get('status', ''),
                    'priority': record.get('priority', 'medium'),
                    'estimated_time': record.get('estimated_time', ''),
                    'dependencies': record.get('dependencies', ''),
                    'created_at': record.get('created_at', ''),
                    'batch_id': record.get('batch_id', ''),
                    'review_target_task_id': record.get('review_target_task_id', ''),
                    'post_action': record.get('post_action', ''),
                    'language': record.get('language', ''),
                    'polylang_lang': record.get('polylang_lang', '')
                }
                
                # åŸºæœ¬çš„ãªæ¤œè¨¼
                if task['description'] and task['required_role']:
                    tasks.append(task)
        
            logger.info(f"ğŸ“Š ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿: {len(tasks)}ä»¶ï¼ˆã‚·ãƒ¼ãƒˆ: {sheet_name}ï¼‰")
            
            # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            if tasks:
                logger.info(f"ğŸ“ æœ€åˆã®ã‚¿ã‚¹ã‚¯: {tasks[0].get('description', '')[:50]}...")
            else:
                logger.info("ğŸ“­ èª­ã¿è¾¼ã¾ã‚ŒãŸã‚¿ã‚¹ã‚¯ã¯0ä»¶ã§ã™")
                
            return tasks
        
        except Exception as e:
            logger.error(f"âŒ ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆã‚·ãƒ¼ãƒˆ: {sheet_name}ï¼‰: {e}")
            return []

    async def load_tasks_from_sheet(self, sheet_name: str = 'pm_tasks') -> List[Dict]:
        """
        ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã‚¨ãƒ©ãƒ¼å¯¾ç­–å¼·åŒ–ç‰ˆï¼‰
        """
        try:
            logger.info(f"ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿é–‹å§‹: ã‚·ãƒ¼ãƒˆ={sheet_name}")
                
            sheet = self.gc.open_by_key(self.spreadsheet_id)
            task_sheet = sheet.worksheet(sheet_name)
                
            all_values = task_sheet.get_all_values()
                
            if not all_values or len(all_values) < 2:
                logger.warning(f"ã‚·ãƒ¼ãƒˆ '{sheet_name}' ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
                return []
                
            # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—ï¼ˆç©ºç™½ã‚’é™¤å»ï¼‰
            raw_headers = all_values[0]
                
            # ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨ãƒãƒƒãƒ”ãƒ³ã‚°
            header_mapping = {}
            for col_index, header in enumerate(raw_headers):
                clean_header = str(header).strip().lower()
                if clean_header:
                    header_mapping[clean_header] = col_index
                
            logger.info(f"æ¤œå‡ºã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼: {list(header_mapping.keys())}")
                
            # ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿
            tasks = []
            for row_index, row in enumerate(all_values[1:], start=2):
                try:
                    task = {}
                        
                    # å„åˆ—ã®å€¤ã‚’å–å¾—
                    for header, col_index in header_mapping.items():
                        if col_index < len(row):
                            value = row[col_index]
                                
                            # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®æ­£è¦åŒ–
                            if header in ['task_id', 'id']:
                                task['task_id'] = value
                            elif header in ['description', 'task_description']:
                                task['description'] = value
                            elif header in ['required_role', 'role']:
                                task['required_role'] = value
                            elif header == 'status':
                                task['status'] = value
                            elif header == 'priority':
                                task['priority'] = value
                            elif header in ['dependencies', 'depends_on']:
                                task['dependencies'] = value
                            elif header == 'parameters':
                                task['parameters'] = value
                            else:
                                task[header] = value
                        
                    # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                    if not task.get('task_id'):
                        logger.warning(f"è¡Œ {row_index}: task_id ãŒã‚ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—")
                        continue
                        
                    if not task.get('description'):
                        logger.warning(f"è¡Œ {row_index}: description ãŒã‚ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—")
                        continue
                        
                    if not task.get('required_role'):
                        logger.warning(f"è¡Œ {row_index}: required_role ãŒã‚ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 'dev' ã‚’ä½¿ç”¨")
                        task['required_role'] = 'dev'
                        
                    if not task.get('status'):
                        logger.warning(f"è¡Œ {row_index}: status ãŒã‚ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 'pending' ã‚’ä½¿ç”¨")
                        task['status'] = 'pending'
                        
                    tasks.append(task)
                    logger.debug(f"ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿: {task['task_id']} - {task['description'][:50]}...")
                        
                except Exception as e:
                    logger.error(f"è¡Œ {row_index} ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
                    continue
                
            logger.info(f"âœ… ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿å®Œäº†: {len(tasks)}ä»¶")
            return tasks
                
        except Exception as e:
            logger.error(f"ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            import traceback
            logger.error(traceback.format_exc())
            return []

    async def save_task_output(self, output_data: Dict):
        """ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›ã‚’ä¿å­˜"""
        try:
            self._ensure_client()
        
            sheet = self.gc.open_by_key(self.spreadsheet_id)
        
            # å‡ºåŠ›ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            try:
                output_sheet = sheet.worksheet("task_outputs")
            except gspread.exceptions.WorksheetNotFound:
                # ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                logger.info("'task_outputs' ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™")
                output_sheet = sheet.add_worksheet(title="task_outputs", rows=1000, cols=10)
                # ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
                headers = ["task_id", "summary", "full_text", "screenshot", "timestamp"]
                output_sheet.append_row(headers)
        
            # ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            row = [
                output_data.get('task_id', ''),
                output_data.get('summary', ''),
                output_data.get('full_text', ''),
                output_data.get('screenshot', ''),
                output_data.get('timestamp', '')
            ]
            output_sheet.append_row(row)
        
            logger.info(f"âœ… ã‚¿ã‚¹ã‚¯å‡ºåŠ›ã‚’ä¿å­˜: {output_data.get('task_id', '')}")
            return True
        
        except Exception as e:
            ErrorHandler.log_error(e, "ã‚¿ã‚¹ã‚¯å‡ºåŠ›ä¿å­˜")
            return False
    
    def save_result_to_sheet(self, results: List[Dict], mode: str = "text") -> None:
        """
        çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
        
        Args:
            results: çµæœã®ãƒªã‚¹ãƒˆ
            mode: "text" ã¾ãŸã¯ "image"
        """
        try:
            self._ensure_client()
            
            sheet = self.gc.open_by_key(self.spreadsheet_id)
            
            # çµæœã‚·ãƒ¼ãƒˆåã‚’æ±ºå®š
            result_sheet_name = f"result_{mode}"
            
            # ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            try:
                result_sheet = sheet.worksheet(result_sheet_name)
            except gspread.exceptions.WorksheetNotFound:
                logger.info(f"ã‚·ãƒ¼ãƒˆ '{result_sheet_name}' ã‚’ä½œæˆã—ã¾ã™")
                result_sheet = sheet.add_worksheet(title=result_sheet_name, rows=1000, cols=10)
                
                # ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
                headers = ['Index', 'Prompt', 'Status', 'Filename', 'Timestamp', 'Error', 'Mode']
                result_sheet.append_row(headers)
            
            # çµæœã‚’è¿½åŠ 
            for result in results:
                row = [
                    result.get('index', ''),
                    result.get('prompt', '')[:100],  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯æœ€åˆã®100æ–‡å­—
                    result.get('status', ''),
                    result.get('filename', ''),
                    result.get('timestamp', ''),
                    result.get('error', ''),
                    result.get('mode', mode)
                ]
                result_sheet.append_row(row)
            
            logger.info(f"âœ… {len(results)}ä»¶ã®çµæœã‚’ '{result_sheet_name}' ã«ä¿å­˜ã—ã¾ã—ãŸ")
            
        except Exception as e:
            ErrorHandler.log_error(e, "çµæœä¿å­˜")
            logger.warning("çµæœã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™")
    
    def extract_file_id_from_url(self, url: str) -> Optional[str]:
        """
        Google Driveã®URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡º
        
        å¯¾å¿œå½¢å¼:
        - https://drive.google.com/file/d/FILE_ID/view
        - https://drive.google.com/open?id=FILE_ID
        - https://docs.google.com/document/d/FILE_ID/edit
        """
        patterns = [
            r'/file/d/([a-zA-Z0-9_-]+)',
            r'id=([a-zA-Z0-9_-]+)',
            r'/d/([a-zA-Z0-9_-]+)',
        ]
        
        for pattern in patterns:
            match = re.search(pattern, url)
            if match:
                file_id = match.group(1)
                logger.info(f"âœ… ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡º: {file_id}")
                return file_id
        
        logger.warning(f"âš ï¸ URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ: {url}")
        return None
    
    def read_file_from_drive(self, file_id_or_url: str) -> Optional[str]:
        """
        Google Driveã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦èª­ã¿è¾¼ã‚€ï¼ˆè¶…è©³ç´°ãƒ­ã‚°ç‰ˆï¼‰
        
        Args:
            file_id_or_url: ãƒ•ã‚¡ã‚¤ãƒ«ID ã¾ãŸã¯ Google Driveã®URL
            
        Returns:
            ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€å¤±æ•—æ™‚ã¯None
        """
        try:
            logger.info("="*60)
            logger.info("ã€Google Driveèª­ã¿è¾¼ã¿é–‹å§‹ã€‘")
            logger.info("="*60)
            
            # åˆ‡ã‚Šåˆ†ã‘1: Drive APIã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª
            logger.info("ã€åˆ‡ã‚Šåˆ†ã‘1ã€‘Drive APIã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¢ºèª")
            if not self.drive_service:
                logger.error("âŒ Google Drive APIã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
                logger.error("  â†’ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„")
                return None
            logger.info("âœ… Drive APIã‚µãƒ¼ãƒ“ã‚¹: æ­£å¸¸")
            
            # åˆ‡ã‚Šåˆ†ã‘2: URLã‹ãƒ•ã‚¡ã‚¤ãƒ«IDã‹ã‚’åˆ¤å®š
            logger.info("ã€åˆ‡ã‚Šåˆ†ã‘2ã€‘å…¥åŠ›å€¤ã‚’è§£æ")
            logger.info(f"  å…¥åŠ›: {file_id_or_url[:100]}")
            
            if file_id_or_url.startswith('http'):
                logger.info("  â†’ URLå½¢å¼ã¨åˆ¤å®š")
                file_id = self.extract_file_id_from_url(file_id_or_url)
                if not file_id:
                    logger.error("âŒ URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ")
                    return None
                logger.info(f"âœ… ãƒ•ã‚¡ã‚¤ãƒ«IDæŠ½å‡ºæˆåŠŸ: {file_id}")
            else:
                file_id = file_id_or_url
                logger.info(f"  â†’ ãƒ•ã‚¡ã‚¤ãƒ«IDå½¢å¼: {file_id}")
            
            # åˆ‡ã‚Šåˆ†ã‘3: ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
            logger.info("ã€åˆ‡ã‚Šåˆ†ã‘3ã€‘ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—")
            try:
                from googleapiclient.http import MediaIoBaseDownload
                import io
                
                file_metadata = self.drive_service.files().get(
                    fileId=file_id, 
                    fields='name,mimeType,size,permissions'
                ).execute()
                
                file_name = file_metadata.get('name', 'Unknown')
                mime_type = file_metadata.get('mimeType', '')
                file_size = file_metadata.get('size', '0')
                
                logger.info("âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ")
                logger.info(f"  ãƒ•ã‚¡ã‚¤ãƒ«å: {file_name}")
                logger.info(f"  MIME Type: {mime_type}")
                logger.info(f"  ã‚µã‚¤ã‚º: {file_size} bytes")
                
            except Exception as e:
                logger.error(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
                logger.error("  è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :")
                logger.error("  - ãƒ•ã‚¡ã‚¤ãƒ«IDãŒé–“é•ã£ã¦ã„ã‚‹")
                logger.error("  - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ¨©é™ãŒãªã„")
                logger.error("  - ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹")
                return None
            
            # åˆ‡ã‚Šåˆ†ã‘4: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            logger.info("ã€åˆ‡ã‚Šåˆ†ã‘4ã€‘ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")
            try:
                request = self.drive_service.files().get_media(fileId=file_id)
                
                fh = io.BytesIO()
                downloader = MediaIoBaseDownload(fh, request)
                
                done = False
                chunk_count = 0
                while not done:
                    status, done = downloader.next_chunk()
                    chunk_count += 1
                    if status:
                        progress = int(status.progress() * 100)
                        logger.debug(f"  â³ ãƒãƒ£ãƒ³ã‚¯{chunk_count}: {progress}%")
                
                logger.info(f"âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: {chunk_count}ãƒãƒ£ãƒ³ã‚¯")
                
            except Exception as e:
                logger.error(f"âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
                return None
            
            # åˆ‡ã‚Šåˆ†ã‘5: ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
            logger.info("ã€åˆ‡ã‚Šåˆ†ã‘5ã€‘ãƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›")
            try:
                content = fh.getvalue().decode('utf-8')
                logger.info(f"âœ… å¤‰æ›æˆåŠŸ: {len(content)}æ–‡å­—")
                logger.info(f"  å…ˆé ­100æ–‡å­—: {content[:100]}...")
                
                # å†…å®¹ã®æ¤œè¨¼
                if len(content) < 10:
                    logger.warning(f"âš ï¸ å†…å®¹ãŒçŸ­ã™ãã¾ã™: {len(content)}æ–‡å­—")
                
                return content
                
            except UnicodeDecodeError as e:
                logger.error(f"âŒ UTF-8ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
                logger.error("  â†’ ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã¯ãªã„å¯èƒ½æ€§")
                return None
            except Exception as e:
                logger.error(f"âŒ å¤‰æ›ã‚¨ãƒ©ãƒ¼: {e}")
                return None
            
        except Exception as e:
            logger.error(f"âŒ Google Driveãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            import traceback
            traceback.print_exc()
            return None
    
    def get_current_pc_id(self) -> int:
        """ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®B12ã‚»ãƒ«ã‹ã‚‰PC_IDã‚’èª­ã¿å–ã‚‹"""
        try:
            self._ensure_client()
            
            sheet = self.gc.open_by_key(self.spreadsheet_id)
            setting_sheet = sheet.worksheet("setting")
            
            pc_id_value = setting_sheet.cell(12, 2).value
            
            if pc_id_value:
                try:
                    pc_id = int(pc_id_value)
                    logger.info(f"âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰PC_ID={pc_id}ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ(ã‚»ãƒ«B12)")
                    return pc_id
                except ValueError:
                    logger.warning(f"âš ï¸ B12ã‚»ãƒ«ã®å€¤ '{pc_id_value}' ã‚’æ•´æ•°ã«å¤‰æ›ã§ãã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤1ã‚’ä½¿ç”¨ã—ã¾ã™")
                    return 1
            else:
                logger.warning("âš ï¸ B12ã‚»ãƒ«ãŒç©ºã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤1ã‚’ä½¿ç”¨ã—ã¾ã™")
                return 1
                
        except Exception as e:
            ErrorHandler.log_error(e, "PC_IDèª­ã¿å–ã‚Š")
            logger.warning("âš ï¸ PC_IDã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤1ã‚’ä½¿ç”¨ã—ã¾ã™")
            return 1
    
    def load_pc_settings(self, pc_id: int = 1) -> Dict[str, str]:
        """PCå›ºæœ‰ã®è¨­å®šã‚’settingã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿"""
        try:
            self._ensure_client()
        
            sheet = self.gc.open_by_key(self.spreadsheet_id)
            setting_sheet = sheet.worksheet("setting")
        
            col_index = 1 + pc_id
        
            settings = {
                'google_id': self._get_cell_value(setting_sheet, 2, col_index),
                'google_pass': self._get_cell_value(setting_sheet, 3, col_index),
                'service_mail': self._get_cell_value(setting_sheet, 4, col_index),
                'download_image_folder': self._get_cell_value(setting_sheet, 5, col_index),
                'download_text_folder': self._get_cell_value(setting_sheet, 6, col_index),
                'browser_data_dir': self._get_cell_value(setting_sheet, 7, col_index),
                'service_account_file': self._get_cell_value(setting_sheet, 8, col_index),
                'cookies_file': self._get_cell_value(setting_sheet, 9, col_index),
                'generation_mode': self._get_cell_value(setting_sheet, 10, col_index),
                'text_format': self._get_cell_value(setting_sheet, 11, col_index),
                'service_type': self._get_cell_value(setting_sheet, 13, col_index),
                'agent_output_folder': self._get_cell_value(setting_sheet, 14, col_index),
                'max_iterations': self._get_cell_value(setting_sheet, 15, col_index),
                'wp_url': self._get_cell_value(setting_sheet, 16, col_index),
                'wp_user': self._get_cell_value(setting_sheet, 17, col_index),
                'wp_pass': self._get_cell_value(setting_sheet, 18, col_index),
            }
        
            # æ¤œè¨¼å‡¦ç†
            mode = settings.get('generation_mode', '').strip().lower()
            if mode not in ['text', 'image']:
                logger.warning(f"âš ï¸ ä¸æ­£ãªgeneration_modeå€¤: '{mode}' â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 'image' ã‚’ä½¿ç”¨")
                settings['generation_mode'] = 'image'
            else:
                settings['generation_mode'] = mode
        
            try:
                max_iter = int(settings.get('max_iterations', '3'))
                if max_iter < 1 or max_iter > 10:
                    logger.warning(f"âš ï¸ ä¸æ­£ãªmax_iterationså€¤: {max_iter} â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 3 ã‚’ä½¿ç”¨")
                    settings['max_iterations'] = 3
                else:
                    settings['max_iterations'] = max_iter
            except (ValueError, TypeError):
                logger.warning(f"âš ï¸ max_iterationsã®å¤‰æ›ã‚¨ãƒ©ãƒ¼ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 3 ã‚’ä½¿ç”¨")
                settings['max_iterations'] = 3
        
            logger.info(f"âœ… PC_ID={pc_id} ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ")
            return settings
        
        except Exception as e:
            ErrorHandler.log_error(e, f"PC_ID={pc_id} ã®è¨­å®šèª­ã¿è¾¼ã¿")
            raise

    def _get_cell_value(self, sheet, row: int, col: int) -> str:
        """ã‚»ãƒ«ã®å€¤ã‚’å®‰å…¨ã«å–å¾—"""
        try:
            value = sheet.cell(row, col).value
            return value if value is not None else ""
        except Exception:
            return ""
    
    def _get_column_letter(self, col_index: int) -> str:
        """åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ—æ–‡å­—ã«å¤‰æ›(1â†’A, 2â†’B, ...)"""
        result = ""
        while col_index > 0:
            col_index -= 1
            result = chr(col_index % 26 + ord('A')) + result
            col_index //= 26
        return result
    
    def load_credentials_from_sheet(self, pc_id: int = 1) -> Dict[str, str]:
        """èªè¨¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿(PC_IDå¯¾å¿œç‰ˆ)"""
        try:
            settings = self.load_pc_settings(pc_id)
            
            credentials = {
                'email': settings['google_id'],
                'password': settings['google_pass'],
                'service_mail': settings.get('service_mail')
            }
            
            return credentials
            
        except Exception as e:
            ErrorHandler.log_error(e, "èªè¨¼æƒ…å ±èª­ã¿è¾¼ã¿")
            raise
    
    def validate_sheet_structure(self) -> bool:
        """ã‚·ãƒ¼ãƒˆæ§‹é€ ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯"""
        try:
            self._ensure_client()
            
            sheet = self.gc.open_by_key(self.spreadsheet_id)
            
            required_sheets = ["setting"]
            existing_sheets = [ws.title for ws in sheet.worksheets()]
            
            for required_sheet in required_sheets:
                if required_sheet not in existing_sheets:
                    logger.error(f"âŒ å¿…è¦ãªã‚·ãƒ¼ãƒˆ '{required_sheet}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    return False
            
            if "prompt_text" not in existing_sheets and "prompt" not in existing_sheets:
                logger.error("âŒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚·ãƒ¼ãƒˆ ('prompt_text' ã¾ãŸã¯ 'prompt') ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return False
            
            logger.info("âœ… ã‚·ãƒ¼ãƒˆæ§‹é€ ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯å®Œäº†")
            return True
            
        except Exception as e:
            ErrorHandler.log_error(e, "ã‚·ãƒ¼ãƒˆæ§‹é€ ãƒã‚§ãƒƒã‚¯")
            return False