# run_multi_agent.py
# ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆã‚¨ãƒ©ãƒ¼å¯¾ç­–å¼·åŒ–ç‰ˆï¼‰
import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

import asyncio
import logging
from pathlib import Path
import argparse

# ===== æœ€å„ªå…ˆ: ãƒ­ã‚°è¨­å®š =====
from config_utils import config, ErrorHandler, PathManager

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    from error_handler_enhanced import (
        EnhancedErrorHandler,
        BrowserErrorHandler,
        SheetErrorHandler,
        TaskErrorHandler
    )
    logger = logging.getLogger(__name__)
    logger.info("âœ… å¼·åŒ–ç‰ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼èª­ã¿è¾¼ã¿æˆåŠŸ")
except ImportError:
    logger = logging.getLogger(__name__)
    logger.warning("âš ï¸ error_handler_enhanced.py ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ¨™æº–ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ä½¿ç”¨ï¼‰")
    EnhancedErrorHandler = None
    BrowserErrorHandler = None

# ãã®ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from sheets_manager import GoogleSheetsManager
from browser_controller import BrowserController
from pm_agent import PMAgent
from task_executor import TaskExecutor
from design_agent import DesignAgent
from dev_agent import DevAgent
from review_agent import ReviewAgent


class MultiAgentOrchestrator:
    """ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆã‚¨ãƒ©ãƒ¼å¯¾ç­–å¼·åŒ–ç‰ˆï¼‰"""

    def __init__(self, pc_id: int = None, max_iterations: int = None):
        self.pc_id = pc_id or 1
        self.max_iterations = max_iterations
        self.sheets_manager = None
        self.browser = None
        self.pm_agent = None
        self.task_executor = None
        self.design_agent = None
        self.dev_agent = None
        self.review_agent = None
        self.content_writer = None
        self.wordpress_agent = None
        self.output_folder = None
        self.initialization_success = False

    def _is_url(self, path_str: str) -> bool:
        """æ–‡å­—åˆ—ãŒURLã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
        if not path_str:
            return False
        path_lower = path_str.lower().strip()
        return path_lower.startswith('http://') or path_lower.startswith('https://')

    async def _find_service_account_file(self) -> str:
        """ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰"""
        logger.info("ğŸ“ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­...")
        
        possible_paths = [
            Path.cwd() / "service_account.json",
            Path.home() / "Documents" / "gemini_auto_generate" / "service_account.json",
            Path.home() / "Documents" / "AI_Agent" / "service_account.json",
            Path.home() / "Documents" / "gemini_AI_Agent" / "service_account.json",
            Path(__file__).parent / "service_account.json",
        ]
        
        # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã‚‚è©¦è¡Œ
        env_path = os.environ.get('SERVICE_ACCOUNT_FILE')
        if env_path:
            possible_paths.insert(0, Path(env_path))
        
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§æ¤œç´¢
        for path in possible_paths:
            if not path:
                continue
            
            if EnhancedErrorHandler:
                validated_path = EnhancedErrorHandler.validate_file_path(path, must_exist=True)
                if validated_path:
                    logger.info(f"âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: {validated_path}")
                    return str(validated_path)
            else:
                if path.exists():
                    logger.info(f"âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: {path}")
                    return str(path)
        
        raise FileNotFoundError(
            "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n"
            "ä»¥ä¸‹ã®å ´æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n" +
            "\n".join(f"  - {p}" for p in possible_paths if p)
        )

    async def _initialize_browser_with_retry(self, max_retries: int = 3) -> bool:
        """ãƒ–ãƒ©ã‚¦ã‚¶åˆæœŸåŒ–ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰"""
        logger.info("="*60)
        logger.info("ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶åˆæœŸåŒ–é–‹å§‹...")
        logger.info("="*60)
        
        for retry in range(1, max_retries + 1):
            try:
                logger.info(f"ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•è©¦è¡Œ {retry}/{max_retries}")
                
                self.browser = BrowserController(self.output_folder, mode='text', service='google')
                
                # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§èµ·å‹•
                if EnhancedErrorHandler:
                    await EnhancedErrorHandler.timeout_wrapper(
                        self.browser.setup_browser(),
                        timeout=60.0,
                        context="ãƒ–ãƒ©ã‚¦ã‚¶åˆæœŸåŒ–"
                    )
                else:
                    await asyncio.wait_for(self.browser.setup_browser(), timeout=60.0)
                
                # èµ·å‹•ç¢ºèªï¼ˆå°‘ã—å¾…æ©Ÿï¼‰
                await asyncio.sleep(2)
                
                if self.browser.page:
                    # å‹•ä½œç¢ºèª
                    test_result = await self.browser.page.evaluate("1 + 1")
                    if test_result == 2:
                        logger.info(f"âœ… ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•æˆåŠŸï¼ˆè©¦è¡Œ {retry}ï¼‰")
                        return True
                
                raise Exception("ãƒ–ãƒ©ã‚¦ã‚¶å‹•ä½œç¢ºèªå¤±æ•—")
                
            except asyncio.TimeoutError:
                logger.error(f"â±ï¸ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆè©¦è¡Œ {retry}ï¼‰")
                
            except Exception as e:
                logger.error(f"âŒ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•å¤±æ•—ï¼ˆè©¦è¡Œ {retry}ï¼‰: {e}")
            
            # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if EnhancedErrorHandler:
                await EnhancedErrorHandler.safe_cleanup(
                    self.browser.cleanup if self.browser else lambda: None,
                    f"ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆè©¦è¡Œ {retry}ï¼‰"
                )
            else:
                try:
                    if self.browser:
                        await self.browser.cleanup()
                except:
                    pass
            
            if retry < max_retries:
                logger.info(f"â³ 5ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™...")
                await asyncio.sleep(5)
            else:
                logger.error("="*60)
                logger.error("âŒ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ãŒå…¨ã¦å¤±æ•—ã—ã¾ã—ãŸ")
                logger.error("="*60)
                self._print_browser_troubleshooting()
                return False
        
        return False

    def _print_browser_troubleshooting(self):
        """ãƒ–ãƒ©ã‚¦ã‚¶ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰"""
        logger.error("\nğŸ“‹ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:")
        logger.error("1. âœ… æ—¢å­˜ã®Chromeãƒ—ãƒ­ã‚»ã‚¹ã‚’å…¨ã¦çµ‚äº†")
        logger.error("2. ğŸ“ ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ç¢ºèª")
        logger.error(f"     â†’ {config.BROWSER_DATA_DIR}")
        logger.error("3. ğŸ”§ Playwrightã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:")
        logger.error("     â†’ playwright install chromium")
        logger.error("4. ğŸ—‘ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢:")
        logger.error(f"     â†’ {config.BROWSER_DATA_DIR} ã‚’å‰Šé™¤")
        logger.error("5. ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ã®å†èµ·å‹•")

    async def _initialize_wordpress_agent(self, wp_url: str, wp_user: str, wp_pass: str):
        """WordPressã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰"""
        try:
            # ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            if EnhancedErrorHandler:
                has_module = EnhancedErrorHandler.handle_import_error(
                    'wordpress.wp_agent',
                    optional=True
                )
                if not has_module:
                    logger.warning("âš ï¸ WordPressãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    return None
            
            from wordpress.wp_agent import WordPressAgent
            
            wp_credentials = {
                'wp_url': wp_url,
                'wp_user': wp_user,
                'wp_pass': wp_pass
            }
            
            logger.info("ğŸŒ WordPressã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–ä¸­...")
            self.wordpress_agent = WordPressAgent(self.browser, wp_credentials)
            self.wordpress_agent.sheets_manager = self.sheets_manager
            
            logger.info("ğŸ” WordPressã¸ã®ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­...")
            
            # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ããƒ­ã‚°ã‚¤ãƒ³
            if EnhancedErrorHandler:
                wp_login_success = await EnhancedErrorHandler.timeout_wrapper(
                    self.wordpress_agent.initialize_wp_session(),
                    timeout=60.0,
                    context="WordPressãƒ­ã‚°ã‚¤ãƒ³"
                )
            else:
                wp_login_success = await asyncio.wait_for(
                    self.wordpress_agent.initialize_wp_session(),
                    timeout=60.0
                )
            
            if wp_login_success:
                self.task_executor.register_agent('wordpress', self.wordpress_agent)
                logger.info("âœ… WordPressã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™»éŒ²å®Œäº†")
                return self.wordpress_agent
            else:
                logger.warning("âš ï¸ WordPressãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰")
                return None
                
        except Exception as e:
            logger.error(f"WordPressã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
            if EnhancedErrorHandler:
                EnhancedErrorHandler.log_error_with_context(e, "WordPressåˆæœŸåŒ–")
            return None

    async def initialize(self):
        """ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼å¯¾ç­–å¼·åŒ–ç‰ˆï¼‰"""
        try:
            print("="*60)
            print("ğŸš€ ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...")
            print("="*60)
        
            # 1. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
            service_account_file = await self._find_service_account_file()
            
            # 2. Sheets ManageråˆæœŸåŒ–
            logger.info("ğŸ“Š Google Sheets æ¥ç¶šã‚’åˆæœŸåŒ–ä¸­...")
            self.sheets_manager = GoogleSheetsManager(config.SPREADSHEET_ID, service_account_file)
        
            # 3. PCè¨­å®šèª­ã¿è¾¼ã¿
            if self.pc_id is None:
                self.pc_id = self.sheets_manager.get_current_pc_id()
                logger.info(f"PC_ID={self.pc_id} ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—")
        
            logger.info(f"âš™ï¸ PC_ID={self.pc_id} ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...")
            settings = self.sheets_manager.load_pc_settings(self.pc_id)
            
            # 4. è¨­å®šã®é©ç”¨
            config.BROWSER_DATA_DIR = settings.get('browser_data_dir')
            config.COOKIES_FILE = settings.get('cookies_file')
            config.GENERATION_MODE = 'text'
            config.SERVICE_TYPE = 'google'
            
            # 5. å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€è¨­å®š
            agent_output_setting = settings.get('agent_output_folder', '').strip()
            
            if not agent_output_setting or self._is_url(agent_output_setting):
                if agent_output_setting:
                    logger.warning(f"âš ï¸ B14ãŒURLå½¢å¼ã®ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ç”¨")
                user_docs = Path.home() / "Documents" / "gemini_auto_generate" / "agent_outputs"
                self.output_folder = user_docs
                self.output_folder.mkdir(exist_ok=True, parents=True)
                logger.info(f"ğŸ“ Agentå‡ºåŠ›å…ˆ: {self.output_folder}")
            else:
                config.AGENT_OUTPUT_FOLDER = agent_output_setting
                self.output_folder = PathManager.get_safe_path(config.AGENT_OUTPUT_FOLDER)
                logger.info(f"ğŸ“ Agentå‡ºåŠ›å…ˆ(B14ã‹ã‚‰å–å¾—): {self.output_folder}")
            
            config.MAX_ITERATIONS = settings.get('max_iterations', 3)
            
            if self.max_iterations is None:
                self.max_iterations = config.MAX_ITERATIONS
        
            # 6. ãƒ–ãƒ©ã‚¦ã‚¶åˆæœŸåŒ–ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
            browser_success = await self._initialize_browser_with_retry(max_retries=3)
            
            if not browser_success:
                raise Exception("ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
            # 7. GeminiãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            logger.info("="*60)
            logger.info("ğŸŒ Geminiã‚µã‚¤ãƒˆã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...")
            logger.info("="*60)
            
            if EnhancedErrorHandler:
                await EnhancedErrorHandler.timeout_wrapper(
                    self.browser.navigate_to_gemini(),
                    timeout=60.0,
                    context="GeminiãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³"
                )
            else:
                await asyncio.wait_for(self.browser.navigate_to_gemini(), timeout=60.0)
        
            # 8. WordPressèªè¨¼æƒ…å ±ã‚’å–å¾—
            wp_url = settings.get('wp_url', '').strip()
            wp_user = settings.get('wp_user', '').strip()
            wp_pass = settings.get('wp_pass', '').strip()
        
            # 9. å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
            logger.info("="*60)
            logger.info("ğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–é–‹å§‹...")
            logger.info("="*60)
            
            self.pm_agent = PMAgent(self.sheets_manager, self.browser)
            self.task_executor = TaskExecutor(
                self.sheets_manager, 
                self.browser,
                max_iterations=self.max_iterations
            )
        
            self.design_agent = DesignAgent(self.browser)
            self.dev_agent = DevAgent(self.browser)
            
            # ReviewAgentã®åˆæœŸåŒ–
            self.review_agent = ReviewAgent()
            self.review_agent.browser = self.browser
            self.review_agent.sheets_manager = self.sheets_manager
        
            # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™»éŒ²
            self.task_executor.register_agent('design', self.design_agent)
            self.task_executor.register_agent('dev', self.dev_agent)
            self.task_executor.register_review_agent(self.review_agent)
            
            # 10. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            try:
                from content_writer_agent import ContentWriterAgent
                self.content_writer = ContentWriterAgent(self.browser)
                self.task_executor.register_agent('writer', self.content_writer)
                self.task_executor.register_agent('content', self.content_writer)
                logger.info("âœ… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™»éŒ²å®Œäº†")
            except ImportError:
                logger.warning("âš ï¸ content_writer_agent ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“(ã‚¹ã‚­ãƒƒãƒ—)")
                self.content_writer = None
        
            # 11. WordPressï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if wp_url and wp_user and wp_pass:
                self.wordpress_agent = await self._initialize_wordpress_agent(wp_url, wp_user, wp_pass)
            else:
                logger.info("âš ï¸ WordPressèªè¨¼æƒ…å ±ãŒæœªè¨­å®šã§ã™(ã‚¹ã‚­ãƒƒãƒ—)")
                self.wordpress_agent = None
        
            logger.info("="*60)
            logger.info("âœ… ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†")
            logger.info("="*60)
            logger.info(f"âš™ï¸ æœ€å¤§åå¾©å›æ•°: {self.max_iterations}")
            logger.info(f"ğŸ†” ä½¿ç”¨ä¸­ã®PC_ID: {self.pc_id}")
            
            self.initialization_success = True
        
        except Exception as e:
            logger.error("âŒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—")
            if EnhancedErrorHandler:
                EnhancedErrorHandler.log_error_with_context(e, "ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–")
            else:
                ErrorHandler.log_error(e, "ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–")
            raise

    async def run_full_workflow(self, goal: str = None, auto_continue: bool = False, enable_review: bool = True):
        """å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"""
        if not self.initialization_success:
            raise Exception("ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        try:
            print("\n" + "="*60)
            print("ğŸ“‹ ãƒ•ã‚§ãƒ¼ã‚º1: PM AIã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯åˆ†è§£")
            print("="*60)
            
            if goal:
                goal_description = goal
                logger.info(f"ğŸ¯ æŒ‡å®šã•ã‚ŒãŸç›®æ¨™: {goal_description}")
            else:
                goal_data = await self.pm_agent.load_project_goal()
                if not goal_data:
                    print("\nâŒ ã‚¨ãƒ©ãƒ¼: ç›®æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    print("--goal ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç›®æ¨™ã‚’æŒ‡å®šã™ã‚‹ã‹ã€")
                    print("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®'project_goal'ã‚·ãƒ¼ãƒˆã«ç›®æ¨™ã‚’è¨­å®šã—ã¦ãã ã•ã„")
                    return
                goal_description = goal_data['description']
            
            task_plan = await self.pm_agent.analyze_and_create_tasks(goal_description)
            self.pm_agent.display_task_summary(task_plan)
            
            if not auto_continue:
                save = input("\nğŸ’¾ ã‚¿ã‚¹ã‚¯ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã™ã‹? (y/n): ")
                if save.lower() != 'y':
                    print("â¸ï¸ å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
                    return
            
            await self.pm_agent.save_tasks_to_sheet(task_plan)
            
            print("\n" + "="*60)
            print("âš™ï¸ ãƒ•ã‚§ãƒ¼ã‚º2: ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ")
            print("="*60)
            
            if enable_review:
                print("âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼AI: æœ‰åŠ¹")
            else:
                print("â­ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼AI: ç„¡åŠ¹")
            
            if not auto_continue:
                execute = input("\nâ–¶ï¸ ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™ã‹? (y/n): ")
                if execute.lower() != 'y':
                    print("â¸ï¸ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ")
                    return
            
            await self.task_executor.run_all_tasks(
                auto_continue=auto_continue,
                enable_review=enable_review
            )
            
            print("\n" + "="*60)
            print("ğŸ‰ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†")
            print("="*60)
            print(f"ğŸ“ å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€: {self.output_folder}")
            print("ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„")
            
        except Exception as e:
            logger.error("ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼")
            if EnhancedErrorHandler:
                EnhancedErrorHandler.log_error_with_context(e, "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ")
            else:
                ErrorHandler.log_error(e, "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ")
            raise

    async def run_tasks_only(self, auto_continue: bool = False, enable_review: bool = True):
        """æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’å®Ÿè¡Œ"""
        if not self.initialization_success:
            raise Exception("ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        try:
            print("\n" + "="*60)
            print("âš™ï¸ æ—¢å­˜ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ")
            print("="*60)
            
            if enable_review:
                print("âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼AI: æœ‰åŠ¹")
            else:
                print("â­ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼AI: ç„¡åŠ¹")
            
            await self.task_executor.run_all_tasks(
                auto_continue=auto_continue,
                enable_review=enable_review
            )
            
            print("\n" + "="*60)
            print("ğŸ‰ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œå®Œäº†")
            print("="*60)
            
        except Exception as e:
            logger.error("ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼")
            if EnhancedErrorHandler:
                EnhancedErrorHandler.log_error_with_context(e, "ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ")
            else:
                ErrorHandler.log_error(e, "ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ")
            raise

    async def cleanup(self):
        """ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå¼·åŒ–ç‰ˆï¼‰"""
        logger.info("ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹...")
        
        # WordPressã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        if self.wordpress_agent:
            if EnhancedErrorHandler:
                await EnhancedErrorHandler.safe_cleanup(
                    self.wordpress_agent.cleanup,
                    "WordPressã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"
                )
            else:
                try:
                    await self.wordpress_agent.cleanup()
                except Exception as e:
                    logger.warning(f"WordPressã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: {e}")
        
        # ãƒ–ãƒ©ã‚¦ã‚¶
        if self.browser:
            if EnhancedErrorHandler:
                await EnhancedErrorHandler.safe_cleanup(
                    self.browser.cleanup,
                    "ãƒ–ãƒ©ã‚¦ã‚¶"
                )
            else:
                try:
                    await self.browser.cleanup()
                except Exception as e:
                    logger.warning(f"ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: {e}")
        
        # asyncioã‚¿ã‚¹ã‚¯ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        try:
            tasks = [t for t in asyncio.all_tasks() 
                    if t is not asyncio.current_task()]
            
            if tasks:
                logger.info(f"ğŸ”„ {len(tasks)}å€‹ã®éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­...")
                for task in tasks:
                    task.cancel()
                
                # ã‚¿ã‚¹ã‚¯ã®å®Œäº†å¾…æ©Ÿ
                await asyncio.gather(*tasks, return_exceptions=True)
                logger.info("âœ… éåŒæœŸã‚¿ã‚¹ã‚¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")
                
        except Exception as e:
            logger.warning(f"éåŒæœŸã‚¿ã‚¹ã‚¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: {e}")
        
        logger.info("âœ… å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")


async def main():
    parser = argparse.ArgumentParser(description='ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ (ã‚¨ãƒ©ãƒ¼å¯¾ç­–å¼·åŒ–ç‰ˆ)')
    parser.add_argument('--goal', type=str, help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›®æ¨™ã‚’ç›´æ¥æŒ‡å®š')
    parser.add_argument('--tasks-only', action='store_true', help='æ—¢å­˜ã‚¿ã‚¹ã‚¯ã®ã¿å®Ÿè¡Œ(PM AIã‚¹ã‚­ãƒƒãƒ—)')
    parser.add_argument('--auto', action='store_true', help='è‡ªå‹•å®Ÿè¡Œ(ç¢ºèªãªã—)')
    parser.add_argument('--no-review', action='store_true', help='ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–')
    parser.add_argument('--max-iterations', type=int, default=3, help='æœ€å¤§åå¾©å›æ•°(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3)')
    parser.add_argument('--pc-id', type=int, help='PC_IDã‚’æŒ‡å®š')
    
    args = parser.parse_args()
    
    orchestrator = MultiAgentOrchestrator(
        pc_id=args.pc_id,
        max_iterations=args.max_iterations
    )
    
    try:
        await orchestrator.initialize()
        
        enable_review = not args.no_review
        
        if args.tasks_only:
            await orchestrator.run_tasks_only(
                auto_continue=args.auto,
                enable_review=enable_review
            )
        else:
            await orchestrator.run_full_workflow(
                goal=args.goal,
                auto_continue=args.auto,
                enable_review=enable_review
            )
        
    except KeyboardInterrupt:
        print("\n\nâ¸ï¸ å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã—ãŸ")
    except Exception as e:
        logger.error(f"âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
    finally:
        await orchestrator.cleanup()
        print("\nğŸ‘‹ ã‚·ã‚¹ãƒ†ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸ")


if __name__ == "__main__":
    asyncio.run(main())