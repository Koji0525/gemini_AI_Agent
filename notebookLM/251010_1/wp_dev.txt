"""
WordPresså°‚ç”¨è¦ä»¶å®šç¾©æ›¸ç”Ÿæˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸ wp_dev.py
"""

# ... æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ...
import asyncio
import logging
from pathlib import Path
from typing import Dict, Optional, List
from datetime import datetime
import re
import json

from config_utils import ErrorHandler, PathManager
from browser_controller import BrowserController

logger = logging.getLogger(__name__)

class DevAgent:
    """é–‹ç™ºAI - WordPressè¦ä»¶å®šç¾©æ›¸å¯¾å¿œç‰ˆ"""
    
    # ... æ—¢å­˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯çœç•¥ ...
    
    WORDPRESS_REQUIREMENTS_PROMPT = """ã‚ãªãŸã¯WordPressé–‹ç™ºã®å°‚é–€å®¶ã§ã€è¦ä»¶å®šç¾©ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³ã®M&Aãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã®è¦ä»¶å®šç¾©æ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã€‘
- **ã‚µã‚¤ãƒˆå**: ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³M&Aãƒãƒ¼ã‚¿ãƒ«
- **ç›®çš„**: M&Aæ¡ˆä»¶æƒ…å ±ã®å¤šè¨€èªç™ºä¿¡ã¨ä¼æ¥­ãƒãƒƒãƒãƒ³ã‚°
- **WordPressãƒ†ãƒ¼ãƒ**: Cocoonï¼ˆæ—¥æœ¬è£½ã®ç„¡æ–™é«˜æ©Ÿèƒ½ãƒ†ãƒ¼ãƒï¼‰
- **å¤šè¨€èªãƒ—ãƒ©ã‚°ã‚¤ãƒ³**: Polylang
- **å¯¾å¿œè¨€èª**: æ—¥æœ¬èªã€è‹±èªã€ãƒ­ã‚·ã‚¢èªã€ã‚¦ã‚ºãƒ™ã‚¯èªã€ä¸­å›½èªã€éŸ“å›½èªã€ãƒˆãƒ«ã‚³èªï¼ˆ7è¨€èªï¼‰

ã€Cocoonãƒ†ãƒ¼ãƒã®ç‰¹å¾´ã‚’æ´»ã‹ã™ã€‘
1. **é«˜é€Ÿè¡¨ç¤º**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–ã€ç”»åƒé…å»¶èª­ã¿è¾¼ã¿
2. **SEOæœ€é©åŒ–**: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã€ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ
3. **ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ**: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
4. **åºƒå‘Šç®¡ç†**: ã‚¢ãƒ‰ã‚»ãƒ³ã‚¹å¯¾å¿œ
5. **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§**: è±Šå¯Œãªã‚¹ã‚­ãƒ³ã€ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ

ã€Polylangå¤šè¨€èªå¯¾å¿œã®è¦ä»¶ã€‘
1. **è¨€èªåˆ‡ã‚Šæ›¿ãˆ**: ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨€èªã‚¹ã‚¤ãƒƒãƒãƒ£ãƒ¼
2. **URLæ§‹é€ **: è¨€èªã‚³ãƒ¼ãƒ‰ä»˜ãURLï¼ˆä¾‹: /en/ma-cases/ã€/ru/ma-cases/ï¼‰
3. **ç¿»è¨³ç®¡ç†**: 
   - æŠ•ç¨¿ãƒ»å›ºå®šãƒšãƒ¼ã‚¸ã®ç¿»è¨³
   - ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã®ç¿»è¨³
   - ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼ã®ç¿»è¨³
   - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç¿»è¨³
4. **è¨€èªåˆ¥è¨­å®š**: å„è¨€èªã”ã¨ã®SEOè¨­å®š

ã€è¦ä»¶å®šç¾©æ›¸ã®æ§‹æˆã€‘
å¿…ãšä»¥ä¸‹ã®æ§‹é€ ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

# 1.0 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
## 1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
## 1.2 ç›®çš„ãƒ»èƒŒæ™¯
## 1.3 å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
## 1.4 æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰

# 2.0 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ
## 2.1 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- WordPress 6.4ä»¥ä¸Š
- Cocoonãƒ†ãƒ¼ãƒ
- Polylangãƒ—ãƒ©ã‚°ã‚¤ãƒ³
- ãã®ä»–å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³

## 2.2 ã‚µãƒ¼ãƒãƒ¼è¦ä»¶
- PHP 8.0ä»¥ä¸Š
- MySQL 8.0ä»¥ä¸Š
- ãƒ¡ãƒ¢ãƒª 512MBä»¥ä¸Š

## 2.3 é–‹ç™ºãƒ»æœ¬ç•ªç’°å¢ƒ

# 3.0 æ©Ÿèƒ½è¦ä»¶
## 3.1 ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—
### 3.1.1 M&Aæ¡ˆä»¶ï¼ˆma_caseï¼‰
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©
- ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒšãƒ¼ã‚¸
- å˜ä¸€ãƒšãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### 3.1.2 ä¼æ¥­æƒ…å ±ï¼ˆcompanyï¼‰
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©
- ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼

### 3.1.3 ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆnewsï¼‰

## 3.2 ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼
### 3.2.1 æ¥­ç¨®åˆ†é¡ï¼ˆindustryï¼‰
### 3.2.2 åœ°åŸŸï¼ˆregionï¼‰
### 3.2.3 æ¡ˆä»¶ã‚¿ã‚¤ãƒ—ï¼ˆdeal_typeï¼‰

## 3.3 ACFã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
### M&Aæ¡ˆä»¶ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
1. åŸºæœ¬æƒ…å ±
   - ä¼æ¥­å
   - æ‰€åœ¨åœ°
   - æ¥­ç¨®
   - è³‡æœ¬é‡‘
   - å¾“æ¥­å“¡æ•°
   
2. æ¡ˆä»¶æƒ…å ±
   - æ¡ˆä»¶ã‚¿ã‚¤ãƒ—ï¼ˆå£²å´/è²·å/ææºï¼‰
   - å¸Œæœ›ä¾¡æ ¼
   - äº¤æ¸‰çŠ¶æ³
   - å…¬é–‹çŠ¶æ…‹
   
3. é€£çµ¡å…ˆæƒ…å ±
   - æ‹…å½“è€…å
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   - é›»è©±ç•ªå·

## 3.4 æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ï¼ˆFacetWPï¼‰
- æ¥­ç¨®åˆ¥æ¤œç´¢
- åœ°åŸŸåˆ¥æ¤œç´¢
- ä¾¡æ ¼å¸¯æ¤œç´¢
- æ¡ˆä»¶ã‚¿ã‚¤ãƒ—æ¤œç´¢
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆRelevanssiï¼‰

## 3.5 å¤šè¨€èªæ©Ÿèƒ½ï¼ˆPolylangï¼‰
### 3.5.1 è¨€èªè¨­å®š
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨€èª: æ—¥æœ¬èª
- ç¿»è¨³è¨€èª: è‹±èªã€ãƒ­ã‚·ã‚¢èªã€ã‚¦ã‚ºãƒ™ã‚¯èªã€ä¸­å›½èªã€éŸ“å›½èªã€ãƒˆãƒ«ã‚³èª

### 3.5.2 ç¿»è¨³å¯¾è±¡
- ã™ã¹ã¦ã®æŠ•ç¨¿ã‚¿ã‚¤ãƒ—
- ã™ã¹ã¦ã®ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼
- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ©ãƒ™ãƒ«
- ãƒ¡ãƒ‹ãƒ¥ãƒ¼
- ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ

### 3.5.3 URLæ§‹é€ 
```
æ—¥æœ¬èª: https://example.com/ma-cases/
è‹±èª: https://example.com/en/ma-cases/
ãƒ­ã‚·ã‚¢èª: https://example.com/ru/ma-cases/
ã‚¦ã‚ºãƒ™ã‚¯èª: https://example.com/uz/ma-cases/
ä¸­å›½èª: https://example.com/zh/ma-cases/
éŸ“å›½èª: https://example.com/ko/ma-cases/
ãƒˆãƒ«ã‚³èª: https://example.com/tr/ma-cases/
```

## 3.6 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»æ¨©é™
### 3.6.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«
- ç®¡ç†è€…: ã™ã¹ã¦ã®æ¨©é™
- ç·¨é›†è€…: æ¡ˆä»¶ç®¡ç†ã€ä¼æ¥­æƒ…å ±ç®¡ç†
- æŠ•ç¨¿è€…: æ¡ˆä»¶æŠ•ç¨¿ã®ã¿
- è³¼èª­è€…: é–²è¦§ã®ã¿

### 3.6.2 ä¼šå“¡æ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ä¼šå“¡ç™»éŒ²
- ãƒ­ã‚°ã‚¤ãƒ³
- æ¡ˆä»¶ãŠæ°—ã«å…¥ã‚Š
- å•ã„åˆã‚ã›å±¥æ­´

## 3.7 å•ã„åˆã‚ã›æ©Ÿèƒ½
- Contact Form 7
- å¤šè¨€èªå¯¾å¿œ
- è‡ªå‹•è¿”ä¿¡ãƒ¡ãƒ¼ãƒ«
- ç®¡ç†è€…é€šçŸ¥

## 3.8 SEOå¯¾ç­–
### 3.8.1 åŸºæœ¬è¨­å®š
- ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ã‚°æœ€é©åŒ–
- ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
- OGPã‚¿ã‚°è¨­å®š
- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿

### 3.8.2 Cocoon SEOæ©Ÿèƒ½æ´»ç”¨
- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ
- ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°èª¬æ˜æ–‡
- ç›®æ¬¡è‡ªå‹•ç”Ÿæˆ

## 3.9 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- Wordfence Security
- ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°åˆ¶é™
- 2æ®µéšèªè¨¼
- SSL/HTTPSåŒ–
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆUpdraftPlusï¼‰

## 3.10 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- WP Rocketï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- ç”»åƒæœ€é©åŒ–ï¼ˆEWWW Image Optimizerï¼‰
- CDNè¨­å®šï¼ˆCloudflareï¼‰
- Cocoonã®é«˜é€ŸåŒ–æ©Ÿèƒ½æ´»ç”¨

# 4.0 éæ©Ÿèƒ½è¦ä»¶
## 4.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“: 3ç§’ä»¥å†…
- ãƒ¢ãƒã‚¤ãƒ« PageSpeed Insights: 80ç‚¹ä»¥ä¸Š

## 4.2 å¯ç”¨æ€§
- ã‚µãƒ¼ãƒãƒ¼ç¨¼åƒç‡: 99.9%ä»¥ä¸Š
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: 1æ—¥1å›è‡ªå‹•

## 4.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- SSL/TLS 1.3
- å®šæœŸçš„ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°
- è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³

## 4.4 äº’æ›æ€§
- ãƒ–ãƒ©ã‚¦ã‚¶: Chrome, Firefox, Safari, Edgeï¼ˆæœ€æ–°ç‰ˆï¼‰
- ãƒ‡ãƒã‚¤ã‚¹: PC, ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ, ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³

# 5.0 ç”»é¢è¨­è¨ˆ
## 5.1 ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè¨€èªã‚¹ã‚¤ãƒƒãƒãƒ£ãƒ¼ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
- ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
- æ³¨ç›®æ¡ˆä»¶ä¸€è¦§
- æ–°ç€ãƒ‹ãƒ¥ãƒ¼ã‚¹
- ãƒ•ãƒƒã‚¿ãƒ¼

## 5.2 M&Aæ¡ˆä»¶ä¸€è¦§ãƒšãƒ¼ã‚¸
- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰
- æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ä¸€è¦§
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

## 5.3 M&Aæ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸
- æ¡ˆä»¶æƒ…å ±
- ä¼æ¥­æƒ…å ±
- å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ 
- é–¢é€£æ¡ˆä»¶

## 5.4 ä¼æ¥­æƒ…å ±ãƒšãƒ¼ã‚¸
- ä¼æ¥­æ¦‚è¦
- ä¿æœ‰æ¡ˆä»¶ä¸€è¦§

## 5.5 è¨€èªåˆ¥ãƒšãƒ¼ã‚¸
- å„è¨€èªã§åŒã˜æ§‹æˆ
- å³æ›¸ãè¨€èªå¯¾å¿œï¼ˆã‚¢ãƒ©ãƒ“ã‚¢èªãªã©å°†æ¥å¯¾å¿œï¼‰

# 6.0 ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
## 6.1 ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—å®šç¾©ï¼ˆJSONå½¢å¼ï¼‰
```json
{
  "ma_case": {
    "labels": {
      "ja": "M&Aæ¡ˆä»¶",
      "en": "M&A Cases",
      "ru": "Ğ¡Ğ´ĞµĞ»ĞºĞ¸ M&A",
      "uz": "M&A bitimlar",
      "zh": "å¹¶è´­æ¡ˆä¾‹",
      "ko": "ì¸ìˆ˜í•©ë³‘ ì‚¬ë¡€",
      "tr": "BirleÅŸme ve Devralma VakalarÄ±"
    },
    "supports": ["title", "editor", "thumbnail", "custom-fields", "excerpt"],
    "taxonomies": ["industry", "region", "deal_type"],
    "has_archive": true,
    "public": true,
    "show_in_rest": true
  }
}
```

## 6.2 ACFãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©

## 6.3 ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼å®šç¾©

# 7.0 å®Ÿè£…è¨ˆç”»
## 7.1 ãƒ•ã‚§ãƒ¼ã‚º1: åŸºæœ¬æ§‹ç¯‰ï¼ˆ1-2é€±é–“ï¼‰
- WordPress + Cocoon ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- Polylangè¨­å®š
- ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆ
- ACFãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä½œæˆ

## 7.2 ãƒ•ã‚§ãƒ¼ã‚º2: æ©Ÿèƒ½å®Ÿè£…ï¼ˆ2-3é€±é–“ï¼‰
- æ¤œç´¢æ©Ÿèƒ½ï¼ˆFacetWPï¼‰
- å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ 
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

## 7.3 ãƒ•ã‚§ãƒ¼ã‚º3: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç™»éŒ²ï¼ˆ1é€±é–“ï¼‰
- ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶ç™»éŒ²
- å„è¨€èªã¸ã®ç¿»è¨³

## 7.4 ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ï¼ˆ1é€±é–“ï¼‰
- å¤šè¨€èªè¡¨ç¤ºç¢ºèª
- æ¤œç´¢å‹•ä½œç¢ºèª
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

## 7.5 ãƒ•ã‚§ãƒ¼ã‚º5: æœ¬ç•ªå…¬é–‹ï¼ˆ1é€±é–“ï¼‰
- DNSè¨­å®š
- SSLè¨¼æ˜æ›¸
- æœ¬ç•ªç’°å¢ƒç§»è¡Œ

# 8.0 é‹ç”¨ä¿å®ˆ
## 8.1 å®šæœŸä½œæ¥­
- WordPress/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°ï¼ˆæœˆ1å›ï¼‰
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªï¼ˆé€±1å›ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆé€±1å›ï¼‰

## 8.2 ç›£è¦–é …ç›®
- ã‚µãƒ¼ãƒãƒ¼ç¨¼åƒç‡
- ãƒšãƒ¼ã‚¸è¡¨ç¤ºé€Ÿåº¦
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

## 8.3 ã‚µãƒãƒ¼ãƒˆä½“åˆ¶
- å¹³æ—¥9:00-18:00ã‚µãƒãƒ¼ãƒˆ
- ç·Šæ€¥æ™‚å¯¾å¿œ

# 9.0 ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š
## 9.1 åˆæœŸè²»ç”¨
- ã‚µãƒ¼ãƒãƒ¼è²»ç”¨
- ãƒ‰ãƒ¡ã‚¤ãƒ³è²»ç”¨
- æœ‰æ–™ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ©ã‚¤ã‚»ãƒ³ã‚¹
- é–‹ç™ºè²»ç”¨

## 9.2 æœˆé¡è²»ç”¨
- ã‚µãƒ¼ãƒãƒ¼è²»ç”¨
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ›´æ–°
- ä¿å®ˆè²»ç”¨

# 10.0 ãƒªã‚¹ã‚¯ã¨å¯¾ç­–
## 10.1 æŠ€è¡“çš„ãƒªã‚¹ã‚¯
- Polylangã®åˆ¶é™äº‹é …
- Cocoonã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®äº’æ›æ€§

## 10.2 é‹ç”¨ãƒªã‚¹ã‚¯
- å¤šè¨€èªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç®¡ç†è² è·
- ç¿»è¨³å“è³ªã®ç¢ºä¿

## 10.3 å¯¾ç­–
- ç¿»è¨³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç¢ºç«‹
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é¸å®šã®æ…é‡ãªæ¤œè¨

---

ã€å‡ºåŠ›å½¢å¼ã€‘
ä¸Šè¨˜ã®æ§‹æˆã«å¾“ã£ã¦ã€**å®Œå…¨ã§è©³ç´°ãªè¦ä»¶å®šç¾©æ›¸**ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
- ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åŸ‹ã‚ã‚‹ã“ã¨
- å…·ä½“çš„ãªä»•æ§˜ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨
- JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å«ã‚ã‚‹ã“ã¨
- å®Ÿè£…å¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã®è©³ç´°åº¦ã§è¨˜è¿°ã™ã‚‹ã“ã¨

ã€é‡è¦ã€‘
- å‡ºåŠ›ã¯20,000æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªè¦ä»¶å®šç¾©æ›¸ã«ã™ã‚‹ã“ã¨
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯å®Œå…¨ã«é–‰ã˜ã‚‹ã“ã¨ï¼ˆ```ã§é–‹å§‹ãƒ»çµ‚äº†ï¼‰
- ã™ã¹ã¦ã®ç« ç«‹ã¦ã‚’ç¶²ç¾…ã™ã‚‹ã“ã¨
- Cocoonãƒ†ãƒ¼ãƒã®æ©Ÿèƒ½ã‚’æœ€å¤§é™æ´»ç”¨ã™ã‚‹ã“ã¨
- Polylangã®å¤šè¨€èªå¯¾å¿œã‚’å¾¹åº•ã™ã‚‹ã“ã¨
"""

    def __init__(self, browser: BrowserController, output_folder: Path = None):
        # ... æ—¢å­˜ã® __init__ ã¨åŒã˜ ...
        self.browser = browser
        if output_folder is None:
            from config_utils import config
            if config.AGENT_OUTPUT_FOLDER:
                self.output_folder = PathManager.get_safe_path(config.AGENT_OUTPUT_FOLDER)
                logger.info(f"Agentå‡ºåŠ›å…ˆï¼ˆB14ã‹ã‚‰å–å¾—ï¼‰: {self.output_folder}")
            else:
                self.output_folder = Path.home() / "Documents" / "gemini_auto_generate" / "agent_outputs"
                self.output_folder.mkdir(exist_ok=True, parents=True)
                logger.warning(f"B14ãŒç©ºã®ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ç”¨: {self.output_folder}")
        else:
            self.output_folder = output_folder
        
        self.design_docs = {}
    
    async def process_task(self, task: Dict) -> Dict:
        """é–‹ç™ºã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ï¼ˆWordPressè¦ä»¶å®šç¾©å¯¾å¿œå¼·åŒ–ç‰ˆï¼‰"""
        try:
            logger.info(f"é–‹ç™ºAI: ã‚¿ã‚¹ã‚¯å‡¦ç†é–‹å§‹ - {task['description']}")
            
            # WordPressè¦ä»¶å®šç¾©ã‚¿ã‚¹ã‚¯ã‹åˆ¤å®š
            if self._is_wordpress_requirements_task(task):
                return await self._process_wordpress_requirements_task(task)
            
            # WordPress ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆã‚¿ã‚¹ã‚¯ã‹åˆ¤å®š
            if self._is_wordpress_cpt_task(task):
                return await self._process_wordpress_cpt_task(task)
            
            # é€šå¸¸ã®é–‹ç™ºã‚¿ã‚¹ã‚¯
            return await self._process_general_task(task)
            
        except Exception as e:
            ErrorHandler.log_error(e, "é–‹ç™ºAIå‡¦ç†")
            return {
                'success': False,
                'error': str(e)
            }
    
    def _is_wordpress_requirements_task(self, task: Dict) -> bool:
        """WordPressè¦ä»¶å®šç¾©ã‚¿ã‚¹ã‚¯ã‹åˆ¤å®š"""
        description = task.get('description', '').lower()
        keywords = [
            'è¦ä»¶å®šç¾©',
            'ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆ',
            'wordpress',
            'cocoon',
            'polylang',
            'å¤šè¨€èª'
        ]
        # è¤‡æ•°ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å ´åˆ
        matches = sum(1 for kw in keywords if kw in description)
        return matches >= 2
    
    def _is_wordpress_cpt_task(self, task: Dict) -> bool:
        """WordPressã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆã‚¿ã‚¹ã‚¯ã‹åˆ¤å®š"""
        description = task.get('description', '').lower()
        keywords = [
            'custom post type',
            'ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—',
            'cpt',
            'register_post_type',
            'æŠ•ç¨¿ã‚¿ã‚¤ãƒ—'
        ]
        return any(kw in description for kw in keywords)
    
    async def _process_wordpress_requirements_task(self, task: Dict) -> Dict:
        """WordPressè¦ä»¶å®šç¾©ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†"""
        try:
            logger.info("="*60)
            logger.info("WordPressè¦ä»¶å®šç¾©æ›¸ä½œæˆã‚¿ã‚¹ã‚¯")
            logger.info("="*60)
            
            # ã‚¿ã‚¹ã‚¯ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
            project_info = self._extract_project_info(task)
            
            logger.info(f"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: {project_info['name']}")
            logger.info(f"å¯¾å¿œè¨€èª: {', '.join(project_info['languages'])}")
            logger.info(f"ãƒ†ãƒ¼ãƒ: {project_info['theme']}")
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
            full_prompt = self._build_wordpress_requirements_prompt(task, project_info)
            
            # Geminiã«é€ä¿¡
            logger.info("Geminiã«è¦ä»¶å®šç¾©æ›¸ä½œæˆã‚¿ã‚¹ã‚¯ã‚’é€ä¿¡ä¸­...")
            await self.browser.send_prompt(full_prompt)
            
            # å¿œç­”å¾…æ©Ÿï¼ˆè¦ä»¶å®šç¾©æ›¸ã¯é•·ã„ã®ã§300ç§’ï¼‰
            logger.info("â±ï¸ å¾…æ©Ÿæ™‚é–“: 300ç§’ï¼ˆè¦ä»¶å®šç¾©æ›¸ä½œæˆï¼‰")
            success = await self.browser.wait_for_text_generation(max_wait=300)
            
            if not success:
                return {
                    'success': False,
                    'error': 'é–‹ç™ºAI: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆè¦ä»¶å®šç¾©æ›¸ä½œæˆ: 300ç§’ï¼‰'
                }
            
            # å¿œç­”ã‚’å–å¾—
            response_text = await self.browser.extract_latest_text_response()
            
            if not response_text:
                return {
                    'success': False,
                    'error': 'é–‹ç™ºAI: å¿œç­”å–å¾—å¤±æ•—'
                }
            
            logger.info(f"é–‹ç™ºAI: å¿œç­”å–å¾—å®Œäº†ï¼ˆ{len(response_text)}æ–‡å­—ï¼‰")
            
            # å‡ºåŠ›å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
            if len(response_text) < 5000:
                logger.warning(f"âš ï¸ å‡ºåŠ›ãŒçŸ­ã™ãã¾ã™ï¼ˆ{len(response_text)}æ–‡å­—ï¼‰")
                logger.warning("è¦ä»¶å®šç¾©æ›¸ãŒä¸å®Œå…¨ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
            
            # çµæœã‚’ä¿å­˜
            output_files = self._save_wordpress_requirements(response_text, task, project_info)
            
            # ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
            summary = f"""âœ… WordPressè¦ä»¶å®šç¾©æ›¸ä½œæˆå®Œäº†

ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã€‘
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: {project_info['name']}
- ãƒ†ãƒ¼ãƒ: {project_info['theme']}
- å¤šè¨€èªãƒ—ãƒ©ã‚°ã‚¤ãƒ³: {project_info['multilang_plugin']}
- å¯¾å¿œè¨€èª: {len(project_info['languages'])}è¨€èª

ã€ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã€‘
"""
            for file_info in output_files:
                summary += f"- {file_info['type']}: {file_info['path'].name}\n"
            
            summary += f"\nã€å‡ºåŠ›æ–‡å­—æ•°ã€‘\n"
            summary += f"- åˆè¨ˆ: {len(response_text):,}æ–‡å­—\n"
            
            summary += f"\nã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã€‘\n"
            summary += f"1. è¦ä»¶å®šç¾©æ›¸ã‚’ç¢ºèª\n"
            summary += f"2. ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã®å®Ÿè£…ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ\n"
            summary += f"3. ACFãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å®Ÿè£…ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ\n"
            summary += f"4. å¤šè¨€èªè¨­å®šã®å®Ÿè£…ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ\n"
            
            return {
                'success': True,
                'output_files': output_files,
                'summary': summary,
                'full_text': response_text,
                'project_name': project_info['name']
            }
            
        except Exception as e:
            ErrorHandler.log_error(e, "WordPressè¦ä»¶å®šç¾©æ›¸ä½œæˆ")
            return {
                'success': False,
                'error': str(e)
            }
    
    def _extract_project_info(self, task: Dict) -> Dict:
        """ã‚¿ã‚¹ã‚¯ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’æŠ½å‡º"""
        description = task.get('description', '')
        parameters = task.get('parameters', {})
        
        if isinstance(parameters, str):
            try:
                parameters = json.loads(parameters)
            except:
                parameters = {}
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        project_info = {
            'name': 'ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³M&Aãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆ',
            'theme': 'Cocoon',
            'multilang_plugin': 'Polylang',
            'languages': ['æ—¥æœ¬èª', 'è‹±èª', 'ãƒ­ã‚·ã‚¢èª', 'ã‚¦ã‚ºãƒ™ã‚¯èª', 'ä¸­å›½èª', 'éŸ“å›½èª', 'ãƒˆãƒ«ã‚³èª'],
            'language_codes': ['ja', 'en', 'ru', 'uz', 'zh', 'ko', 'tr']
        }
        
        # parametersã‹ã‚‰ä¸Šæ›¸ã
        if parameters.get('project_name'):
            project_info['name'] = parameters['project_name']
        if parameters.get('theme'):
            project_info['theme'] = parameters['theme']
        if parameters.get('languages'):
            project_info['languages'] = parameters['languages']
        
        return project_info
    
    def _build_wordpress_requirements_prompt(self, task: Dict, project_info: Dict) -> str:
        """WordPressè¦ä»¶å®šç¾©ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰"""
        prompt = self.WORDPRESS_REQUIREMENTS_PROMPT
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å«ã‚ã‚‹
        prompt += f"""

ã€ã“ã®ã‚¿ã‚¹ã‚¯ã®å…·ä½“çš„ãªè¦ä»¶ã€‘
{task.get('description', '')}

ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰æƒ…å ±ã€‘
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: {project_info['name']}
- WordPressãƒ†ãƒ¼ãƒ: {project_info['theme']}
- å¤šè¨€èªãƒ—ãƒ©ã‚°ã‚¤ãƒ³: {project_info['multilang_plugin']}
- å¯¾å¿œè¨€èª: {', '.join(project_info['languages'])}

ä¸Šè¨˜ã®æƒ…å ±ã‚’å…ƒã«ã€å®Œå…¨ã§è©³ç´°ãªWordPressè¦ä»¶å®šç¾©æ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã‚’é‡è¦–ã—ã¦ãã ã•ã„ï¼š

1. **Cocoonãƒ†ãƒ¼ãƒã®æ©Ÿèƒ½ã‚’æœ€å¤§é™æ´»ç”¨**ã™ã‚‹è¨­è¨ˆ
2. **Polylangã§ã®7è¨€èªå¯¾å¿œ**ã‚’è©³ç´°ã«è¨˜è¼‰
3. **ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã¨ACFã®å®šç¾©**ã‚’å…·ä½“çš„ã«
4. **æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½**ã®è©³ç´°ä»•æ§˜
5. **å®Ÿè£…å¯èƒ½ãªãƒ¬ãƒ™ãƒ«**ã®å…·ä½“æ€§

ã€é‡è¦ã€‘
- 20,000æ–‡å­—ä»¥ä¸Šã®è©³ç´°ãªè¦ä»¶å®šç¾©æ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
- ã™ã¹ã¦ã®ç« ç«‹ã¦ï¼ˆ1.0ï½10.0ï¼‰ã‚’å®Œå…¨ã«åŸ‹ã‚ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ```ï¼‰ã¯å¿…ãšé–‰ã˜ã¦ãã ã•ã„
- JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å«ã‚ã¦ãã ã•ã„
"""
        
        return prompt
    
    def _save_wordpress_requirements(self, text: str, task: Dict, project_info: Dict) -> list:
        """WordPressè¦ä»¶å®šç¾©æ›¸ã‚’ä¿å­˜"""
        output_files = []
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        
        try:
            # 1. å®Œå…¨ãªè¦ä»¶å®šç¾©æ›¸ã‚’ä¿å­˜ï¼ˆMarkdownï¼‰
            doc_filename = f"requirements_wordpress_{timestamp}.md"
            doc_path = self.output_folder / doc_filename
            
            with open(doc_path, 'w', encoding='utf-8') as f:
                f.write(f"# {project_info['name']} è¦ä»¶å®šç¾©æ›¸\n\n")
                f.write(f"ä½œæˆæ—¥æ™‚: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}\n")
                f.write(f"ã‚¿ã‚¹ã‚¯ID: {task.get('task_id', 'N/A')}\n\n")
                f.write("---\n\n")
                f.write(text)
            
            output_files.append({
                'type': 'è¦ä»¶å®šç¾©æ›¸ï¼ˆMarkdownï¼‰',
                'path': doc_path
            })
            logger.info(f"è¦ä»¶å®šç¾©æ›¸ä¿å­˜: {doc_filename}")
            
            # 2. READMEï¼ˆå®Ÿè£…æ‰‹é †ï¼‰ã‚’ç”Ÿæˆ
            readme_filename = f"README_requirements_{timestamp}.md"
            readme_path = self.output_folder / readme_filename
            
            with open(readme_path, 'w', encoding='utf-8') as f:
                f.write(f"# {project_info['name']} å®Ÿè£…ã‚¬ã‚¤ãƒ‰\n\n")
                f.write(f"## ğŸ“‹ æ¦‚è¦\n\n")
                f.write(f"ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€{project_info['name']}ã®è¦ä»¶å®šç¾©ã«åŸºã¥ãå®Ÿè£…æ‰‹é †ã‚’ç¤ºã—ã¾ã™ã€‚\n\n")
                f.write(f"## ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±\n\n")
                f.write(f"- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: {project_info['name']}\n")
                f.write(f"- **ãƒ†ãƒ¼ãƒ**: {project_info['theme']}\n")
                f.write(f"- **å¤šè¨€èªãƒ—ãƒ©ã‚°ã‚¤ãƒ³**: {project_info['multilang_plugin']}\n")
                f.write(f"- **å¯¾å¿œè¨€èª**: {len(project_info['languages'])}è¨€èª\n\n")
                f.write(f"## ğŸš€ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º\n\n")
                f.write(f"### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºæœ¬æ§‹ç¯‰ï¼ˆ1-2é€±é–“ï¼‰\n")
                f.write(f"1. WordPress + Cocoon ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«\n")
                f.write(f"2. Polylangè¨­å®šï¼ˆ7è¨€èªï¼‰\n")
                f.write(f"3. å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«\n")
                f.write(f"   - Advanced Custom Fields Pro\n")
                f.write(f"   - FacetWP\n")
                f.write(f"   - Contact Form 7\n")
                f.write(f"   - Wordfence Security\n")
                f.write(f"   - WP Rocket\n\n")
                f.write(f"### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆï¼ˆ1é€±é–“ï¼‰\n")
                f.write(f"1. M&Aæ¡ˆä»¶æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆ\n")
                f.write(f"2. ä¼æ¥­æƒ…å ±æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆ\n")
                f.write(f"3. ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼ä½œæˆ\n\n")
                f.write(f"### ãƒ•ã‚§ãƒ¼ã‚º3: ACFãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®šï¼ˆ1é€±é–“ï¼‰\n")
                f.write(f"1. M&Aæ¡ˆä»¶ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ\n")
                f.write(f"2. ä¼æ¥­æƒ…å ±ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ\n")
                f.write(f"3. Polylangã¨ã®é€£æºè¨­å®š\n\n")
                f.write(f"### ãƒ•ã‚§ãƒ¼ã‚º4: æ¤œç´¢æ©Ÿèƒ½å®Ÿè£…ï¼ˆ1é€±é–“ï¼‰\n")
                f.write(f"1. FacetWPè¨­å®š\n")
                f.write(f"2. æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆ\n")
                f.write(f"3. æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º\n\n")
                f.write(f"### ãƒ•ã‚§ãƒ¼ã‚º5: å¤šè¨€èªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç™»éŒ²ï¼ˆ1é€±é–“ï¼‰\n")
                f.write(f"1. ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶ç™»éŒ²\n")
                f.write(f"2. å„è¨€èªã¸ã®ç¿»è¨³\n")
                f.write(f"3. ç¿»è¨³å“è³ªãƒã‚§ãƒƒã‚¯\n\n")
                f.write(f"## ğŸ“‚ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\n\n")
                f.write(f"- è¦ä»¶å®šç¾©æ›¸: `{doc_filename}`\n")
                f.write(f"- Cocoonå…¬å¼: https://wp-cocoon.com/\n")
                f.write(f"- Polylangå…¬å¼: https://polylang.pro/\n\n")
            
            output_files.append({
                'type': 'å®Ÿè£…ã‚¬ã‚¤ãƒ‰',
                'path': readme_path
            })
            logger.info(f"å®Ÿè£…ã‚¬ã‚¤ãƒ‰ä¿å­˜: {readme_filename}")
            
            # 3. JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æŠ½å‡ºã—ã¦ä¿å­˜
            json_data = self._extract_json_structures(text)
            if json_data:
                json_filename = f"data_structures_{timestamp}.json"
                json_path = self.output_folder / json_filename
                
                with open(json_path, 'w', encoding='utf-8') as f:
                    json.dump(json_data, f, ensure_ascii=False, indent=2)
                
                output_files.append({
                    'type': 'ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆJSONï¼‰',
                    'path': json_path
                })
                logger.info(f"ãƒ‡ãƒ¼ã‚¿æ§‹é€ ä¿å­˜: {json_filename}")
            
            return output_files
            
        except Exception as e:
            logger.error(f"ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
            return output_files
    
    def _extract_json_structures(self, text: str) -> Optional[Dict]:
        """ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰JSONæ§‹é€ ã‚’æŠ½å‡º"""
        try:
            # ```json ... ``` ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™
            json_blocks = re.findall(r'```json\s*(.*?)```', text, re.DOTALL)
            
            if not json_blocks:
                return None
            
            # ã™ã¹ã¦ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’çµ±åˆ
            combined_data = {}
            for i, json_str in enumerate(json_blocks):
                try:
                    data = json.loads(json_str)
                    combined_data[f"structure_{i+1}"] = data
                except json.JSONDecodeError:
                    continue
            
            return combined_data if combined_data else None
            
        except Exception as e:
            logger.warning(f"JSONæŠ½å‡ºã‚¨ãƒ©ãƒ¼: {e}")
            return None

    async def _process_wordpress_cpt_task(self, task: Dict) -> Dict:
        """WordPressã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†"""
        try:
            logger.info("="*60)
            logger.info("WordPress ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆã‚¿ã‚¹ã‚¯")
            logger.info("="*60)
            
            # ã‚¿ã‚¹ã‚¯ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
            cpt_info = self._extract_cpt_info(task)
            
            logger.info(f"æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã‚¹ãƒ©ãƒƒã‚°: {cpt_info['slug']}")
            logger.info(f"è¡¨ç¤ºåï¼ˆå˜æ•°ï¼‰: {cpt_info['singular_name']}")
            logger.info(f"è¡¨ç¤ºåï¼ˆè¤‡æ•°ï¼‰: {cpt_info['plural_name']}")
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
            full_prompt = self._build_wordpress_cpt_prompt(task, cpt_info)
            
            # Geminiã«é€ä¿¡
            logger.info("Geminiã«ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆã‚¿ã‚¹ã‚¯ã‚’é€ä¿¡ä¸­...")
            await self.browser.send_prompt(full_prompt)
            
            # å¿œç­”å¾…æ©Ÿ
            success = await self.browser.wait_for_text_generation(max_wait=300)
            
            if not success:
                return {
                    'success': False,
                    'error': 'é–‹ç™ºAI: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ300ç§’ï¼‰'
                }
            
            # å¿œç­”ã‚’å–å¾—
            response_text = await self.browser.extract_latest_text_response()
            
            if not response_text:
                return {
                    'success': False,
                    'error': 'é–‹ç™ºAI: å¿œç­”å–å¾—å¤±æ•—'
                }
            
            logger.info(f"é–‹ç™ºAI: å¿œç­”å–å¾—å®Œäº†ï¼ˆ{len(response_text)}æ–‡å­—ï¼‰")
            
            # çµæœã‚’ä¿å­˜
            output_files = self._save_wordpress_cpt_code(response_text, task, cpt_info)
            
            # ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
            summary = f"""âœ… WordPressã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆå®Œäº†

ã€æŠ•ç¨¿ã‚¿ã‚¤ãƒ—æƒ…å ±ã€‘
- ã‚¹ãƒ©ãƒƒã‚°: {cpt_info['slug']}
- è¡¨ç¤ºå: {cpt_info['singular_name']} / {cpt_info['plural_name']}
- ã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½: {', '.join(cpt_info['supports'])}

ã€ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã€‘
"""
            for file_info in output_files:
                summary += f"- {file_info['type']}: {file_info['path'].name}\n"
            
            summary += f"\nã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã€‘\n"
            summary += f"1. functions.php ã¾ãŸã¯å°‚ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«è¿½åŠ \n"
            summary += f"2. ãƒ‘ãƒ¼ãƒãƒªãƒ³ã‚¯è¨­å®šã‚’ä¿å­˜ï¼ˆè¨­å®š > ãƒ‘ãƒ¼ãƒãƒªãƒ³ã‚¯è¨­å®šï¼‰\n"
            summary += f"3. ç®¡ç†ç”»é¢ã§ã€Œ{cpt_info['menu_name']}ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç¢ºèª\n"
            
            return {
                'success': True,
                'output_files': output_files,
                'summary': summary,
                'full_text': response_text,
                'cpt_slug': cpt_info['slug']
            }
            
        except Exception as e:
            ErrorHandler.log_error(e, "WordPressã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ä½œæˆ")
            return {
                'success': False,
                'error': str(e)
            }
async def _process_general_task(self, task: Dict) -> Dict:
        """é€šå¸¸ã®é–‹ç™ºã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†"""
        try:
            logger.info("é€šå¸¸ã®é–‹ç™ºã‚¿ã‚¹ã‚¯ã¨ã—ã¦å‡¦ç†")
            
            # å¯¾å¿œã™ã‚‹è¨­è¨ˆæ›¸ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
            design_context = self._load_design_context(task)
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
            full_prompt = f"""{self.DEV_SYSTEM_PROMPT}

ã€ã‚¿ã‚¹ã‚¯ã€‘
{task['description']}"""
            
            if design_context:
                full_prompt += f"""

ã€è¨­è¨ˆæ›¸ï¼ˆå‚è€ƒï¼‰ã€‘
{design_context}"""
            
            full_prompt += """

ä¸Šè¨˜ã®ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã€å®Œå…¨ã«å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚"""
            
            # Geminiã«é€ä¿¡
            logger.info("Geminiã«é–‹ç™ºã‚¿ã‚¹ã‚¯ã‚’é€ä¿¡ä¸­...")
            await self.browser.send_prompt(full_prompt)
            
            # ã‚¿ã‚¹ã‚¯ã®ç¨®é¡ã«ã‚ˆã£ã¦å¾…æ©Ÿæ™‚é–“ã‚’èª¿æ•´
            description = task.get('description', '').lower()
        
            if any(word in description for word in ['è¦ä»¶å®šç¾©', 'è¨­è¨ˆæ›¸', 'ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£', 'ä»•æ§˜æ›¸']):
                max_wait = 300  # è¦ä»¶å®šç¾©æ›¸ãªã©ã¯5åˆ†
                logger.info("ğŸ“‹ è¦ä»¶å®šç¾©ãƒ»è¨­è¨ˆæ›¸ã‚¿ã‚¹ã‚¯ - å¾…æ©Ÿæ™‚é–“ã‚’300ç§’ã«å»¶é•·")
            else:
                max_wait = 180  # é€šå¸¸ã¯3åˆ†
        
            # å¿œç­”å¾…æ©Ÿ
            success = await self.browser.wait_for_text_generation(max_wait=max_wait)

            
            if not success:
                return {
                    'success': False,
                    'error': 'é–‹ç™ºAI: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'
                }
            
            # å¿œç­”ã‚’å–å¾—
            response_text = await self.browser.extract_latest_text_response()
            
            if not response_text:
                return {
                    'success': False,
                    'error': 'é–‹ç™ºAI: å¿œç­”å–å¾—å¤±æ•—'
                }
            
            logger.info(f"é–‹ç™ºAI: å¿œç­”å–å¾—å®Œäº†ï¼ˆ{len(response_text)}æ–‡å­—ï¼‰")
            
            # ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            filename = f"code_{task['task_id']}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
            output_path = self.output_folder / filename
            
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(f"# ã‚³ãƒ¼ãƒ‰: {task['description']}\n\n")
                f.write(f"ã‚¿ã‚¹ã‚¯ID: {task['task_id']}\n")
                f.write(f"ä½œæˆæ—¥æ™‚: {datetime.now().isoformat()}\n\n")
                f.write("---\n\n")
                f.write(response_text)
            
            logger.info(f"ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜: {output_path}")
            
            # ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            self._extract_and_save_code(response_text, task)
            
            # ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
            summary = response_text[:500] + "..." if len(response_text) > 500 else response_text
            
            return {
                'success': True,
                'output_file': str(output_path),
                'summary': summary,
                'full_text': response_text
            }
            
        except Exception as e:
            ErrorHandler.log_error(e, "é–‹ç™ºAIå‡¦ç†")
            return {
                'success': False,
                'error': str(e)
            }
            
            