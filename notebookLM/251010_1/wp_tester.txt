"""WordPressãƒ†ã‚¹ãƒˆæ©Ÿèƒ½"""
import logging
from datetime import datetime
from typing import Dict
from playwright.async_api import Page

logger = logging.getLogger(__name__)


class WordPressTester:
    """WordPressãƒ†ã‚¹ãƒˆæ©Ÿèƒ½"""
    
    def __init__(self, wp_url: str):
        self.wp_url = wp_url
    
    async def test_functionality(self, page: Page, task: Dict) -> Dict:
        """æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ"""
        try:
            logger.info("æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")
            
            test_results = []
            
            # 1. ã‚µã‚¤ãƒˆã®è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
            await page.goto(self.wp_url)
            await page.wait_for_timeout(3000)
            
            # ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
            page_title = await page.title()
            test_results.append(f"âœ… ã‚µã‚¤ãƒˆè¡¨ç¤ºOK: {page_title}")
            
            # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
            site_screenshot = f"wp_site_{datetime.now().strftime('%H%M%S')}.png"
            await page.screenshot(path=site_screenshot, full_page=True)
            test_results.append(f"ğŸ“¸ ã‚µã‚¤ãƒˆå…¨ä½“: {site_screenshot}")
            
            # 2. ç®¡ç†ç”»é¢ãƒ†ã‚¹ãƒˆ
            await page.goto(f"{self.wp_url}/wp-admin/")
            await page.wait_for_timeout(2000)
            
            admin_screenshot = f"wp_admin_{datetime.now().strftime('%H%M%S')}.png"
            await page.screenshot(path=admin_screenshot)
            test_results.append("âœ… ç®¡ç†ç”»é¢OK")
            test_results.append(f"ğŸ“¸ ç®¡ç†ç”»é¢: {admin_screenshot}")
            
            # 3. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
            await page.goto(f"{self.wp_url}/wp-admin/plugins.php")
            await page.wait_for_timeout(2000)
            
            plugins_screenshot = f"wp_plugins_{datetime.now().strftime('%H%M%S')}.png"
            await page.screenshot(path=plugins_screenshot)
            test_results.append("âœ… ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€è¦§ç¢ºèª")
            test_results.append(f"ğŸ“¸ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³: {plugins_screenshot}")
            
            summary = '\n'.join(test_results)
            logger.info("\n" + summary)
            
            return {
                'success': True,
                'summary': summary[:500],
                'full_text': summary
            }
            
        except Exception as e:
            logger.error(f"æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            return {
                'success': False,
                'error': str(e)
            }