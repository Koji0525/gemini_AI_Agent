"""WordPressèªè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ç®¡ç†"""
import logging
from datetime import datetime
from typing import Dict, Optional
from playwright.async_api import Page

logger = logging.getLogger(__name__)


class WordPressAuth:
    """WordPressèªè¨¼ç®¡ç†"""
    
    def __init__(self, wp_url: str, wp_user: str, wp_pass: str):
        self.wp_url = wp_url
        self.wp_user = wp_user
        self.wp_pass = wp_pass
    
    async def login(self, page: Page) -> bool:
        """WordPressã«ãƒ­ã‚°ã‚¤ãƒ³"""
        try:
            logger.info("="*60)
            logger.info("WordPress: ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹")
            logger.info(f"URL: {self.wp_url}")
            logger.info("="*60)
            
            # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            login_url = f"{self.wp_url}/wp-login.php"
            await page.goto(login_url, timeout=30000)
            await page.wait_for_timeout(2000)
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›
            await page.fill('#user_login', self.wp_user)
            await page.wait_for_timeout(500)
            
            # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
            await page.fill('#user_pass', self.wp_pass)
            await page.wait_for_timeout(500)
            
            # ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            await page.click('#wp-submit')
            await page.wait_for_timeout(3000)
            
            # ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç¢ºèª
            current_url = page.url
            if 'wp-admin' in current_url:
                logger.info("âœ… WordPressãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ")
                
                # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜
                screenshot_path = f"wp_logged_in_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png"
                await page.screenshot(path=screenshot_path)
                logger.info(f"ğŸ“¸ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢: {screenshot_path}")
                
                return True
            else:
                logger.error("âŒ WordPressãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—")
                await page.screenshot(path="wp_login_failed.png")
                return False
                
        except Exception as e:
            logger.error(f"âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: {e}")
            return False