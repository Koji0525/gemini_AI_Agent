"""
task_executor_content.py
記事生成専用のタスク実行モジュール
task_executor.pyから分離
"""
import logging
from typing import Dict, List
from config_utils import ErrorHandler

logger = logging.getLogger(__name__)


class ContentTaskExecutor:
    """記事生成タスク専用の実行クラス"""
    
    def __init__(self, agents: Dict):
        self.agents = agents
    
    async def execute_writer_task(self, task: Dict, role: str) -> Dict:
        """言語別ライタータスクを実行"""
        task_language = task.get('language')
        polylang_lang = task.get('polylang_lang')
        
        logger.info("┌" + "─"*58 + "┐")
        logger.info(f"│ ✏️ ライターAIエージェント実行中 ({role})")
        logger.info("├" + "─"*58 + "┤")
        logger.info(f"│ 言語: {task_language}")
        logger.info(f"│ Polylang: {polylang_lang}")
        logger.info("└" + "─"*58 + "┘")
        
        # 汎用writer(後方互換性)
        if role == 'writer' or role == 'content':
            logger.info("📝 汎用ライターを使用(後方互換性モード)")
            agent = self.agents.get('writer')
            if not agent:
                logger.error("❌ writerエージェントが登録されていません")
                return {
                    'success': False,
                    'error': 'writer エージェントが登録されていません'
                }
            result = await agent.process_task(task)
        else:
            # 言語別ライター
            agent = self.agents.get(role)
            if not agent:
                logger.error(f"❌ {role}エージェントが登録されていません")
                return {
                    'success': False,
                    'error': f'未対応の言語ライター: {role}'
                }
            
            # 言語確認
            if task_language and hasattr(agent, 'get_language_code'):
                if agent.get_language_code() != task_language:
                    logger.warning(f"⚠️ 言語不一致: タスク={task_language}, ライター={agent.get_language_code()}")
            
            result = await agent.process_task(task)
        
        # 結果判定
        if result.get('success'):
            logger.info(f"✅ ライターAI ({role}): タスク完了")
            # 言語情報を追加
            if hasattr(agent, 'get_language_code'):
                result['language'] = agent.get_language_code()
                result['polylang_lang'] = polylang_lang or agent.get_language_code()
        else:
            logger.error(f"❌ ライターAI ({role}): 失敗 - {result.get('error', '不明')}")
        
        return result
    
    def display_suggested_tasks(self, suggested_tasks: List[Dict]):
        """提案タスクの詳細を表示"""
        print("\n" + "="*60)
        print("提案タスク詳細")
        print("="*60)
    
        for i, task in enumerate(suggested_tasks, 1):
            priority_mark = {
                'high': '🔴[高]',
                'medium': '🟡[中]', 
                'low': '🟢[低]'
            }.get(task.get('priority', 'medium'), '⚪[中]')
        
            role_label = {
                'design': '📐[設計]',
                'dev': '💻[開発]',
                'ui': '🎨[UI]',
                'review': '✅[レビュー]',
                'wordpress': '🌐[WordPress]',
                'writer': '✏️[ライター]',
                'writer_ja': '🇯🇵[日本語]',
                'writer_en': '🇬🇧[英語]',
                'writer_ru': '🇷🇺[ロシア語]',
                'content': '📄[コンテンツ]'
            }.get(task.get('required_role', 'dev'), '📋[タスク]')
        
            print(f"\n{i}. {priority_mark} {role_label} {task.get('description', 'N/A')}")
            print(f"   理由: {task.get('reasoning', 'N/A')}")
            print(f"   担当: {task.get('required_role', 'dev')}")
            print(f"   優先度: {task.get('priority', 'medium')}")
    
        print("="*60)
    
    async def edit_suggested_tasks(self, suggested_tasks: List[Dict]) -> List[Dict]:
        """提案タスクを編集"""
        try:
            edited_tasks = []
        
            for i, task in enumerate(suggested_tasks, 1):
                print(f"\n--- タスク {i}/{len(suggested_tasks)} の編集 ---")
                print(f"現在の内容:")
                print(f"  説明: {task.get('description', '')}")
                print(f"  担当: {task.get('required_role', 'dev')}")
                print(f"  優先度: {task.get('priority', 'medium')}")
                print(f"  理由: {task.get('reasoning', '')}")
            
                print(f"\n編集オプション:")
                print("  (d)説明を変更 / (r)担当を変更 / (p)優先度を変更 / (e)理由を変更")
                print("  (s)このタスクをスキップ / (k)このタスクを保持 / (q)編集を終了")
            
                edit_choice = input("選択: ").lower()
            
                if edit_choice == 'd':
                    new_desc = input("新しい説明: ").strip()
                    if new_desc:
                        task['description'] = new_desc
                    edited_tasks.append(task)
                
                elif edit_choice == 'r':
                    print("利用可能な担当:")
                    print("  design, dev, ui, review, wordpress, writer, writer_ja, writer_en, writer_ru, plugin")
                    new_role = input("新しい担当: ").strip()
                    valid_roles = ['design', 'dev', 'ui', 'review', 'wordpress', 'writer', 
                                   'writer_ja', 'writer_en', 'writer_ru', 'writer_uz', 
                                   'writer_zh', 'writer_ko', 'writer_tr', 'plugin', 'content']
                    if new_role in valid_roles:
                        task['required_role'] = new_role
                    else:
                        print("無効な担当です。変更しません。")
                    edited_tasks.append(task)
                
                elif edit_choice == 'p':
                    print("優先度: high, medium, low")
                    new_priority = input("新しい優先度: ").strip()
                    if new_priority in ['high', 'medium', 'low']:
                        task['priority'] = new_priority
                    else:
                        print("無効な優先度です。変更しません。")
                    edited_tasks.append(task)
                
                elif edit_choice == 'e':
                    new_reason = input("新しい理由: ").strip()
                    if new_reason:
                        task['reasoning'] = new_reason
                    edited_tasks.append(task)
                
                elif edit_choice == 's':
                    print(f"タスク {i} をスキップしました")
                    continue
                
                elif edit_choice == 'k':
                    edited_tasks.append(task)
                    print(f"タスク {i} をそのまま保持しました")
                
                elif edit_choice == 'q':
                    print("編集を終了します")
                    break
                
                else:
                    print("不正な入力です。タスクをそのまま保持します。")
                    edited_tasks.append(task)
        
            if edited_tasks:
                print(f"\n編集後のタスク ({len(edited_tasks)}件):")
                self.display_suggested_tasks(edited_tasks)
            
            return edited_tasks
        
        except Exception as e:
            ErrorHandler.log_error(e, "タスク編集")
            return suggested_tasks
    
    async def create_manual_tasks(self) -> List[Dict]:
        """手動でタスクを作成"""
        try:
            manual_tasks = []
        
            print("\n" + "="*60)
            print("手動タスク作成")
            print("="*60)
            print("新しいタスクを手動で作成します。")
            print("空の説明で終了します。")
        
            while True:
                print(f"\n--- タスク {len(manual_tasks) + 1} ---")
            
                description = input("タスク説明: ").strip()
                if not description:
                    break
                
                print("利用可能な担当: design, dev, ui, review, wordpress, writer, writer_ja, writer_en, writer_ru, plugin")
                role = input("担当 (デフォルト: dev): ").strip() or "dev"
            
                print("優先度: high, medium, low")
                priority = input("優先度 (デフォルト: medium): ").strip() or "medium"
            
                reasoning = input("理由: ").strip()
            
                task = {
                    'description': description,
                    'required_role': role,
                    'priority': priority,
                    'reasoning': reasoning
                }
            
                manual_tasks.append(task)
                print(f"タスクを追加しました (合計: {len(manual_tasks)}件)")
            
                more = input("さらにタスクを追加しますか? (y/n): ").lower()
                if more != 'y':
                    break
        
            if manual_tasks:
                print(f"\n作成したタスク ({len(manual_tasks)}件):")
                self.display_suggested_tasks(manual_tasks)
            
            return manual_tasks
        
        except Exception as e:
            ErrorHandler.log_error(e, "手動タスク作成")
            return []